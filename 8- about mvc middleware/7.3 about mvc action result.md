## about action result in mvc



### 1. about



### 2. action constraint

#### 2.1 action constrain (metadata)

```c#
public interface IActionConstraintMetadata
{
}

```

##### 2.1.1 派生接口

###### 2.1.1.1 action constraint

```c#
public interface IActionConstraint : IActionConstraintMetadata
{    
    int Order { get; }        
    bool Accept(ActionConstraintContext context);
}

```

###### 2.1.1.2 action constraint factory

```c#
public interface IActionConstraintFactory : IActionConstraintMetadata
{    
    bool IsReusable { get; }        
    IActionConstraint CreateInstance(IServiceProvider services);
}

```

##### 2.1.2 action constraint context

```c#
public class ActionConstraintContext
{        
    public RouteContext RouteContext { get; set; } = default!;
    public ActionSelectorCandidate CurrentCandidate { get; set; } = default!;
    public IReadOnlyList<ActionSelectorCandidate> Candidates { get; set; } = Array.Empty<ActionSelectorCandidate>();  
}

```

###### 2.1.2.1 action selector candidate

```c#
public readonly struct ActionSelectorCandidate
{
    public ActionDescriptor Action { get; }            
    public IReadOnlyList<IActionConstraint> Constraints { get; }
    
    public ActionSelectorCandidate(
        ActionDescriptor action, 
        IReadOnlyList<IActionConstraint> constraints)
    {
        if (action == null)
        {
            throw new ArgumentNullException(nameof(action));
        }
        
        Action = action;
        Constraints = constraints;
    }                
}

```

#### 2.2 variety of action constraint

##### 2.2.1 http method action constraint

```c#
public class HttpMethodActionConstraint : IActionConstraint
{            
    private readonly IReadOnlyList<string> _httpMethods;
    public IEnumerable<string> HttpMethods => _httpMethods;
    
    public static readonly int HttpMethodConstraintOrder = 100;
    public int Order => HttpMethodConstraintOrder;
    
    // 由 http method （string）集合创建 constraint
    public HttpMethodActionConstraint(IEnumerable<string> httpMethods)
    {
        if (httpMethods == null)
        {
            throw new ArgumentNullException(nameof(httpMethods));
        }
        
        // 遍历传入的 http method，注入 methods 集合（预结果）
        var methods = new List<string>();        
        foreach (var method in httpMethods)
        {
            if (string.IsNullOrEmpty(method))
            {
                throw new ArgumentException("httpMethod cannot be null or empty");
            }
            
            methods.Add(method);
        }
        // 将 methods 赋值到 http method 集合
        _httpMethods = new ReadOnlyCollection<string>(methods);
    }
                
    public virtual bool Accept(ActionConstraintContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        // 如果内部 http method 集合为 empty，
        // -> 返回 true，即支持任何 http method
        if (_httpMethods.Count == 0)
        {
            return true;
        }
        
        // 解析 http request method
        var request = context.RouteContext.HttpContext.Request;
        var method = request.Method;
        
        // 遍历内部 http method 集合
        for (var i = 0; i < _httpMethods.Count; i++)
        {
            // 如果包含 http request method，-> true
            var supportedMethod = _httpMethods[i];
            if (string.Equals(
                	supportedMethod, 
                	method, StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }
        }
        // 否则，即不包含 http request method，-> false
        return false;
    }
}

```



##### 2.2.2 action method selector attribute

```c#
[AttributeUsage(
    AttributeTargets.Method, 
    AllowMultiple = false, 
    Inherited = true)]
public abstract class ActionMethodSelectorAttribute : 
	Attribute, 
	IActionConstraint
{   
    public int Order { get; set; }
    
    public bool Accept(ActionConstraintContext context)
    {
        return IsValidForRequest(context.RouteContext, context.CurrentCandidate.Action);
    }
    
    public abstract bool IsValidForRequest(RouteContext routeContext, ActionDescriptor action);
}

```

##### 2.2.3 consumes action attribute

###### 2.2.3.1 consumes action constraint 接口

```c#
internal interface IConsumesActionConstraint : IActionConstraint
{
}

```

###### 2.2.3.2 consumes attribute

```c#
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, AllowMultiple = false, Inherited = true)]
    public class ConsumesAttribute :
        Attribute,
        IResourceFilter,
        IConsumesActionConstraint,
        IApiRequestMetadataProvider
    {
        /// <summary>
        /// The order for consumes attribute.
        /// </summary>
        /// <value>Defaults to 200</value>
        public static readonly int ConsumesActionConstraintOrder = 200;

        /// <summary>
        /// Creates a new instance of <see cref="ConsumesAttribute"/>.
        /// </summary>
        public ConsumesAttribute(string contentType, params string[] otherContentTypes)
        {
            if (contentType == null)
            {
                throw new ArgumentNullException(nameof(contentType));
            }

            // We want to ensure that the given provided content types are valid values, so
            // we validate them using the semantics of MediaTypeHeaderValue.
            MediaTypeHeaderValue.Parse(contentType);

            for (var i = 0; i < otherContentTypes.Length; i++)
            {
                MediaTypeHeaderValue.Parse(otherContentTypes[i]);
            }

            ContentTypes = GetContentTypes(contentType, otherContentTypes);
        }

        // The value used is a non default value so that it avoids getting mixed with other action constraints
        // with default order.
        /// <inheritdoc />
        int IActionConstraint.Order => ConsumesActionConstraintOrder;

        /// <summary>
        /// Gets or sets the supported request content types. Used to select an action when there would otherwise be
        /// multiple matches.
        /// </summary>
        public MediaTypeCollection ContentTypes { get; set; }

        /// <inheritdoc />
        public void OnResourceExecuting(ResourceExecutingContext context)
        {
            if (context == null)
            {
                throw new ArgumentNullException(nameof(context));
            }

            // Only execute if the current filter is the one which is closest to the action.
            // Ignore all other filters. This is to ensure we have a overriding behavior.
            if (IsApplicable(context.ActionDescriptor))
            {
                var requestContentType = context.HttpContext.Request.ContentType;

                // Confirm the request's content type is more specific than a media type this action supports e.g. OK
                // if client sent "text/plain" data and this action supports "text/*".
                //
                // Requests without a content type do not return a 415. It is a common pattern to place [Consumes] on
                // a controller and have GET actions
                if (!string.IsNullOrEmpty(requestContentType) && !IsSubsetOfAnyContentType(requestContentType))
                {
                    context.Result = new UnsupportedMediaTypeResult();
                }
            }
        }

        private bool IsSubsetOfAnyContentType(string requestMediaType)
        {
            var parsedRequestMediaType = new MediaType(requestMediaType);
            for (var i = 0; i < ContentTypes.Count; i++)
            {
                var contentTypeMediaType = new MediaType(ContentTypes[i]);
                if (parsedRequestMediaType.IsSubsetOf(contentTypeMediaType))
                {
                    return true;
                }
            }
            return false;
        }

        /// <inheritdoc />
        public void OnResourceExecuted(ResourceExecutedContext context)
        {
            if (context == null)
            {
                throw new ArgumentNullException(nameof(context));
            }
        }

        /// <inheritdoc />
        public bool Accept(ActionConstraintContext context)
        {
            // If this constraint is not closest to the action, it will be skipped.
            if (!IsApplicable(context.CurrentCandidate.Action))
            {
                // Since the constraint is to be skipped, returning true here
                // will let the current candidate ignore this constraint and will
                // be selected based on other constraints for this action.
                return true;
            }

            var requestContentType = context.RouteContext.HttpContext.Request.ContentType;

            // If the request content type is null we need to act like pass through.
            // In case there is a single candidate with a constraint it should be selected.
            // If there are multiple actions with consumes action constraints this should result in ambiguous exception
            // unless there is another action without a consumes constraint.
            if (string.IsNullOrEmpty(requestContentType))
            {
                var isActionWithoutConsumeConstraintPresent = context.Candidates.Any(
                    candidate => candidate.Constraints == null ||
                    !candidate.Constraints.Any(constraint => constraint is IConsumesActionConstraint));

                return !isActionWithoutConsumeConstraintPresent;
            }

            // Confirm the request's content type is more specific than (a media type this action supports e.g. OK
            // if client sent "text/plain" data and this action supports "text/*".
            if (IsSubsetOfAnyContentType(requestContentType))
            {
                return true;
            }

            var firstCandidate = context.Candidates[0];
            if (firstCandidate.Action != context.CurrentCandidate.Action)
            {
                // If the current candidate is not same as the first candidate,
                // we need not probe other candidates to see if they apply.
                // Only the first candidate is allowed to probe other candidates and based on the result select itself.
                return false;
            }

            // Run the matching logic for all IConsumesActionConstraints we can find, and see what matches.
            // 1). If we have a unique best match, then only that constraint should return true.
            // 2). If we have multiple matches, then all constraints that match will return true
            // , resulting in ambiguity(maybe).
            // 3). If we have no matches, then we choose the first constraint to return true.It will later return a 415
            foreach (var candidate in context.Candidates)
            {
                if (candidate.Action == firstCandidate.Action)
                {
                    continue;
                }

                var tempContext = new ActionConstraintContext()
                {
                    Candidates = context.Candidates,
                    RouteContext = context.RouteContext,
                    CurrentCandidate = candidate
                };

                if (candidate.Constraints == null || candidate.Constraints.Count == 0 ||
                    candidate.Constraints.Any(constraint => constraint is IConsumesActionConstraint &&
                                                            constraint.Accept(tempContext)))
                {
                    // There is someone later in the chain which can handle the request.
                    // end the process here.
                    return false;
                }
            }

            // There is no one later in the chain that can handle this content type return a false positive so that
            // later we can detect and return a 415.
            return true;
        }

        private bool IsApplicable(ActionDescriptor actionDescriptor)
        {
            // If there are multiple IConsumeActionConstraints which are defined at the class and
            // at the action level, the one closest to the action overrides the others. To ensure this
            // we take advantage of the fact that ConsumesAttribute is both an IActionFilter and an
            // IConsumeActionConstraint. Since FilterDescriptor collection is ordered (the last filter is the one
            // closest to the action), we apply this constraint only if there is no IConsumeActionConstraint after this.
            return actionDescriptor.FilterDescriptors.Last(
                filter => filter.Filter is IConsumesActionConstraint).Filter == this;
        }

        private MediaTypeCollection GetContentTypes(string firstArg, string[] args)
        {
            var completeArgs = new List<string>(args.Length + 1);
            completeArgs.Add(firstArg);
            completeArgs.AddRange(args);
            var contentTypes = new MediaTypeCollection();
            foreach (var arg in completeArgs)
            {
                var mediaType = new MediaType(arg);
                if (mediaType.MatchesAllSubTypes ||
                    mediaType.MatchesAllTypes)
                {
                    throw new InvalidOperationException(
                        Resources.FormatMatchAllContentTypeIsNotAllowed(arg));
                }

                contentTypes.Add(arg);
            }

            return contentTypes;
        }

        /// <inheritdoc />
        public void SetContentTypes(MediaTypeCollection contentTypes)
        {
            contentTypes.Clear();
            foreach (var contentType in ContentTypes)
            {
                contentTypes.Add(contentType);
            }
        }
    }
```

#### 2.3 action constraint provider

##### 2.3.1 接口

```c#
public interface IActionConstraintProvider
{                
    int Order { get; }
        
    void OnProvidersExecuting(ActionConstraintProviderContext context);       
    void OnProvidersExecuted(ActionConstraintProviderContext context);
}

```

###### 2.3.1.1 action constraint provider context

```c#
public class ActionConstraintProviderContext
{
    public HttpContext HttpContext { get; }       
    public ActionDescriptor Action { get; }            
    public IList<ActionConstraintItem> Results { get; }
        
    public ActionConstraintProviderContext(
        HttpContext context,
        ActionDescriptor action,
        IList<ActionConstraintItem> items)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (action == null)
        {
            throw new ArgumentNullException(nameof(action));
        }        
        if (items == null)
        {
            throw new ArgumentNullException(nameof(items));
        }
        
        HttpContext = context;
        Action = action;
        Results = items;
    }               
}

```

###### 2.3.1.2 action constraint item

```c#
public class ActionConstraintItem
{
    public IActionConstraint Constraint { get; set; } = default!
    public IActionConstraintMetadata Metadata { get; }        
    public bool IsReusable { get; set; }
        
    public ActionConstraintItem(IActionConstraintMetadata metadata)
    {
        if (metadata == null)
        {
            throw new ArgumentNullException(nameof(metadata));
        }
        
        // 注入 action constraint metadata
        Metadata = metadata;
    }                
}

```

##### 2.3.2 default action constraint provider

```c#
internal class DefaultActionConstraintProvider : IActionConstraintProvider
{    
    public int Order => -1000;
       
    public void OnProvidersExecuting(ActionConstraintProviderContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        // 遍历 provider context 的 result（action constraint item 集合），
        for (var i = 0; i < context.Results.Count; i++)
        {
            ProvideConstraint(context.Results[i], context.HttpContext.RequestServices);
        }
    }
    
    private void ProvideConstraint(
        ActionConstraintItem item, 
        IServiceProvider services)
    {
        // Don't overwrite anything that was done by a previous provider.
        if (item.Constraint != null)
        {
            return;
        }
        
        // 如果 action constraint item 的 metadata 是 action constraint，
        if (item.Metadata is IActionConstraint constraint)
        {
            item.Constraint = constraint;
            item.IsReusable = true;
            return;
        }
        // 如果 action constraint item 的 metadata 是 action constraint factory
        if (item.Metadata is IActionConstraintFactory factory)
        {
            item.Constraint = factory.CreateInstance(services);
            item.IsReusable = factory.IsReusable;
            return;
        }
    }
    
    /// <inheritdoc />
    public void OnProvidersExecuted(ActionConstraintProviderContext context)
    {
    }        
}

```



### 3. action filter

#### 3.1 filter 抽象

##### 3.1.1 filter metadata

```c#
public interface IFilterMetadata
{
}

```

###### 3.1.1.1 filter factory

```c#
public interface IFilterFactory : IFilterMetadata
{    
    bool IsReusable { get; }        
    IFilterMetadata CreateInstance(IServiceProvider serviceProvider);
}

```

###### 3.1.1.2 ordered filter 

```c#
public interface IOrderedFilter : IFilterMetadata
{    
    int Order { get; }
}

```

##### 3.1.2 filter context

```c#
public abstract class FilterContext : ActionContext
{  
    public virtual IList<IFilterMetadata> Filters { get; }
    
    public FilterContext(
        ActionContext actionContext,
        IList<IFilterMetadata> filters) : base(actionContext)
    {
        if (filters == null)
        {
            throw new ArgumentNullException(nameof(filters));
        }
        
        Filters = filters;
    }

    // The <see cref="IsEffectivePolicy{TMetadata}(TMetadata)"/> method is used to implement a common convention
    // for filters that define an overriding behavior. When multiple filters may apply to the same cross-cutting concern, 
    // define a common interface for the filters (<typeparamref name="TMetadata"/>) and implement the filters such that 
    // all of the implementations call this method to determine if they should take action.    
    // For instance, a global filter might be overridden by placing a filter attribute on an action method.
    // The policy applied directly to the action method could be considered more specific.    
    // This mechanism for overriding relies on the rules of order and scope that the filter system provides to control ordering 
    // of filters. 
    // It is up to the implementor of filters to implement this protocol cooperatively. 
    // The filter system has no innate notion of overrides, this is a recommended convention.        
    public bool IsEffectivePolicy<TMetadata>(TMetadata policy) where TMetadata : IFilterMetadata
    {
        if (policy == null)
        {
            throw new ArgumentNullException(nameof(policy));
        }
        
        var effective = FindEffectivePolicy<TMetadata>();
        return ReferenceEquals(policy, effective);
    }
        
    [return: MaybeNull]
    public TMetadata FindEffectivePolicy<TMetadata>() where TMetadata : IFilterMetadata
    {
        // The most specific policy is the one closest to the action (nearest the end of the list).
        for (var i = Filters.Count - 1; i >= 0; i--)
        {
            var filter = Filters[i];
            if (filter is TMetadata match)
            {
                return match;
            }
        }
        
        return default;
    }
}

```

#### 3.2 variety of filter 接口

##### 3.2.1 authorization filter

```c#
// authorization filter
public interface IAuthorizationFilter : IFilterMetadata
{    
    void OnAuthorization(AuthorizationFilterContext context);
}
// async authorization filter
public interface IAsyncAuthorizationFilter : IFilterMetadata
{
    Task OnAuthorizationAsync(AuthorizationFilterContext context);    
}

```

###### 3.2.1.1 authorization filter context

```c#
public class AuthorizationFilterContext : FilterContext
{    
    public virtual IActionResult? Result { get; set; }
    
    public AuthorizationFilterContext(ActionContext actionContext, IList<IFilterMetadata> filters) : 
    	base(actionContext, filters)
    {
    }           
}

```

##### 3.2.2 allow anonymous filter

```c#
public interface IAllowAnonymousFilter : IFilterMetadata
{
}
```

##### 3.2.3 resource filter

```c#
// resource filter
public interface IResourceFilter : IFilterMetadata
{    
    void OnResourceExecuting(ResourceExecutingContext context);       
    void OnResourceExecuted(ResourceExecutedContext context);
}
// async resource filter
public interface IAsyncResourceFilter : IFilterMetadata
{
    
    Task OnResourceExecutionAsync(
        ResourceExecutingContext context,
        ResourceExecutionDelegate next);
}

```

###### 3.2.3.1 resource executing context

```c#
public class ResourceExecutingContext : FilterContext
{
    public IList<IValueProviderFactory> ValueProviderFactories { get; }
    public virtual IActionResult? Result { get; set; }          
        
    public ResourceExecutingContext(
        ActionContext actionContext,
        IList<IFilterMetadata> filters,
        IList<IValueProviderFactory> valueProviderFactories) : base(actionContext, filters)
    {
        if (valueProviderFactories == null)
        {
            throw new ArgumentNullException(nameof(valueProviderFactories));
        }
        
        // 注入 value provider factory 集合
        ValueProviderFactories = valueProviderFactories;
    }            
}

```

###### 3.2.3.2 resource executed context

```c#
public class ResourceExecutedContext : FilterContext
{
    private Exception? _exception;
    private ExceptionDispatchInfo? _exceptionDispatchInfo;
    
    public virtual Exception? Exception
    {
        get
        {
            if (_exception == null && 
                _exceptionDispatchInfo != null)
            {
                return _exceptionDispatchInfo.SourceException;
            }
            else
            {
                return _exception;
            }
        }
        
        set
        {
            _exceptionDispatchInfo = null;
            _exception = value;
        }
    }
    
    public virtual ExceptionDispatchInfo? ExceptionDispatchInfo
    {
        get
        {
            return _exceptionDispatchInfo;
        }
        
        set
        {
            _exception = null;
            _exceptionDispatchInfo = value;
        }
    }
    
    public virtual bool Canceled { get; set; }                                                
    public virtual bool ExceptionHandled { get; set; }        
    public virtual IActionResult? Result { get; set; }
            
    public ResourceExecutedContext(
        ActionContext actionContext, 
        IList<IFilterMetadata> filters) : base(actionContext, filters)
    {
    }           
}

```

###### 3.2.3.3 resource execution delegate

```c#
public delegate Task<ResourceExecutedContext> ResourceExecutionDelegate();
```

##### 3.2.4 action fitler

```c#
// filter 接口
public interface IActionFilter : IFilterMetadata
{    
    void OnActionExecuting(ActionExecutingContext context);        
    void OnActionExecuted(ActionExecutedContext context);
}
// async filter 接口
public interface IAsyncActionFilter : IFilterMetadata
{    
    Task OnActionExecutionAsync(
        ActionExecutingContext context, 
        ActionExecutionDelegate next);
}

```

###### 3.2.4.1 action executing context

```c#
public class ActionExecutingContext : FilterContext
{
    public virtual IDictionary<string, object?> ActionArguments { get; }        
    public virtual object Controller { get; }    
    public virtual IActionResult? Result { get; set; }
    
    public ActionExecutingContext(
        ActionContext actionContext,
        IList<IFilterMetadata> filters,
        IDictionary<string, object?> actionArguments,
        object controller) : base(actionContext, filters)
    {
        if (actionArguments == null)
        {
            throw new ArgumentNullException(nameof(actionArguments));
        }
        
        ActionArguments = actionArguments;
        Controller = controller;
    }            
}

```

###### 3.2.4.2 action executed context

```c#
public class ActionExecutedContext : FilterContext
{
    private Exception? _exception;
    private ExceptionDispatchInfo? _exceptionDispatchInfo;
    
    public virtual Exception? Exception
    {
        get
        {
            if (_exception == null && _exceptionDispatchInfo != null)
            {
                return _exceptionDispatchInfo.SourceException;
            }
            else
            {
                return _exception;
            }
        }
        
        set
        {
            _exceptionDispatchInfo = null;
            _exception = value;
        }
    }
        
    public virtual ExceptionDispatchInfo? ExceptionDispatchInfo
    {
        get
        {
            return _exceptionDispatchInfo;
        }
        
        set
        {
            _exception = null;
            _exceptionDispatchInfo = value;
        }
    }
    
    public virtual bool Canceled { get; set; }        
    public virtual object Controller { get; }        
    public virtual bool ExceptionHandled { get; set; }    
    public virtual IActionResult? Result { get; set; }
        
    public ActionExecutedContext(
        ActionContext actionContext,
        IList<IFilterMetadata> filters,
        object controller) : base(actionContext, filters)
    {
        Controller = controller;
    }                    
}

```

###### 3.2.4.3 action execution delegate

```c#
public delegate Task<ActionExecutedContext> ActionExecutionDelegate();
```

##### 3.2.5 exception filter

```c#
// exception filter 接口
public interface IExceptionFilter : IFilterMetadata
{    
    void OnException(ExceptionContext context);
}
// async exception filter 接口
public interface IAsyncExceptionFilter : IFilterMetadata
{    
    Task OnExceptionAsync(ExceptionContext context);
}

```

###### 3.2.5.1 exception context

```c#
public class ExceptionContext : FilterContext
{
    private Exception? _exception;
    private ExceptionDispatchInfo? _exceptionDispatchInfo;
    
    public virtual Exception Exception
    {
        get
        {
            if (_exception == null && _exceptionDispatchInfo != null)
            {
                return _exceptionDispatchInfo.SourceException;
            }
            else
            {
                return _exception!;
            }
        }
        
        set
        {
            _exceptionDispatchInfo = null;
            _exception = value;
        }
    }
    
    public virtual ExceptionDispatchInfo? ExceptionDispatchInfo
    {
        get
        {
            return _exceptionDispatchInfo;
        }
        
        set
        {
            _exception = null;
            _exceptionDispatchInfo = value;
        }
    }
    
    public virtual bool ExceptionHandled { get; set; }    
    public virtual IActionResult? Result { get; set; }
        
    public ExceptionContext(
        ActionContext actionContext, 
        IList<IFilterMetadata> filters) : base(actionContext, filters)
    {
    }       
}

```

##### 3.2.6 result filter

```c#
// result filter 接口
public interface IResultFilter : IFilterMetadata
{    
    void OnResultExecuting(ResultExecutingContext context);        
    void OnResultExecuted(ResultExecutedContext context);
}
// async result filter 接口
public interface IAsyncResultFilter : IFilterMetadata
{    
    Task OnResultExecutionAsync(
        ResultExecutingContext context, 
        ResultExecutionDelegate next);
}

```

###### 3.2.6.1 result executing context

```c#
public class ResultExecutingContext : FilterContext
{
    public virtual bool Cancel { get; set; }
    public virtual object Controller { get; }
    
    public virtual IActionResult Result { get; set; }
    
    public ResultExecutingContext(
        ActionContext actionContext,
        IList<IFilterMetadata> filters,
        IActionResult result,
        object controller) : base(actionContext, filters)
    {
        Result = result;
        Controller = controller;
    }           
}

```

###### 3.2.6.2 result executed context

```c#
public class ResultExecutedContext : FilterContext
{
    private Exception? _exception;
    private ExceptionDispatchInfo? _exceptionDispatchInfo;    
    
    public virtual Exception? Exception
    {
        get
        {
            if (_exception == null && _exceptionDispatchInfo != null)
            {
                return _exceptionDispatchInfo.SourceException;
            }
            else
            {
                return _exception;
            }
        }
        
        set
        {
            _exceptionDispatchInfo = null;
            _exception = value;
        }
    }
        
    public virtual ExceptionDispatchInfo? ExceptionDispatchInfo
    {
        get
        {
            return _exceptionDispatchInfo;
        }
        
        set
        {
            _exception = null;
            _exceptionDispatchInfo = value;
        }
    }
        
    public virtual bool Canceled { get; set; }        
    public virtual object Controller { get; }        
    public virtual bool ExceptionHandled { get; set; }
        
    public virtual IActionResult Result { get; }
    
    public ResultExecutedContext(
        ActionContext actionContext,
        IList<IFilterMetadata> filters,
        IActionResult result,
        object controller) : base(actionContext, filters)
    {
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        Result = result;
        Controller = controller;
    }                
}

```

###### 3.2.6.3 result execution delegate

```c#
public delegate Task<ResultExecutedContext> ResultExecutionDelegate();
```

##### 3.2.7 always run result filter

```c#
// always run result filter 接口
public interface IAlwaysRunResultFilter : IResultFilter
{
}
// async always run result filter 接口
public interface IAsyncAlwaysRunResultFilter : IAsyncResultFilter
{
}

```

##### 3.2.8 request form limit policy

```c#
public interface IRequestFormLimitsPolicy : IFilterMetadata
{
}

```

##### 3.2.9 request size policy

```c#
public interface IRequestSizePolicy : IFilterMetadata
{
}

```

###### 3.2.10 response cache filter

```c#
internal interface IResponseCacheFilter : IFilterMetadata
{
}

```

#### 3.3 variety of filter 实现

##### 3.3.1 authorize filter

```c#
public class AuthorizeFilter : IAsyncAuthorizationFilter, IFilterFactory
{
    public AuthorizationPolicy Policy { get; }
    public IAuthorizationPolicyProvider PolicyProvider { get; }
    public IEnumerable<IAuthorizeData> AuthorizeData { get; }        
        
    bool IFilterFactory.IsReusable => true;
       
    /* 由 authorization data 创建 */    
    public AuthorizeFilter() : this(authorizeData: new[] { new AuthorizeAttribute() })
    {
    }
    
    public AuthorizeFilter(string policy) : this(new[] { new AuthorizeAttribute(policy) })
    {
    }
    
    public AuthorizeFilter(IEnumerable<IAuthorizeData> authorizeData)
    {
        if (authorizeData == null)
        {
            throw new ArgumentNullException(nameof(authorizeData));
        }
        // 注入 authorization data
        AuthorizeData = authorizeData;
    }
    
    /* 由 authorization policy 创建 */
    public AuthorizeFilter(AuthorizationPolicy policy)
    {
        if (policy == null)
        {
            throw new ArgumentNullException(nameof(policy));
        }
        // 注入 authorization policy
        Policy = policy;
    }    
              
    /* 由 authorization policy provider 创建 */
    public AuthorizeFilter(
        IAuthorizationPolicyProvider policyProvider, 
        IEnumerable<IAuthorizeData> authorizeData) : this(authorizeData)
    {
        if (policyProvider == null)
        {
            throw new ArgumentNullException(nameof(policyProvider));
        }
        // 注入 authorization policy provider
        PolicyProvider = policyProvider;
    }
                             
    // 现 on authorization 方法
    public virtual async Task OnAuthorizationAsync(AuthorizationFilterContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        /* 如果 context 验证 authorization policy 无效，直接返回 */
        if (!context.IsEffectivePolicy(this))
        {
            return;
        }
        
        /* 从 context 中解析（effective）authorization policy，如果解析为 null，直接返回 */
        // IMPORTANT: Changes to authorization logic should be mirrored in 
        // security's AuthorizationMiddleware
        var effectivePolicy = await GetEffectivePolicyAsync(context);
        if (effectivePolicy == null)
        {
            return;
        }
        
        /* 解析 authorization policy evaluator */
        var policyEvaluator = context.HttpContext
				              	   .RequestServices
            	 				   .GetRequiredService<IPolicyEvaluator>();
        
        /* 使用 authorization policy evaluator 验证 */
        var authenticateResult = await policyEvaluator.AuthenticateAsync(
            effectivePolicy, 
            context.HttpContext);
        
        /* 如果标记了 allow anonymous，直接返回 */
        // Allow Anonymous skips all authorization
        if (HasAllowAnonymous(context))
        {
            return;
        }
        
        /* 生成 authorize result（action result） */
        var authorizeResult = await policyEvaluator.AuthorizeAsync(
            effectivePolicy, 
            authenticateResult, 
            context.HttpContext, 
            context);        
        
        if (authorizeResult.Challenged)
        {
            context.Result = new ChallengeResult(
                effectivePolicy.AuthenticationSchemes.ToArray());
        }
        else if (authorizeResult.Forbidden)
        {
            context.Result = new ForbidResult(
                effectivePolicy.AuthenticationSchemes.ToArray());
        }
    }
    
    internal async Task<AuthorizationPolicy> GetEffectivePolicyAsync(AuthorizationFilterContext context)
    {
        // Combine all authorize filters into single effective policy that's only run on the closest filter
        var builder = new AuthorizationPolicyBuilder(await ComputePolicyAsync());
        for (var i = 0; i < context.Filters.Count; i++)
        {
            if (ReferenceEquals(this, context.Filters[i]))
            {
                continue;
            }
            
            if (context.Filters[i] is AuthorizeFilter authorizeFilter)
            {
                // Combine using the explicit policy, or the dynamic policy provider
                builder.Combine(await authorizeFilter.ComputePolicyAsync());
            }
        }
        
        var endpoint = context.HttpContext.GetEndpoint();
        if (endpoint != null)
        {
            // When doing endpoint routing, MVC does not create filters for any authorization specific metadata i.e [Authorize] 
            // does not get translated into AuthorizeFilter. 
            // Consequently, there are some rough edges when an application uses a mix of AuthorizeFilter explicilty configured 
            // by the user (e.g. global auth filter), and uses endpoint metadata.
            // To keep the behavior of AuthFilter identical to pre-endpoint routing, we will gather auth data from endpoint metadata 
            // and produce a policy using this.
            // This would mean we would have effectively run some auth twice, but it maintains compat.
            var policyProvider = PolicyProvider ?? context.HttpContext
						                			  .RequestServices
                									  .GetRequiredService<IAuthorizationPolicyProvider>();
            
            var endpointAuthorizeData = endpoint.Metadata
					                		 .GetOrderedMetadata<IAuthorizeData>() 
					                	?? Array.Empty<IAuthorizeData>();
            
            var endpointPolicy = await AuthorizationPolicy.CombineAsync(
                policyProvider, 
                endpointAuthorizeData);
            
            if (endpointPolicy != null)
            {
                builder.Combine(endpointPolicy);
            }
        }
        
        return builder.Build();
    }
        
    // Computes the actual policy for this filter using either Policy or PolicyProvider + AuthorizeData
    private Task<AuthorizationPolicy> ComputePolicyAsync()
    {
        if (Policy != null)
        {
            return Task.FromResult(Policy);
        }
        
        if (PolicyProvider == null)
        {
            throw new InvalidOperationException(
                Resources.FormatAuthorizeFilter_AuthorizationPolicyCannotBeCreated(
                    nameof(AuthorizationPolicy),
                    nameof(IAuthorizationPolicyProvider)));
        }
        
        return AuthorizationPolicy.CombineAsync(
            PolicyProvider, 
            AuthorizeData);
    }
    
    private static bool HasAllowAnonymous(AuthorizationFilterContext context)
    {
        var filters = context.Filters;
        for (var i = 0; i < filters.Count; i++)
        {
            if (filters[i] is IAllowAnonymousFilter)
            {
                return true;
            }
        }
        
        // When doing endpoint routing, MVC does not add AllowAnonymousFilters for AllowAnonymousAttributes that were 
        // discovered on controllers and actions. 
        // To maintain compat with 2.x, we'll check for the presence of IAllowAnonymous in endpoint metadata.
        var endpoint = context.HttpContext.GetEndpoint();
        if (endpoint?.Metadata?.GetMetadata<IAllowAnonymous>() != null)
        {
            return true;
        }
        
        return false;
    }
            
    IFilterMetadata IFilterFactory.CreateInstance(IServiceProvider serviceProvider)
    {
        if (Policy != null || 
            PolicyProvider != null)
        {
            // The filter is fully constructed. Use the current instance to authorize.
            return this;
        }
        
        Debug.Assert(AuthorizeData != null);
        var policyProvider = serviceProvider.GetRequiredService<IAuthorizationPolicyProvider>();
        
        return AuthorizationApplicationModelProvider.GetFilter(policyProvider, AuthorizeData);
    }        
}

```

##### 3.3.2 allow anonymous filter

```c#
public class AllowAnonymousFilter : IAllowAnonymousFilter
{
}

```

##### 3.3.3 request form limits filter

```c#
internal class RequestFormLimitsFilter : 
	IAuthorizationFilter, 
	IRequestFormLimitsPolicy
{
    private readonly ILogger _logger;
    public FormOptions FormOptions { get; set; } = default!;
    
    public RequestFormLimitsFilter(ILoggerFactory loggerFactory)
    {
        _logger = loggerFactory.CreateLogger<RequestFormLimitsFilter>();
    }
            
    public void OnAuthorization(AuthorizationFilterContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        var effectivePolicy = context.FindEffectivePolicy<IRequestFormLimitsPolicy>();
        if (effectivePolicy != null && effectivePolicy != this)
        {
            _logger.NotMostEffectiveFilter(
                GetType(), 
                effectivePolicy.GetType(), 
                typeof(IRequestFormLimitsPolicy));
            
            return;
        }
        
        var features = context.HttpContext.Features;
        var formFeature = features.Get<IFormFeature>();
        
        if (formFeature == null || formFeature.Form == null)
        {
            // Request form has not been read yet, so set the limits
            features.Set<IFormFeature>(new FormFeature(context.HttpContext.Request, FormOptions));
            _logger.AppliedRequestFormLimits();
        }
        else
        {
            _logger.CannotApplyRequestFormLimits();
        }
    }
}

```

##### 3.3.4 request size limit filter

```c#
internal class RequestSizeLimitFilter : 
	IAuthorizationFilter, 
	IRequestSizePolicy
{
    private readonly ILogger _logger;
    public long Bytes { get; set; }
   
    public RequestSizeLimitFilter(ILoggerFactory loggerFactory)
    {
        _logger = loggerFactory.CreateLogger<RequestSizeLimitFilter>();
    }
                
    public void OnAuthorization(AuthorizationFilterContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        var effectivePolicy = context.FindEffectivePolicy<IRequestSizePolicy>();
        if (effectivePolicy != null && effectivePolicy != this)
        {
            _logger.NotMostEffectiveFilter(
                GetType(), 
                effectivePolicy.GetType(), 
                typeof(IRequestSizePolicy));
            
            return;
        }
        
        var maxRequestBodySizeFeature = context.HttpContext
            								.Features
            								.Get<IHttpMaxRequestBodySizeFeature>();
        
        if (maxRequestBodySizeFeature == null)
        {
            _logger.FeatureNotFound();
        }
        else if (maxRequestBodySizeFeature.IsReadOnly)
        {
            _logger.FeatureIsReadOnly();
        }
        else
        {
            maxRequestBodySizeFeature.MaxRequestBodySize = Bytes;
            _logger.MaxRequestBodySizeSet(Bytes.ToString(CultureInfo.InvariantCulture));
        }
    }
}

```

##### 3.3.5 disable request size limit filter

```c#
internal class DisableRequestSizeLimitFilter : 
	IAuthorizationFilter, 
	IRequestSizePolicy
{
    private readonly ILogger _logger;
        
    public DisableRequestSizeLimitFilter(ILoggerFactory loggerFactory)
    {
        _logger = loggerFactory.CreateLogger<DisableRequestSizeLimitFilter>();
    }    
    
    // If "IHttpMaxRequestBodySizeFeature" is not enabled or is read-only, the 
    // "DisableRequestSizeLimitAttribute" is not applied.
    public void OnAuthorization(AuthorizationFilterContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        var effectivePolicy = context.FindEffectivePolicy<IRequestSizePolicy>();
        if (effectivePolicy != null && effectivePolicy != this)
        {
            _logger.NotMostEffectiveFilter(
                GetType(), 
                effectivePolicy.GetType(), 
                typeof(IRequestSizePolicy));
            
            return;
        }
        
        var maxRequestBodySizeFeature = context.HttpContext
            								.Features
								            .Get<IHttpMaxRequestBodySizeFeature>();
        
        if (maxRequestBodySizeFeature == null)
        {
            _logger.FeatureNotFound();
        }
        else if (maxRequestBodySizeFeature.IsReadOnly)
        {
            _logger.FeatureIsReadOnly();
        }
        else
        {
            maxRequestBodySizeFeature.MaxRequestBodySize = null;
            _logger.RequestBodySizeLimitDisabled();
        }
    }
}

```

##### 3.3.6 middleware filter

```c#
internal class MiddlewareFilter : IAsyncResourceFilter
{
    private readonly RequestDelegate _middlewarePipeline;
    
    public MiddlewareFilter(RequestDelegate middlewarePipeline)
    {
        if (middlewarePipeline == null)
        {
            throw new ArgumentNullException(nameof(middlewarePipeline));
        }
        // 注入 middleware 管道（添加了关于 filter 的处理方法）
        _middlewarePipeline = middlewarePipeline;
    }
    
    /* 实现 execution 方法 */
    public Task OnResourceExecutionAsync(
        ResourceExecutingContext context, 
        ResourceExecutionDelegate next)
    {
        var httpContext = context.HttpContext;
        
        /* 记录 middleware 执行点，封装为 middleware filter feature */
        // Capture the current context into the feature. 
        // This will later be used in the end middleware to continue the execution flow to later MVC layers.
        // Example:
        // this filter -> user-middleware1 -> user-middleware2 -> the-end-middleware -> resource filters or model binding
        var feature = new MiddlewareFilterFeature()
        {
            ResourceExecutionDelegate = next,
            ResourceExecutingContext = context
        };
        
        // 注入 http context features
        httpContext.Features.Set<IMiddlewareFilterFeature>(feature);        
        // 执行 包含 filter 处理方法的 middleware 管道
        return _middlewarePipeline(httpContext);
    }
}

```

###### 3.3.6.1 middleware filter feature

```c#
internal interface IMiddlewareFilterFeature
{
    ResourceExecutingContext ResourceExecutingContext { get; }    
    ResourceExecutionDelegate ResourceExecutionDelegate { get; }
}

internal class MiddlewareFilterFeature : IMiddlewareFilterFeature
{
    public ResourceExecutingContext ResourceExecutingContext { get; set; }    
    public ResourceExecutionDelegate ResourceExecutionDelegate { get; set; }
}

```

###### 3.3.6.2 middleware filter builder

```c#
internal class MiddlewareFilterBuilder
{
    // 'GetOrAdd' call on the dictionary is not thread safe and we might end up creating the pipeline more than
    // once. To prevent this Lazy<> is used. In the worst case multiple Lazy<> objects are created for multiple
    // threads but only one of the objects succeeds in creating a pipeline.
    private readonly ConcurrentDictionary<Type, Lazy<RequestDelegate>> _pipelinesCache = 
        new ConcurrentDictionary<Type, Lazy<RequestDelegate>>();
    private readonly MiddlewareFilterConfigurationProvider _configurationProvider;
    
    public IApplicationBuilder? ApplicationBuilder { get; set; }
    
    public MiddlewareFilterBuilder(MiddlewareFilterConfigurationProvider configurationProvider)
    {
        _configurationProvider = configurationProvider;
    }
    
    public RequestDelegate GetPipeline(Type configurationType)
    {
        // Build the pipeline only once. This is similar to how middleware registered in Startup are constructed.  
        var requestDelegate = _pipelinesCache.GetOrAdd(
            configurationType,
            key => new Lazy<RequestDelegate>(() => BuildPipeline(key)));
        
        return requestDelegate.Value;
    }
    
    private RequestDelegate BuildPipeline(Type middlewarePipelineProviderType)
    {
        if (ApplicationBuilder == null)
        {
            throw new InvalidOperationException(
                Resources.FormatMiddlewareFilterBuilder_NullApplicationBuilder(nameof(ApplicationBuilder)));
        }
        
        var nestedAppBuilder = ApplicationBuilder.New();
        
        // Get the 'Configure' method from the user provided type.
        var configureDelegate = _configurationProvider.CreateConfigureDelegate(middlewarePipelineProviderType);
        configureDelegate(nestedAppBuilder);
        
        // The middleware resource filter, after receiving the request executes the user configured middleware
        // pipeline. Since we want execution of the request to continue to later MVC layers (resource filters
        // or model binding), add a middleware at the end of the user provided pipeline which make sure to continue
        // this flow.
        // Example:
        // middleware filter -> user-middleware1 -> user-middleware2 -> end-middleware -> resource filters or 
        // model binding
        nestedAppBuilder.Run(async (httpContext) =>
                             {
                                 var feature = httpContext.Features.Get<IMiddlewareFilterFeature>();
                                 if (feature == null)
                                 {
                                     throw new InvalidOperationException(
                                         Resources.FormatMiddlewareFilterBuilder_NoMiddlewareFeature(
                                             nameof(IMiddlewareFilterFeature)));
                                 }
                                 
                                 var resourceExecutionDelegate = feature.ResourceExecutionDelegate!;
                                 var resourceExecutedContext = await resourceExecutionDelegate();
                                 if (resourceExecutedContext.ExceptionHandled)
                                 {
                                     return;
                                 }
                                 
                                 // Ideally we want the experience of a middleware pipeline to behave the same 
                                 // as if it was registered in Startup. In this scenario, an Exception thrown 
                                 // n a middleware later in the pipeline gets propagated back to earlier 
                                 // middleware. So, check if a later resource filter threw an Exception and
                                 // propagate that back to the middleware pipeline.
                                 resourceExecutedContext.ExceptionDispatchInfo?.Throw();
                                 if (resourceExecutedContext.Exception != null)
                                 {
                                     // This line is rarely reachable because ResourceInvoker captures thrown 
                                     // Exceptions using ExceptionDispatchInfo. 
                                     // That said, filters could set only resourceExecutedContext.Exception.
                                     throw resourceExecutedContext.Exception;
                                 }
                             });
        
        return nestedAppBuilder.Build();
    }
}

```

###### 3.3.6.3 middleware filter configuration provider

```c#
internal class MiddlewareFilterConfigurationProvider
{
    public Action<IApplicationBuilder> CreateConfigureDelegate(Type configurationType)
    {
        if (configurationType == null)
        {
            throw new ArgumentNullException(nameof(configurationType));
        }
        
        if (!HasParameterlessConstructor(configurationType))
        {
            throw new InvalidOperationException(
                Resources.FormatMiddlewareFilterConfigurationProvider
                		  _CreateConfigureDelegate_CannotCreateType(
                              configurationType, 
                              nameof(configurationType)));
        }
        
        var instance = Activator.CreateInstance(configurationType);
        var configureDelegateBuilder = GetConfigureDelegateBuilder(configurationType);
        return configureDelegateBuilder.Build(instance);
    }
    
    private static ConfigureBuilder GetConfigureDelegateBuilder(Type startupType)
    {
        var configureMethod = FindMethod(startupType, typeof(void));
        return new ConfigureBuilder(configureMethod);
    }
    
    private static MethodInfo FindMethod(Type startupType, Type returnType = null)
    {
        var methodName = "Configure";
        
        var methods = startupType.GetMethods(BindingFlags.Public | 
                                             BindingFlags.Instance | 
                                             BindingFlags.Static);
        
        var selectedMethods = methods.Where(method => method.Name.Equals(methodName))
            					   .ToList();
        if (selectedMethods.Count > 1)
        {
            throw new InvalidOperationException(
                Resources.FormatMiddewareFilter_ConfigureMethodOverload(methodName));
        }
        
        var methodInfo = selectedMethods.FirstOrDefault();
        if (methodInfo == null)
        {
            throw new InvalidOperationException(
                Resources.FormatMiddewareFilter_NoConfigureMethod(
                    methodName,
                    startupType.FullName));
        }
        
        if (returnType != null && 
            methodInfo.ReturnType != returnType)
        {
            throw new InvalidOperationException(
                Resources.FormatMiddlewareFilter_InvalidConfigureReturnType(
                    methodInfo.Name,
                    startupType.FullName,
                    returnType.Name));
        }
        return methodInfo;
    }
    
    private static bool HasParameterlessConstructor(Type modelType)
    {
        return !modelType.IsAbstract && 
               modelType.GetConstructor(Type.EmptyTypes) != null;
    }
    
    private class ConfigureBuilder
    {
        public MethodInfo MethodInfo { get; }
        
        public ConfigureBuilder(MethodInfo configure)
        {
            MethodInfo = configure;
        }
        
        public Action<IApplicationBuilder> Build(object instance)
        {
            return (applicationBuilder) => Invoke(instance, applicationBuilder);
        }
        
        private void Invoke(object instance, IApplicationBuilder builder)
        {
            var serviceProvider = builder.ApplicationServices;
            var parameterInfos = MethodInfo.GetParameters();
            var parameters = new object[parameterInfos.Length];
            for (var index = 0; index < parameterInfos.Length; index++)
            {
                var parameterInfo = parameterInfos[index];
                if (parameterInfo.ParameterType == typeof(IApplicationBuilder))
                {
                    parameters[index] = builder;
                }
                else
                {
                    try
                    {
                        parameters[index] = serviceProvider.GetRequiredService(parameterInfo.ParameterType);
                    }
                    catch (Exception ex)
                    {
                        throw new InvalidOperationException(
                            Resources.FormatMiddlewareFilter_ServiceResolutionFail(
                                parameterInfo.ParameterType.FullName,
                                parameterInfo.Name,
                                MethodInfo.Name,
                                MethodInfo.DeclaringType.FullName),
                            ex);
                    }
                }
            }
            MethodInfo.Invoke(instance, parameters);
        }
    }
}

```

###### 3.3.6.4 middleware filter builder startup filter

```c#
internal class MiddlewareFilterBuilderStartupFilter : IStartupFilter
{
    public Action<IApplicationBuilder> Configure(Action<IApplicationBuilder> next)
    {
        return MiddlewareFilterBuilder;
        
        void MiddlewareFilterBuilder(IApplicationBuilder builder)
        {
            var middlewarePipelineBuilder = builder.ApplicationServices
                								.GetRequiredService<MiddlewareFilterBuilder>();
            
            middlewarePipelineBuilder.ApplicationBuilder = builder.New();          
            
            next(builder);
        }
    }
}

```

##### 3.3.7 controller action filter

```c#
internal class ControllerActionFilter : IAsyncActionFilter, IOrderedFilter
{   
    public int Order { get; set; } = int.MinValue;
       
    public Task OnActionExecutionAsync(
        ActionExecutingContext context,
        ActionExecutionDelegate next)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (next == null)
        {
            throw new ArgumentNullException(nameof(next));
        }
        
        var controller = context.Controller;
        if (controller == null)
        {
            throw new InvalidOperationException(
                Resources.FormatPropertyOfTypeCannotBeNull(
                    nameof(context.Controller),
                    nameof(ActionExecutingContext)));
        }
        
        if (controller is IAsyncActionFilter asyncActionFilter)
        {
            return asyncActionFilter.OnActionExecutionAsync(context, next);
        }
        else if (controller is IActionFilter actionFilter)
        {
            return ExecuteActionFilter(context, next, actionFilter);
        }
        else
        {
            return next();
        }
    }
    
    private static async Task ExecuteActionFilter(
        ActionExecutingContext context,
        ActionExecutionDelegate next,
        IActionFilter actionFilter)
    {
        actionFilter.OnActionExecuting(context);
        if (context.Result == null)
        {
            actionFilter.OnActionExecuted(await next());
        }
    }
}

```

##### 3.3.8 response cache filter

```c#
internal class ResponseCacheFilter : IActionFilter, IResponseCacheFilter
{
    private readonly ResponseCacheFilterExecutor _executor;
    private readonly ILogger _logger;
    
    public int Duration
    {
        get => _executor.Duration;
        set => _executor.Duration = value;
    }
       
    public ResponseCacheLocation Location
    {
        get => _executor.Location;
        set => _executor.Location = value;
    }
       
    public bool NoStore
    {
        get => _executor.NoStore;
        set => _executor.NoStore = value;
    }
            
    public string? VaryByHeader
    {
        get => _executor.VaryByHeader;
        set => _executor.VaryByHeader = value;
    }
    
    // <see cref="VaryByQueryKeys"/> requires the response cache middleware.    
    public string[]? VaryByQueryKeys
    {
        get => _executor.VaryByQueryKeys;
        set => _executor.VaryByQueryKeys = value;
    }
    
    public ResponseCacheFilter(CacheProfile cacheProfile, ILoggerFactory loggerFactory)
    {
        _executor = new ResponseCacheFilterExecutor(cacheProfile);
        _logger = loggerFactory.CreateLogger(GetType());
    }
                                
    /// <inheritdoc />
    public void OnActionExecuting(ActionExecutingContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        // If there are more filters which can override the values written by this filter,
        // then skip execution of this filter.
        var effectivePolicy = context.FindEffectivePolicy<IResponseCacheFilter>();
        if (effectivePolicy != null && effectivePolicy != this)
        {
            _logger.NotMostEffectiveFilter(
                GetType(), 
                effectivePolicy.GetType(), 
                typeof(IResponseCacheFilter));
            
            return;
        }
        
        _executor.Execute(context);
    }
    
    /// <inheritdoc />
    public void OnActionExecuted(ActionExecutedContext context)
    {
    }
}

```

###### 3.3.8.1 response cache filter executor

```c#
internal class ResponseCacheFilterExecutor
{
    private readonly CacheProfile _cacheProfile;
        
    private int? _cacheDuration;
    public int Duration
    {
        get => _cacheDuration ?? _cacheProfile.Duration ?? 0;
        set => _cacheDuration = value;
    }
    
    private ResponseCacheLocation? _cacheLocation;
    public ResponseCacheLocation Location
    {
        get => _cacheLocation ?? _cacheProfile.Location ?? ResponseCacheLocation.Any;
        set => _cacheLocation = value;
    }
    
    private bool? _cacheNoStore;
    public bool NoStore
    {
        get => _cacheNoStore ?? _cacheProfile.NoStore ?? false;
        set => _cacheNoStore = value;
    }
    
    private string? _cacheVaryByHeader;
    public string? VaryByHeader
    {
        get => _cacheVaryByHeader ?? _cacheProfile.VaryByHeader;
        set => _cacheVaryByHeader = value;
    }
    
    private string[]? _cacheVaryByQueryKeys;
    public string[]? VaryByQueryKeys
    {
        get => _cacheVaryByQueryKeys ?? _cacheProfile.VaryByQueryKeys;
        set => _cacheVaryByQueryKeys = value;
    }
    
                                               
    public ResponseCacheFilterExecutor(CacheProfile cacheProfile)
    {
        _cacheProfile = cacheProfile ?? throw new ArgumentNullException(nameof(cacheProfile));
    }
            
    public void Execute(FilterContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        if (!NoStore)
        {
            // Duration MUST be set (either in the cache profile or in this filter) unless NoStore is true.
            if (_cacheProfile.Duration == null && _cacheDuration == null)
            {
                throw new InvalidOperationException(
                    Resources.FormatResponseCache_SpecifyDuration(
                        nameof(NoStore), 
                        nameof(Duration)));
            }
        }
        
        var headers = context.HttpContext.Response.Headers;
        
        // Clear all headers
        headers.Remove(HeaderNames.Vary);
        headers.Remove(HeaderNames.CacheControl);
        headers.Remove(HeaderNames.Pragma);
        
        if (!string.IsNullOrEmpty(VaryByHeader))
        {
            headers[HeaderNames.Vary] = VaryByHeader;
        }
        
        if (VaryByQueryKeys != null)
        {
            var responseCachingFeature = context.HttpContext
                							 .Features
                							 .Get<IResponseCachingFeature>();
            
            if (responseCachingFeature == null)
            {
                throw new InvalidOperationException(
                    Resources.FormatVaryByQueryKeys_Requires_ResponseCachingMiddleware(nameof(VaryByQueryKeys)));
                }
            
                responseCachingFeature.VaryByQueryKeys = VaryByQueryKeys;
            }

            if (NoStore)
            {
                headers[HeaderNames.CacheControl] = "no-store";

                // Cache-control: no-store, no-cache is valid.
                if (Location == ResponseCacheLocation.None)
                {
                    headers.AppendCommaSeparatedValues(HeaderNames.CacheControl, "no-cache");
                    headers[HeaderNames.Pragma] = "no-cache";
                }
            }
            else
            {
                string? cacheControlValue;
                switch (Location)
                {
                    case ResponseCacheLocation.Any:
                        cacheControlValue = "public,";
                        break;
                    case ResponseCacheLocation.Client:
                        cacheControlValue = "private,";
                        break;
                    case ResponseCacheLocation.None:
                        cacheControlValue = "no-cache,";
                        headers[HeaderNames.Pragma] = "no-cache";
                        break;
                    default:
                        cacheControlValue = null;
                        break;
                }

                cacheControlValue = $"{cacheControlValue}max-age={Duration}";
                headers[HeaderNames.CacheControl] = cacheControlValue;
            }
    }
}

```

###### 3.3.8.2 response cache location

```c#
public enum ResponseCacheLocation
{    
    // Cached in both proxies and client. Sets "Cache-control" header to "public".    
    Any = 0,    
    // Cached only in the client. Sets "Cache-control" header to "private".    
    Client = 1,   
    // "Cache-control" and "Pragma" headers are set to "no-cache".   
    None = 2
}

```

##### 3.3.9 controller result filter

```c#
internal class ControllerResultFilter : IAsyncResultFilter, IOrderedFilter
{
    // Controller-filter methods run farthest from the result by default.    
    public int Order { get; set; } = int.MinValue;
    
    /// <inheritdoc />
    public Task OnResultExecutionAsync(
        ResultExecutingContext context,
        ResultExecutionDelegate next)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (next == null)
        {
            throw new ArgumentNullException(nameof(next));
        }
        
        /* 解析 controller */
        var controller = context.Controller;
        if (controller == null)
        {
            throw new InvalidOperationException(
                Resources.FormatPropertyOfTypeCannotBeNull(
                    nameof(context.Controller),
                    nameof(ResultExecutingContext)));
        }
        // 如果 controller 实现了 async result filter 接口
        if (controller is IAsyncResultFilter asyncResultFilter)
        {
            return asyncResultFilter.OnResultExecutionAsync(context, next);
        }
        // 如果 controller 实现了 result filter 接口
        else if (controller is IResultFilter resultFilter)
        {
            return ExecuteResultFilter(context, next, resultFilter);
        }
        // 否则，调用 next 委托
        else
        {
            return next();
        }
    }
    
    private static async Task ExecuteResultFilter(
        ResultExecutingContext context,
        ResultExecutionDelegate next,
        IResultFilter resultFilter)
    {
        // 执行 executing 方法
        resultFilter.OnResultExecuting(context);
        // 执行 executed 方法
        if (!context.Cancel)
        {
            resultFilter.OnResultExecuted(await next());
        }
    }
}

```

##### 3.3.10 client error result filter

```c#
internal class ClientErrorResultFilter : 
	IAlwaysRunResultFilter, 
	IOrderedFilter
{
    internal const int FilterOrder = -2000;     
    public int Order => FilterOrder;
    
    private readonly IClientErrorFactory _clientErrorFactory;
    private readonly ILogger<ClientErrorResultFilter> _logger;
    
    public ClientErrorResultFilter(
        IClientErrorFactory clientErrorFactory,
        ILogger<ClientErrorResultFilter> logger)
    {
        _clientErrorFactory = clientErrorFactory 
            					 ?? throw new ArgumentNullException(
            									 nameof(clientErrorFactory));
       
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }
    
    public void OnResultExecuting(ResultExecutingContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        /* 如果 context 的 result 没有实现 client error action result 接口，
           直接返回 */
        if (!(context.Result is IClientErrorActionResult clientError))
        {
            return;
        }
        
        /* 如果 result 的 status code <400，即不是服务端错误，直接返回 */
        // We do not have an upper bound on the allowed status code. 
        // This allows this filter to be used for 5xx and later status codes.
        if (clientError.StatusCode < 400)
        {
            return;
        }
        
        /* 创建 client error result，注入到 result executing context */
        var result = _clientErrorFactory.GetClientError(context, clientError);
        if (result == null)
        {
            return;
        }
        
        _logger.TransformingClientError(
            		context.Result.GetType(), 
            		result.GetType(), 
            		clientError.StatusCode);

        context.Result = result;
    }    
        
    public void OnResultExecuted(ResultExecutedContext context)
    {
    }        
}

```

##### 3.3.11 client error result filter factory

```c#
internal sealed class ClientErrorResultFilterFactory : 
	IFilterFactory, 
	IOrderedFilter
{
    public int Order => ClientErrorResultFilter.FilterOrder;    
    public bool IsReusable => true;
    
    public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
    {
        var resultFilter = ActivatorUtilities.CreateInstance<ClientErrorResultFilter>(serviceProvider);
        
        return resultFilter;
    }
}

```

##### 3.3.12 model state invalid filter

```c#
public class ModelStateInvalidFilter : 
	IActionFilter, 
	IOrderedFilter
{       
    private readonly ApiBehaviorOptions _apiBehaviorOptions;
    private readonly ILogger _logger;
    
    internal const int FilterOrder = -2000;
    public int Order => FilterOrder;
       
    public bool IsReusable => true;
    
    public ModelStateInvalidFilter(
        ApiBehaviorOptions apiBehaviorOptions, 
        ILogger logger)
    {
        _apiBehaviorOptions = apiBehaviorOptions ?? throw new ArgumentNullException(nameof(apiBehaviorOptions));
        if (!_apiBehaviorOptions.SuppressModelStateInvalidFilter && 
            _apiBehaviorOptions.InvalidModelStateResponseFactory == null)
        {
            throw new ArgumentException(
                Resources.FormatPropertyOfTypeCannotBeNull(
                    typeof(ApiBehaviorOptions),
                    nameof(ApiBehaviorOptions.InvalidModelStateResponseFactory)));
        }
        
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }
    
    public void OnActionExecuting(ActionExecutingContext context)
    {
        if (context.Result == null && !context.ModelState.IsValid)
        {
            _logger.ModelStateInvalidFilterExecuting();
            context.Result = _apiBehaviorOptions.InvalidModelStateResponseFactory(context);
        }
    }
            
    public void OnActionExecuted(ActionExecutedContext context)
    {
    }            
}

```

##### 3.3.12 model state invalid filter factory

```c#
internal class ModelStateInvalidFilterFactory : 
	IFilterFactory, 
	IOrderedFilter
{
    public int Order => ModelStateInvalidFilter.FilterOrder;    
    public bool IsReusable => true;
    
    public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
    {
        var options = serviceProvider.GetRequiredService<IOptions<ApiBehaviorOptions>>();
        var loggerFactory = serviceProvider.GetRequiredService<ILoggerFactory>();
        
        return new ModelStateInvalidFilter(
            options.Value, 
            loggerFactory.CreateLogger<ModelStateInvalidFilter>());
    }
}

```

#### 3.4 filter attribute

##### 3.4.1 authorize attribute?

```c#

```

##### 3.4.2 allow anonymous attribute?

```c#

```

##### 3.4.3 request form limits attribute

```c#
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, AllowMultiple = false, Inherited = true)]
    public class RequestFormLimitsAttribute : Attribute, IFilterFactory, IOrderedFilter
    {
        /// <summary>
        /// Gets the order value for determining the order of execution of filters. Filters execute in
        /// ascending numeric value of the <see cref="Order"/> property.
        /// </summary>
        /// <remarks>
        /// <para>
        /// Filters are executed in an ordering determined by an ascending sort of the <see cref="Order"/> property.
        /// </para>
        /// <para>
        /// The default Order for this attribute is 900 because it must run before ValidateAntiForgeryTokenAttribute and
        /// after any filter which does authentication or login in order to allow them to behave as expected (ie Unauthenticated or Redirect instead of 400).
        /// </para>
        /// <para>
        /// Look at <see cref="IOrderedFilter.Order"/> for more detailed info.
        /// </para>
        /// </remarks>
        public int Order { get; set; } = 900;

        /// <inheritdoc />
        public bool IsReusable => true;

        // Internal for unit testing
        internal FormOptions FormOptions { get; } = new FormOptions();

        /// <summary>
        /// Enables full request body buffering. Use this if multiple components need to read the raw stream.
        /// The default value is false.
        /// </summary>
        public bool BufferBody
        {
            get => FormOptions.BufferBody;
            set => FormOptions.BufferBody = value;
        }

        /// <summary>
        /// If <see cref="BufferBody"/> is enabled, this many bytes of the body will be buffered in memory.
        /// If this threshold is exceeded then the buffer will be moved to a temp file on disk instead.
        /// This also applies when buffering individual multipart section bodies.
        /// </summary>
        public int MemoryBufferThreshold
        {
            get => FormOptions.MemoryBufferThreshold;
            set => FormOptions.MemoryBufferThreshold = value;
        }

        /// <summary>
        /// If <see cref="BufferBody"/> is enabled, this is the limit for the total number of bytes that will
        /// be buffered. Forms that exceed this limit will throw an <see cref="InvalidDataException"/> when parsed.
        /// </summary>
        public long BufferBodyLengthLimit
        {
            get => FormOptions.BufferBodyLengthLimit;
            set => FormOptions.BufferBodyLengthLimit = value;
        }

        /// <summary>
        /// A limit for the number of form entries to allow.
        /// Forms that exceed this limit will throw an <see cref="InvalidDataException"/> when parsed.
        /// </summary>
        public int ValueCountLimit
        {
            get => FormOptions.ValueCountLimit;
            set => FormOptions.ValueCountLimit = value;
        }

        /// <summary>
        /// A limit on the length of individual keys. Forms containing keys that exceed this limit will
        /// throw an <see cref="InvalidDataException"/> when parsed.
        /// </summary>
        public int KeyLengthLimit
        {
            get => FormOptions.KeyLengthLimit;
            set => FormOptions.KeyLengthLimit = value;
        }

        /// <summary>
        /// A limit on the length of individual form values. Forms containing values that exceed this
        /// limit will throw an <see cref="InvalidDataException"/> when parsed.
        /// </summary>
        public int ValueLengthLimit
        {
            get => FormOptions.ValueLengthLimit;
            set => FormOptions.ValueLengthLimit = value;
        }

        /// <summary>
        /// A limit for the length of the boundary identifier. Forms with boundaries that exceed this
        /// limit will throw an <see cref="InvalidDataException"/> when parsed.
        /// </summary>
        public int MultipartBoundaryLengthLimit
        {
            get => FormOptions.MultipartBoundaryLengthLimit;
            set => FormOptions.MultipartBoundaryLengthLimit = value;
        }

        /// <summary>
        /// A limit for the number of headers to allow in each multipart section. Headers with the same name will
        /// be combined. Form sections that exceed this limit will throw an <see cref="InvalidDataException"/>
        /// when parsed.
        /// </summary>
        public int MultipartHeadersCountLimit
        {
            get => FormOptions.MultipartHeadersCountLimit;
            set => FormOptions.MultipartHeadersCountLimit = value;
        }

        /// <summary>
        /// A limit for the total length of the header keys and values in each multipart section.
        /// Form sections that exceed this limit will throw an <see cref="InvalidDataException"/> when parsed.
        /// </summary>
        public int MultipartHeadersLengthLimit
        {
            get => FormOptions.MultipartHeadersLengthLimit;
            set => FormOptions.MultipartHeadersLengthLimit = value;
        }

        /// <summary>
        /// A limit for the length of each multipart body. Forms sections that exceed this limit will throw an
        /// <see cref="InvalidDataException"/> when parsed.
        /// </summary>
        public long MultipartBodyLengthLimit
        {
            get => FormOptions.MultipartBodyLengthLimit;
            set => FormOptions.MultipartBodyLengthLimit = value;
        }

        /// <inheritdoc />
        public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
        {
            var filter = serviceProvider.GetRequiredService<RequestFormLimitsFilter>();
            filter.FormOptions = FormOptions;
            return filter;
        }
    }
```

##### 3.4.4 request size limit attribute

```c#
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, AllowMultiple = false, Inherited = true)]
    public class RequestSizeLimitAttribute : Attribute, IFilterFactory, IOrderedFilter
    {
        private readonly long _bytes;

        /// <summary>
        /// Creates a new instance of <see cref="RequestSizeLimitAttribute"/>.
        /// </summary>
        /// <param name="bytes">The request body size limit.</param>
        public RequestSizeLimitAttribute(long bytes)
        {
            _bytes = bytes;
        }

        /// <summary>
        /// Gets the order value for determining the order of execution of filters. Filters execute in
        /// ascending numeric value of the <see cref="Order"/> property.
        /// </summary>
        /// <remarks>
        /// <para>
        /// Filters are executed in an ordering determined by an ascending sort of the <see cref="Order"/> property.
        /// </para>
        /// <para>
        /// The default Order for this attribute is 900 because it must run before ValidateAntiForgeryTokenAttribute and
        /// after any filter which does authentication or login in order to allow them to behave as expected (ie Unauthenticated or Redirect instead of 400).
        /// </para>
        /// <para>
        /// Look at <see cref="IOrderedFilter.Order"/> for more detailed info.
        /// </para>
        /// </remarks>
        public int Order { get; set; } = 900;

        /// <inheritdoc />
        public bool IsReusable => true;

        /// <inheritdoc />
        public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
        {
            var filter = serviceProvider.GetRequiredService<RequestSizeLimitFilter>();
            filter.Bytes = _bytes;
            return filter;
        }
    }
```

##### 3.4.5 disable request size limit attribute

```c#
[AttributeUsage(
    AttributeTargets.Class | AttributeTargets.Method, 
    AllowMultiple = false, 
    Inherited = true)]
public class DisableRequestSizeLimitAttribute : 
	Attribute, 	
	IFilterFactory, 
	IOrderedFilter
{    
    public int Order { get; set; } = 900;        
    public bool IsReusable => true;
        
    public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
    {
        var filter = serviceProvider.GetRequiredService<DisableRequestSizeLimitFilter>();
        return filter;
    }
}

```

##### 3.4.6 require https attribute

```c#
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, Inherited = true, AllowMultiple = false)]
public class RequireHttpsAttribute : Attribute, IAuthorizationFilter, IOrderedFilter
{
    private bool? _permanent;
       
    public bool Permanent
    {
        get { return _permanent ?? false; }
        set { _permanent = value; }
    }
    
    /// <inheritdoc />
    /// <value>Default is <c>int.MinValue + 50</c> to run this <see cref="IAuthorizationFilter"/> early.</value>
    public int Order { get; set; } = int.MinValue + 50;
    
    
    public virtual void OnAuthorization(AuthorizationFilterContext filterContext)
    {
        if (filterContext == null)
        {
            throw new ArgumentNullException(nameof(filterContext));
        }
        
        if (!filterContext.HttpContext.Request.IsHttps)
        {
            HandleNonHttpsRequest(filterContext);
        }
    }
    
        
    // If it was a GET request, default implementation sets "AuthorizationFilterContext.Result" to a
    // result which will redirect the client to the HTTPS version of the request URI. 
    // Otherwise, default implementation sets "AuthorizationFilterContext.Result" to a result which will 
    // set the status code to <c>403</c> (Forbidden).
    protected virtual void HandleNonHttpsRequest(AuthorizationFilterContext filterContext)
    {
        // only redirect for GET requests, otherwise the browser might not propagate the verb and request
        // body correctly.
        if (!HttpMethods.IsGet(filterContext.HttpContext.Request.Method))
        {
            filterContext.Result = new StatusCodeResult(StatusCodes.Status403Forbidden);
        }
        else
        {
            var optionsAccessor = filterContext.HttpContext
                							.RequestServices
                							.GetRequiredService<IOptions<MvcOptions>>();
            
            var request = filterContext.HttpContext.Request;
            
            var host = request.Host;
            if (optionsAccessor.Value.SslPort.HasValue && 
                optionsAccessor.Value.SslPort > 0)
            {
                // a specific SSL port is specified
                host = new HostString(host.Host, optionsAccessor.Value.SslPort.Value);
            }
            else
            {
                // clear the port
                host = new HostString(host.Host);
            }
            
            var permanentValue = _permanent ?? optionsAccessor.Value.RequireHttpsPermanent;
            
            var newUrl = string.Concat(
                "https://",
                host.ToUriComponent(),
                request.PathBase.ToUriComponent(),
                request.Path.ToUriComponent(),
                request.QueryString.ToUriComponent());
            
            // redirect to HTTPS version of page
            filterContext.Result = new RedirectResult(newUrl, permanentValue);
        }
    }
}

```

##### 3.4.7 middleware filter attribute

```c#
[AttributeUsage(
    AttributeTargets.Class | AttributeTargets.Method, 
    AllowMultiple = true, Inherited = true)]
public class MiddlewareFilterAttribute : 
	Attribute, 
	IFilterFactory, 
	IOrderedFilter
{
    public Type ConfigurationType { get; }        
    public int Order { get; set; }        
    public bool IsReusable => true;
    
    public MiddlewareFilterAttribute(Type configurationType)
    {
        if (configurationType == null)
        {
            throw new ArgumentNullException(nameof(configurationType));
        }
        
        // 注入 configuration type，配置 filter 处理方法
        ConfigurationType = configurationType;
    }
           
    public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
    {
        if (serviceProvider == null)
        {
            throw new ArgumentNullException(nameof(serviceProvider));
        }
        // 解析 middleware filter builder
        var middlewarePipelineService = serviceProvider.GetRequiredService<MiddlewareFilterBuilder>();
        // 由 configuration type 构建新的 middleware 管道
        var pipeline = middlewarePipelineService.GetPipeline(ConfigurationType);
        // 由新的 middleware 管道创建 middleware filter
        return new MiddlewareFilter(pipeline);
    }
}

```

##### 3.4.8 response cache attribute

```c#
[AttributeUsage(
    AttributeTargets.Class | AttributeTargets.Method, 
    AllowMultiple = false, 
    Inherited = true)]
public class ResponseCacheAttribute : 
	Attribute, 
	IFilterFactory, 
	IOrderedFilter
{
    // A nullable-int cannot be used as an Attribute parameter. Hence this nullable-int is present to back the Duration property.
    // The same goes for nullable-ResponseCacheLocation and nullable-bool.
    private int? _duration;
    public int Duration
    {
        get => _duration ?? 0;
        set => _duration = value;
    }
    
    private ResponseCacheLocation? _location;
    public ResponseCacheLocation Location
    {
        get => _location ?? ResponseCacheLocation.Any;
        set => _location = value;
    }
    
    private bool? _noStore;
    public bool NoStore
    {
        get => _noStore ?? false;
        set => _noStore = value;
    }
            
    public string VaryByHeader { get; set; }        
    public string[] VaryByQueryKeys { get; set; }       
    public string CacheProfileName { get; set; }        
    public int Order { get; set; }       
    public bool IsReusable => true;
        
    public CacheProfile GetCacheProfile(MvcOptions options)
    {
        CacheProfile selectedProfile = null;
        if (CacheProfileName != null)
        {
            options.CacheProfiles.TryGetValue(CacheProfileName, out selectedProfile);
            if (selectedProfile == null)
            {
                throw new InvalidOperationException(Resources.FormatCacheProfileNotFound(CacheProfileName));
            }
        }
        
        // If the ResponseCacheAttribute parameters are set, then it must override the values from the Cache Profile.
        // The below expression first checks if the duration is set by the attribute's parameter.
        // If absent, it checks the selected cache profile (Note: There can be no cache profile as well)
        // The same is the case for other properties.
        _duration = _duration ?? selectedProfile?.Duration;
        _noStore = _noStore ?? selectedProfile?.NoStore;
        _location = _location ?? selectedProfile?.Location;
        VaryByHeader = VaryByHeader ?? selectedProfile?.VaryByHeader;
        VaryByQueryKeys = VaryByQueryKeys ?? selectedProfile?.VaryByQueryKeys;
        
        return new CacheProfile
        {
            Duration = _duration,
            Location = _location,
            NoStore = _noStore,
            VaryByHeader = VaryByHeader,
            VaryByQueryKeys = VaryByQueryKeys,
        };
    }
    
    /// <inheritdoc />
    public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
    {
        if (serviceProvider == null)
        {
            throw new ArgumentNullException(nameof(serviceProvider));
        }
        
        var loggerFactory = serviceProvider.GetRequiredService<ILoggerFactory>();
        var optionsAccessor = serviceProvider.GetRequiredService<IOptions<MvcOptions>>();
        var cacheProfile = GetCacheProfile(optionsAccessor.Value);
        
        // ResponseCacheFilter cannot take any null values. 
        // Hence, if there are any null values, the properties convert them to their defaults and are passed on.
        return new ResponseCacheFilter(cacheProfile, loggerFactory);
    }
}

```

###### 3.4.8.1 cache profile

```c#
public class CacheProfile
{    
    public int? Duration { get; set; }        
    public ResponseCacheLocation? Location { get; set; }        
    public bool? NoStore { get; set; }        
    public string VaryByHeader { get; set; }        
    public string[] VaryByQueryKeys { get; set; }
}

```

##### 3.4.9 action filter attribute

```c#
[AttributeUsage(
    AttributeTargets.Class | AttributeTargets.Method, 
    AllowMultiple = true, 
    Inherited = true)]
public abstract class ActionFilterAttribute :
	Attribute, 
	IActionFilter, 
	IAsyncActionFilter, 
	IResultFilter, 
	IAsyncResultFilter, 
	IOrderedFilter
{    
    public int Order { get; set; }
        
    public virtual void OnActionExecuting(ActionExecutingContext context)
    {
    }
        
    public virtual void OnActionExecuted(ActionExecutedContext context)
    {
    }
        
    public virtual async Task OnActionExecutionAsync(
        ActionExecutingContext context,
        ActionExecutionDelegate next)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (next == null)
        {
            throw new ArgumentNullException(nameof(next));
        }
        
        OnActionExecuting(context);
        if (context.Result == null)
        {
            OnActionExecuted(await next());
        }
    }
        
    public virtual void OnResultExecuting(ResultExecutingContext context)
    {
    }
        
    public virtual void OnResultExecuted(ResultExecutedContext context)
    {
    }
       
    public virtual async Task OnResultExecutionAsync(
        ResultExecutingContext context,
        ResultExecutionDelegate next)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (next == null)
        {
            throw new ArgumentNullException(nameof(next));
        }
        
        OnResultExecuting(context);
        if (!context.Cancel)
        {
            OnResultExecuted(await next());
        }
    }
}

```

##### 3.4.10 exception filter attribute

```c#
[AttributeUsage(
    AttributeTargets.Class | AttributeTargets.Method, 
    AllowMultiple = true, 
    Inherited = true)]
public abstract class ExceptionFilterAttribute : 
	Attribute, 
	IAsyncExceptionFilter, 
	IExceptionFilter, 
	IOrderedFilter
{
    /// <inheritdoc />
    public int Order { get; set; }
    
    /// <inheritdoc />
    public virtual Task OnExceptionAsync(ExceptionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        OnException(context);
        return Task.CompletedTask;
    }
    
    /// <inheritdoc />
    public virtual void OnException(ExceptionContext context)
    {
    }
}

```

##### 3.4.11 result filter attribute

```c#
[AttributeUsage(
    AttributeTargets.Class | AttributeTargets.Method, 
    AllowMultiple = true, 
    Inherited = true)]
public abstract class ResultFilterAttribute : 
	Attribute, 
	IResultFilter, 
	IAsyncResultFilter, 
	IOrderedFilter
{   
    public int Order { get; set; }
       
    public virtual void OnResultExecuting(ResultExecutingContext context)
    {
    }
        
    public virtual void OnResultExecuted(ResultExecutedContext context)
    {
    }
       
    public virtual async Task OnResultExecutionAsync(
        ResultExecutingContext context,
        ResultExecutionDelegate next)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (next == null)
        {
            throw new ArgumentNullException(nameof(next));
        }
        
        OnResultExecuting(context);
        if (!context.Cancel)
        {
            OnResultExecuted(await next());
        }
    }
}

```

##### 3.4.12 produce attribute

```c#
[AttributeUsage(
    AttributeTargets.Class | AttributeTargets.Method, 
    AllowMultiple = false, 
    Inherited = true)]
public class ProducesAttribute : 
	Attribute, 
	IResultFilter, 
	IOrderedFilter, 
	IApiResponseMetadataProvider
{   
    public Type Type { get; set; }        
    public MediaTypeCollection ContentTypes { get; set; }        
    public int StatusCode => StatusCodes.Status200OK;       
    public int Order { get; set; }
    
    public ProducesAttribute(Type type)
    {   
        Type = type ?? throw new ArgumentNullException(nameof(type));
        ContentTypes = new MediaTypeCollection();
    }    
   
    public ProducesAttribute(
        string contentType, 
        params string[] additionalContentTypes)
    {
        if (contentType == null)
        {
            throw new ArgumentNullException(nameof(contentType));
        }
        
        // We want to ensure that the given provided content types are valid values, so
        // we validate them using the semantics of MediaTypeHeaderValue.
        MediaTypeHeaderValue.Parse(contentType);
        
        for (var i = 0; i < additionalContentTypes.Length; i++)
        {
            MediaTypeHeaderValue.Parse(additionalContentTypes[i]);
        }
        
        ContentTypes = GetContentTypes(contentType, additionalContentTypes);
    }
    
    private MediaTypeCollection GetContentTypes(string firstArg, string[] args)
    {
        var completeArgs = new List<string>(args.Length + 1);
        completeArgs.Add(firstArg);
        completeArgs.AddRange(args);
        var contentTypes = new MediaTypeCollection();
        foreach (var arg in completeArgs)
        {
            var contentType = new MediaType(arg);
            if (contentType.HasWildcard)
            {
                throw new InvalidOperationException(
                    Resources.FormatMatchAllContentTypeIsNotAllowed(arg));
            }
            
            contentTypes.Add(arg);
        }
        
        return contentTypes;
    }
                   
    public virtual void OnResultExecuting(ResultExecutingContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        if (context.Result is ObjectResult objectResult)
        {
            // Check if there are any IFormatFilter in the pipeline, and if any of them is active. 
            // If there is one, do not override the content type value.
            for (var i = 0; i < context.Filters.Count; i++)
            {
                var filter = context.Filters[i] as IFormatFilter;
                
                if (filter?.GetFormat(context) != null)
                {
                    return;
                }
            }
            
            SetContentTypes(objectResult.ContentTypes);
        }
    }
    
    public void SetContentTypes(MediaTypeCollection contentTypes)
    {
        contentTypes.Clear();
        foreach (var contentType in ContentTypes)
        {
            contentTypes.Add(contentType);
        }
    }
    
    public virtual void OnResultExecuted(ResultExecutedContext context)
    {
    }                   
}

```

##### 3.4.13 type filter attribute?

```c#
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, AllowMultiple = true, Inherited = true)]
    [DebuggerDisplay("TypeFilter: Type={ImplementationType} Order={Order}")]
    public class TypeFilterAttribute : Attribute, IFilterFactory, IOrderedFilter
    {
        private ObjectFactory? _factory;

        /// <summary>
        /// Instantiates a new <see cref="TypeFilterAttribute"/> instance.
        /// </summary>
        /// <param name="type">The <see cref="Type"/> of filter to create.</param>
        public TypeFilterAttribute(Type type)
        {
            ImplementationType = type ?? throw new ArgumentNullException(nameof(type));
        }

        /// <summary>
        /// Gets or sets the non-service arguments to pass to the <see cref="ImplementationType"/> constructor.
        /// </summary>
        /// <remarks>
        /// Service arguments are found in the dependency injection container i.e. this filter supports constructor
        /// injection in addition to passing the given <see cref="Arguments"/>.
        /// </remarks>
        public object[]? Arguments { get; set; }

        /// <summary>
        /// Gets the <see cref="Type"/> of filter to create.
        /// </summary>
        public Type ImplementationType { get; }

        /// <inheritdoc />
        public int Order { get; set; }

        /// <inheritdoc />
        public bool IsReusable { get; set; }

        /// <inheritdoc />
        public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
        {
            if (serviceProvider == null)
            {
                throw new ArgumentNullException(nameof(serviceProvider));
            }

            if (_factory == null)
            {
                var argumentTypes = Arguments?.Select(a => a.GetType())?.ToArray();
                _factory = ActivatorUtilities.CreateFactory(ImplementationType, argumentTypes ?? Type.EmptyTypes);
            }

            var filter = (IFilterMetadata)_factory(serviceProvider, Arguments);
            if (filter is IFilterFactory filterFactory)
            {
                // Unwrap filter factories
                filter = filterFactory.CreateInstance(serviceProvider);
            }

            return filter;
        }
    }
```

##### 3.4.14 service filter attribute?

```c#
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, AllowMultiple = true, Inherited = true)]
    [DebuggerDisplay("ServiceFilter: Type={ServiceType} Order={Order}")]
    public class ServiceFilterAttribute : Attribute, IFilterFactory, IOrderedFilter
    {
        /// <summary>
        /// Instantiates a new <see cref="ServiceFilterAttribute"/> instance.
        /// </summary>
        /// <param name="type">The <see cref="Type"/> of filter to find.</param>
        public ServiceFilterAttribute(Type type)
        {
            ServiceType = type ?? throw new ArgumentNullException(nameof(type)); 
        }

        /// <inheritdoc />
        public int Order { get; set; }

        /// <summary>
        /// Gets the <see cref="Type"/> of filter to find.
        /// </summary>
        public Type ServiceType { get; }

        /// <inheritdoc />
        public bool IsReusable { get; set; }

        /// <inheritdoc />
        public IFilterMetadata CreateInstance(IServiceProvider serviceProvider)
        {
            if (serviceProvider == null)
            {
                throw new ArgumentNullException(nameof(serviceProvider));
            }

            var filter = (IFilterMetadata)serviceProvider.GetRequiredService(ServiceType);
            if (filter is IFilterFactory filterFactory)
            {
                // Unwrap filter factories
                filter = filterFactory.CreateInstance(serviceProvider);
            }

            return filter;
        }
    }
```

#### 3.5 filter factory & provider

##### 3.5.1 filter factory

```c#
internal static class FilterFactory
    {
        public static FilterFactoryResult GetAllFilters(
            IFilterProvider[] filterProviders,
            ActionContext actionContext)
        {
            if (filterProviders == null)
            {
                throw new ArgumentNullException(nameof(filterProviders));
            }

            if (actionContext == null)
            {
                throw new ArgumentNullException(nameof(actionContext));
            }

            var actionDescriptor = actionContext.ActionDescriptor;

            var staticFilterItems = new FilterItem[actionDescriptor.FilterDescriptors.Count];

            var orderedFilters = actionDescriptor.FilterDescriptors
                .OrderBy(
                    filter => filter,
                    FilterDescriptorOrderComparer.Comparer)
                .ToList();

            for (var i = 0; i < orderedFilters.Count; i++)
            {
                staticFilterItems[i] = new FilterItem(orderedFilters[i]);
            }

            var allFilterItems = new List<FilterItem>(staticFilterItems);

            // Execute the filter factory to determine which static filters can be cached.
            var filters = CreateUncachedFiltersCore(filterProviders, actionContext, allFilterItems);

            // Cache the filter items based on the following criteria
            // 1. Are created statically (ex: via filter attributes, added to global filter list etc.)
            // 2. Are re-usable
            var allFiltersAreReusable = true;
            for (var i = 0; i < staticFilterItems.Length; i++)
            {
                var item = staticFilterItems[i];
                if (!item.IsReusable)
                {
                    item.Filter = null;
                    allFiltersAreReusable = false;
                }
            }

            if (allFiltersAreReusable && filterProviders.Length == 1 && filterProviders[0] is DefaultFilterProvider defaultFilterProvider)
            {
                // If we know we can safely cache all filters and only the default filter provider is registered, we can
                // probably re-use filters between requests.
                actionDescriptor.CachedResuableFilters = filters;
            }

            return new FilterFactoryResult(staticFilterItems, filters);
        }

        public static IFilterMetadata[] CreateUncachedFilters(
            IFilterProvider[] filterProviders,
            ActionContext actionContext,
            FilterItem[] cachedFilterItems)
        {
            if (filterProviders == null)
            {
                throw new ArgumentNullException(nameof(filterProviders));
            }

            if (actionContext == null)
            {
                throw new ArgumentNullException(nameof(actionContext));
            }

            if (cachedFilterItems == null)
            {
                throw new ArgumentNullException(nameof(cachedFilterItems));
            }

            if (actionContext.ActionDescriptor.CachedResuableFilters is { } cached)
            {
                return cached;
            }

            // Deep copy the cached filter items as filter providers could modify them
            var filterItems = new List<FilterItem>(cachedFilterItems.Length);
            for (var i = 0; i < cachedFilterItems.Length; i++)
            {
                var filterItem = cachedFilterItems[i];
                filterItems.Add(
                    new FilterItem(filterItem.Descriptor)
                    {
                        Filter = filterItem.Filter,
                        IsReusable = filterItem.IsReusable
                    });
            }

            return CreateUncachedFiltersCore(filterProviders, actionContext, filterItems);
        }

        private static IFilterMetadata[] CreateUncachedFiltersCore(
            IFilterProvider[] filterProviders,
            ActionContext actionContext,
            List<FilterItem> filterItems)
        {
            // Execute providers
            var context = new FilterProviderContext(actionContext, filterItems);

            for (var i = 0; i < filterProviders.Length; i++)
            {
                filterProviders[i].OnProvidersExecuting(context);
            }

            for (var i = filterProviders.Length - 1; i >= 0; i--)
            {
                filterProviders[i].OnProvidersExecuted(context);
            }

            // Extract filter instances from statically defined filters and filter providers
            var count = 0;
            for (var i = 0; i < filterItems.Count; i++)
            {
                if (filterItems[i].Filter != null)
                {
                    count++;
                }
            }

            if (count == 0)
            {
                return Array.Empty<IFilterMetadata>();
            }
            else
            {
                var filters = new IFilterMetadata[count];
                var filterIndex = 0;
                for (int i = 0; i < filterItems.Count; i++)
                {
                    var filter = filterItems[i].Filter;
                    if (filter != null)
                    {
                        filters[filterIndex++] = filter;
                    }
                }

                return filters;
            }
        }
    }
```

###### 3.5.1.1 filter factory result

```c#
 internal readonly struct FilterFactoryResult
    {
        public FilterFactoryResult(
            FilterItem[] cacheableFilters,
            IFilterMetadata[] filters)
        {
            CacheableFilters = cacheableFilters;
            Filters = filters;
        }

        public FilterItem[] CacheableFilters { get; }

        public IFilterMetadata[] Filters { get; }
    }
```

###### 3.5.1.2 filter descriptor order comparer

```c#
internal class FilterDescriptorOrderComparer : IComparer<FilterDescriptor>
    {
        public static FilterDescriptorOrderComparer Comparer { get; } = new FilterDescriptorOrderComparer();

        public int Compare(FilterDescriptor? x, FilterDescriptor? y)
        {
            if (x == null)
            {
                throw new ArgumentNullException(nameof(x));
            }

            if (y == null)
            {
                throw new ArgumentNullException(nameof(y));
            }

            if (x.Order == y.Order)
            {
                return x.Scope.CompareTo(y.Scope);
            }
            else
            {
                return x.Order.CompareTo(y.Order);
            }
        }
    }
```



##### 3.5.2 filter provider

```c#
public interface IFilterProvider
{    
    int Order { get; }
    
    void OnProvidersExecuting(FilterProviderContext context);    
    void OnProvidersExecuted(FilterProviderContext context);
}

```

###### 3.5.1.1 filter provider context

```c#
public class FilterProviderContext
{
    public ActionContext ActionContext { get; set; }        
    public IList<FilterItem> Results { get; set; }
    
    public FilterProviderContext(
        ActionContext actionContext, 
        IList<FilterItem> items)
    {
        if (actionContext == null)
        {
            throw new ArgumentNullException(nameof(actionContext));
        }        
        if (items == null)
        {
            throw new ArgumentNullException(nameof(items));
        }
        
        ActionContext = actionContext;
        Results = items;
    }        
}

```

###### 3.5.1.2 filter item

```c#
[DebuggerDisplay("FilterItem: {Filter}")]
public class FilterItem
{
    public FilterDescriptor Descriptor { get; } = default!;        
    public IFilterMetadata Filter { get; set; } = default!;        
    public bool IsReusable { get; set; }
    
    public FilterItem(FilterDescriptor descriptor)
    {
        if (descriptor == null)
        {
            throw new ArgumentNullException(nameof(descriptor));
        }
        
        Descriptor = descriptor;
    }
            
    public FilterItem(
        FilterDescriptor descriptor, 
        IFilterMetadata filter) : this(descriptor)
    {
        if (filter == null)
        {
            throw new ArgumentNullException(nameof(filter));
        }
        
        Filter = filter;
    }                 
}

```

###### 3.5.1.3 default filter provider

```c#
internal class DefaultFilterProvider : IFilterProvider
{
    public int Order => -1000;
    
    /* provider executing */
    /// <inheritdoc />
    public void OnProvidersExecuting(FilterProviderContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        /* 如果 filter provider context 中，
           action descriptor 的 filter descriptors 集合不为 null */
        
        /* 即 filter provider 为 action 注入相关的 filter */
        
        if (context.ActionContext
            	   .ActionDescriptor
            	   .FilterDescriptors != null)
        {
            var results = context.Results;
            // Perf: Avoid allocating enumerator and read interface .Count once 
            // rather than per iteration
            var resultsCount = results.Count;
            
            /* 遍历 filter provider context 中的 results（filter item 集合），*/
            for (var i = 0; i < resultsCount; i++)
            {
                ProvideFilter(context, results[i]);
            }
        }
    }
            
    public void ProvideFilter(
        FilterProviderContext context,
        FilterItem filterItem)
    {
        // 如果 filter item 的 filter 不为 null，
        // 即 filter item 完成配置，直接返回
        if (filterItem.Filter != null)
        {
            return;
        }
        
        // 解析 filter item 的 descriptor 中的 filter metadata
        var filter = filterItem.Descriptor.Filter;
        
        /* 如果 filter metadata 不是 filter factory */
        if (filter is not IFilterFactory filterFactory)
        {
            // 直接将 filter metadata 赋值到 filter item 的 filter
            filterItem.Filter = filter;
            filterItem.IsReusable = true;
        }
        /* 否则，即 filter metadata 是 filter factory */
        else
        {
            // 调用 filter factory 创建 filter metadata，并赋值给 filter item 的 filter
            var services = context.ActionContext.HttpContext.RequestServices;
            filterItem.Filter = filterFactory.CreateInstance(services);
            filterItem.IsReusable = filterFactory.IsReusable;
            
            // 如果创建的 filter 为 null，抛出异常
            if (filterItem.Filter == null)
            {
                throw new InvalidOperationException(
                    Resources.FormatTypeMethodMustReturnNotNullValue(
                        "CreateInstance",
                        typeof(IFilterFactory).Name));
            }
            
            // 应用 filter container
            ApplyFilterToContainer(filterItem.Filter, filterFactory);
        }
    }
    
    private void ApplyFilterToContainer(
        object actualFilter, 
        IFilterMetadata filterMetadata)
    {
        Debug.Assert(actualFilter != null, "actualFilter should not be null");
        Debug.Assert(filterMetadata != null, "filterMetadata should not be null");

        // 如果 filter metadata 是 filter container，
        if (actualFilter is IFilterContainer container)
        {
            // 封装 filter metadata 到 filter container 的 filter defination
            container.FilterDefinition = filterMetadata;
        }
    }
    
    /// <inheritdoc />
    public void OnProvidersExecuted(FilterProviderContext context)
    {
    }
}

```

#### 3.6 filter collection

##### 3.6.1 filter collection

```c#
public class FilterCollection : Collection<IFilterMetadata>
    {
        /// <summary>
        /// Adds a type representing a <see cref="IFilterMetadata"/>.
        /// </summary>
        /// <typeparam name="TFilterType">Type representing a <see cref="IFilterMetadata"/>.</typeparam>
        /// <returns>A <see cref="IFilterMetadata"/> representing the added type.</returns>
        /// <remarks>
        /// Filter instances will be created using
        /// <see cref="Microsoft.Extensions.DependencyInjection.ActivatorUtilities"/>.
        /// Use <see cref="AddService(Type)"/> to register a service as a filter.
        /// The added filter will be assigned an order of 0.
        /// </remarks>
        public IFilterMetadata Add<TFilterType>() where TFilterType : IFilterMetadata
        {
            return Add(typeof(TFilterType));
        }

        /// <summary>
        /// Adds a type representing a <see cref="IFilterMetadata"/>.
        /// </summary>
        /// <param name="filterType">Type representing a <see cref="IFilterMetadata"/>.</param>
        /// <returns>A <see cref="IFilterMetadata"/> representing the added type.</returns>
        /// <remarks>
        /// Filter instances will be created using
        /// <see cref="Microsoft.Extensions.DependencyInjection.ActivatorUtilities"/>.
        /// Use <see cref="AddService(Type)"/> to register a service as a filter.
        /// The added filter will be assigned an order of 0.
        /// </remarks>
        public IFilterMetadata Add(Type filterType)
        {
            if (filterType == null)
            {
                throw new ArgumentNullException(nameof(filterType));
            }

            return Add(filterType, order: 0);
        }

        /// <summary>
        /// Adds a type representing a <see cref="IFilterMetadata"/>.
        /// </summary>
        /// <typeparam name="TFilterType">Type representing a <see cref="IFilterMetadata"/>.</typeparam>
        /// <param name="order">The order of the added filter.</param>
        /// <returns>A <see cref="IFilterMetadata"/> representing the added type.</returns>
        /// <remarks>
        /// Filter instances will be created using
        /// <see cref="Microsoft.Extensions.DependencyInjection.ActivatorUtilities"/>.
        /// Use <see cref="AddService(Type)"/> to register a service as a filter.
        /// </remarks>
        public IFilterMetadata Add<TFilterType>(int order) where TFilterType : IFilterMetadata
        {
            return Add(typeof(TFilterType), order);
        }

        /// <summary>
        /// Adds a type representing a <see cref="IFilterMetadata"/>.
        /// </summary>
        /// <param name="filterType">Type representing a <see cref="IFilterMetadata"/>.</param>
        /// <param name="order">The order of the added filter.</param>
        /// <returns>A <see cref="IFilterMetadata"/> representing the added type.</returns>
        /// <remarks>
        /// Filter instances will be created using
        /// <see cref="Microsoft.Extensions.DependencyInjection.ActivatorUtilities"/>.
        /// Use <see cref="AddService(Type)"/> to register a service as a filter.
        /// </remarks>
        public IFilterMetadata Add(Type filterType, int order)
        {
            if (filterType == null)
            {
                throw new ArgumentNullException(nameof(filterType));
            }

            if (!typeof(IFilterMetadata).IsAssignableFrom(filterType))
            {
                var message = Resources.FormatTypeMustDeriveFromType(
                    filterType.FullName,
                    typeof(IFilterMetadata).FullName);
                throw new ArgumentException(message, nameof(filterType));
            }

            var filter = new TypeFilterAttribute(filterType) { Order = order };
            Add(filter);
            return filter;
        }
        
        /// <summary>
        /// Adds a type representing a <see cref="IFilterMetadata"/>.
        /// </summary>
        /// <typeparam name="TFilterType">Type representing a <see cref="IFilterMetadata"/>.</typeparam>
        /// <returns>A <see cref="IFilterMetadata"/> representing the added service type.</returns>
        /// <remarks>
        /// Filter instances will be created through dependency injection. Use
        /// <see cref="Add(Type)"/> to register a service that will be created via
        /// type activation.
        /// The added filter will be assigned an order of 0.
        /// </remarks>
        public IFilterMetadata AddService<TFilterType>() where TFilterType : IFilterMetadata
        {
            return AddService(typeof(TFilterType));
        }

        /// <summary>
        /// Adds a type representing a <see cref="IFilterMetadata"/>.
        /// </summary>
        /// <param name="filterType">Type representing a <see cref="IFilterMetadata"/>.</param>
        /// <returns>A <see cref="IFilterMetadata"/> representing the added service type.</returns>
        /// <remarks>
        /// Filter instances will be created through dependency injection. Use
        /// <see cref="Add(Type)"/> to register a service that will be created via
        /// type activation.
        /// The added filter will be assigned an order of 0.
        /// </remarks>
        public IFilterMetadata AddService(Type filterType)
        {
            if (filterType == null)
            {
                throw new ArgumentNullException(nameof(filterType));
            }

            return AddService(filterType, order: 0);
        }

        /// <summary>
        /// Adds a type representing a <see cref="IFilterMetadata"/>.
        /// </summary>
        /// <typeparam name="TFilterType">Type representing a <see cref="IFilterMetadata"/>.</typeparam>
        /// <param name="order">The order of the added filter.</param>
        /// <returns>A <see cref="IFilterMetadata"/> representing the added service type.</returns>
        /// <remarks>
        /// Filter instances will be created through dependency injection. Use
        /// <see cref="Add(Type)"/> to register a service that will be created via
        /// type activation.
        /// </remarks>
        public IFilterMetadata AddService<TFilterType>(int order) where TFilterType : IFilterMetadata
        {
            return AddService(typeof(TFilterType), order);
        }

        /// <summary>
        /// Adds a type representing a <see cref="IFilterMetadata"/>.
        /// </summary>
        /// <param name="filterType">Type representing a <see cref="IFilterMetadata"/>.</param>
        /// <param name="order">The order of the added filter.</param>
        /// <returns>A <see cref="IFilterMetadata"/> representing the added service type.</returns>
        /// <remarks>
        /// Filter instances will be created through dependency injection. Use
        /// <see cref="Add(Type)"/> to register a service that will be created via
        /// type activation.
        /// </remarks>
        public IFilterMetadata AddService(Type filterType, int order)
        {
            if (filterType == null)
            {
                throw new ArgumentNullException(nameof(filterType));
            }

            if (!typeof(IFilterMetadata).IsAssignableFrom(filterType))
            {
                var message = Resources.FormatTypeMustDeriveFromType(
                    filterType.FullName,
                    typeof(IFilterMetadata).FullName);
                throw new ArgumentException(message, nameof(filterType));
            }

            var filter = new ServiceFilterAttribute(filterType) { Order = order };
            Add(filter);
            return filter;
        }
    }
```

##### 3.6.2 filter cursor

```c#
internal struct FilterCursor
    {
        private readonly IFilterMetadata[] _filters;
        private int _index;

        public FilterCursor(IFilterMetadata[] filters)
        {
            _filters = filters;
            _index = 0;
        }

        public void Reset()
        {
            _index = 0;
        }

        public FilterCursorItem<TFilter?, TFilterAsync?> GetNextFilter<TFilter, TFilterAsync>()
            where TFilter : class
            where TFilterAsync : class
        {
            while (_index < _filters.Length)
            {
                var filter = _filters[_index] as TFilter;
                var filterAsync = _filters[_index] as TFilterAsync;

                _index += 1;

                if (filter != null || filterAsync != null)
                {
                    return new FilterCursorItem<TFilter?, TFilterAsync?>(filter, filterAsync);
                }
            }

            return default(FilterCursorItem<TFilter?, TFilterAsync?>);
        }
    }
```

###### 3.6.2.1 filter cursor item

```c#
internal readonly struct FilterCursorItem<TFilter, TFilterAsync>
    {
        public FilterCursorItem(TFilter filter, TFilterAsync filterAsync)
        {
            Filter = filter;
            FilterAsync = filterAsync;
        }

        public TFilter Filter { get; }

        public TFilterAsync FilterAsync { get; }
    }
```

##### filter scope

```c#
public static class FilterScope
    {
        /// <summary>
        /// First filter scope.
        /// </summary>
        public static readonly int First = 0;

        /// <summary>
        /// Global filter scope.
        /// </summary>
        public static readonly int Global = 10;

        /// <summary>
        /// Controller filter scope.
        /// </summary>
        public static readonly int Controller = 20;

        /// <summary>
        /// Action filter scope.
        /// </summary>
        public static readonly int Action = 30;

        /// <summary>
        /// Last filter scope.
        /// </summary>
        public static readonly int Last = 100;
    }
```



### 4. formatter

#### 4.1 media type

##### 4.1.1 media type

```c#
public readonly struct MediaType
{
    private static readonly StringSegment QualityParameter = new StringSegment("q");
    
    private readonly MediaTypeParameterParser _parameterParser;            
    
    public StringSegment Type { get; }
	public StringSegment SubType { get; }    
    public StringSegment SubTypeSuffix { get; }
    public StringSegment SubTypeWithoutSuffix { get; }             
    
    public bool MatchesAllTypes => Type.Equals("*", StringComparison.OrdinalIgnoreCase);       
    public bool MatchesAllSubTypes => SubType.Equals("*", StringComparison.OrdinalIgnoreCase);        
    public bool MatchesAllSubTypesWithoutSuffix => SubTypeWithoutSuffix.Equals("*", StringComparison.OrdinalIgnoreCase);    
    public bool HasWildcard
    {
        get
        {
            return MatchesAllTypes ||
                   MatchesAllSubTypesWithoutSuffix ||
                   GetParameter("*").Equals("*", StringComparison.OrdinalIgnoreCase);
        }
    }
    
    public Encoding Encoding => GetEncodingFromCharset(GetParameter("charset"));                
    private static Encoding GetEncodingFromCharset(StringSegment charset)
    {
        if (charset.Equals("utf-8", StringComparison.OrdinalIgnoreCase))
        {
            // This is an optimization for utf-8 that prevents the Substring caused by
            // charset.Value
            return Encoding.UTF8;
        }
        
        try
        {
            // charset.Value might be an invalid encoding name as in charset=invalid.
            // For that reason, we catch the exception thrown by Encoding.GetEncoding
            // and return null instead.
            return charset.HasValue ? Encoding.GetEncoding(charset.Value) : null;
        }
        catch (Exception)
        {
            return null;
        }
    }
    
    public StringSegment Charset => GetParameter("charset");
    
    public MediaType(string mediaType) : 
    	this(mediaType, 0, mediaType.Length)
    {
    }
        
    public MediaType(StringSegment mediaType) : 
    	this(mediaType.Buffer, mediaType.Offset, mediaType.Length)
    {
    }
        
    public MediaType(string mediaType, int offset, int? length)
    {
        if (mediaType == null)
        {
            throw new ArgumentNullException(nameof(mediaType));
        }        
        if (offset < 0 || offset >= mediaType.Length)
        {
            throw new ArgumentOutOfRangeException(nameof(offset));
        }        
        if (length != null)
        {
            if(length < 0 || length > mediaType.Length)
            {
                throw new ArgumentOutOfRangeException(nameof(length));
            }
            
            if (offset > mediaType.Length - length)
            {
                throw new ArgumentException(
                    Resources.FormatArgument_InvalidOffsetLength(
                        nameof(offset), 
                        nameof(length)));
            }
        }
        
        // 创建 default type parameter parser
        _parameterParser = default(MediaTypeParameterParser);
        
        /* 解析 media type */
        // 解析 media type (string) 长度、type
        var typeLength = GetTypeLength(
            mediaType, 
            offset, 
            out var type);
        // 如果 media type (string) 长度为 0，创建。。。
        if (typeLength == 0)
        {
            Type = new StringSegment();
            SubType = new StringSegment();
            SubTypeWithoutSuffix = new StringSegment();
            SubTypeSuffix = new StringSegment();
            return;
        }
        // 否则，即 media type (string) 长度不为 0，赋值 type
        else
        {
            Type = type;
        }
        
        /* 解析 sub type */
        // 解析 sub type (string) 长度、sub type
        var subTypeLength = GetSubtypeLength(
            mediaType, 
            offset + typeLength, 
            out var subType);
        // 如果 sub type (string) 长度为 0，创建 。。。
        if (subTypeLength == 0)
        {
            SubType = new StringSegment();
            SubTypeWithoutSuffix = new StringSegment();
            SubTypeSuffix = new StringSegment();
            return;
        }
        // 否则，即 sub type (string) 长度不为 0，
        else
        {
            // 赋值 sub type
            SubType = subType;
            
            // 解析 suffix 
            if (TryGetSuffixLength(subType, out var subtypeSuffixLength))
            {
                SubTypeWithoutSuffix = subType.Subsegment(
                    0, 
                    subType.Length - subtypeSuffixLength - 1);
                
                SubTypeSuffix = subType.Subsegment(
                    subType.Length - subtypeSuffixLength, 
                    subtypeSuffixLength);
            }
            else
            {
                SubTypeWithoutSuffix = SubType;
                SubTypeSuffix = new StringSegment();
            }
        }
        
        // 创建 media type parameter parser
        _parameterParser = new MediaTypeParameterParser(
            mediaType, 
            offset + typeLength + subTypeLength, 
            length);
    }        
    
    // All GetXXXLength methods work in the same way. 
    // They expect to be on the right position for the token they are parsing, for example, the beginning of 
    // the media type or the delimiter from a previous token, like '/', ';' or '='.
    // Each method consumes the delimiter token if any, the leading whitespace, then the given token itself, 
    // and finally the trailing whitespace.
    private static int GetTypeLength(
        string input, 
        int offset, 
        out StringSegment type)
    {
        if (offset < 0 || 
            offset >= input.Length)
        {
            type = default(StringSegment);
            return 0;
        }
        
        var current = offset + HttpTokenParsingRules.GetWhitespaceLength(input, offset);
        
        // Parse the type, i.e. <type> in media type string "<type>/<subtype>; param1=value1; param2=value2"
        var typeLength = HttpTokenParsingRules.GetTokenLength(input, current);
        if (typeLength == 0)
        {
            type = default(StringSegment);
            return 0;
        }
        
        type = new StringSegment(input, current, typeLength);
        
        current += typeLength;
        current += HttpTokenParsingRules.GetWhitespaceLength(input, current);
        
        return current - offset;
    }
    
    private static int GetSubtypeLength(
        string input, 
        int offset, 
        out StringSegment subType)
    {
        var current = offset;
        
        // Parse the separator between type and subtype
        if (current < 0 || 
            current >= input.Length || 
            input[current] != '/')
        {
            subType = default(StringSegment);
            return 0;
        }
        
        current++; // skip delimiter.
        current +=  HttpTokenParsingRules.GetWhitespaceLength(input, current);
        
        var subtypeLength = HttpTokenParsingRules.GetTokenLength(input, current);
        if (subtypeLength == 0)
        {
            subType = default(StringSegment);
            return 0;
        }
        
        subType = new StringSegment(input, current, subtypeLength);
        
        current +=  subtypeLength;
        current +=  HttpTokenParsingRules.GetWhitespaceLength(input, current);
        
        return current - offset;
    }
    
    private static bool TryGetSuffixLength(
        StringSegment subType, 
        out int suffixLength)
    {
        // Find the last instance of '+', if there is one
        var startPos = subType.Offset + subType.Length - 1;
        for (var currentPos = startPos; currentPos >= subType.Offset; currentPos--)
        {
            if (subType.Buffer[currentPos] == '+')
            {
                suffixLength = startPos - currentPos;
                return true;
            }
        }
        
        suffixLength = 0;
        return false;
    }

    
    /* is sub set of ... */  
    public bool IsSubsetOf(MediaType set)
    {
        return MatchesType(set) &&
               MatchesSubtype(set) &&
               ContainsAllParameters(set._parameterParser);
    }    
                                       
    /* get parameter */
    public StringSegment GetParameter(string parameterName)
    {
        return GetParameter(new StringSegment(parameterName));
    }
       
    public StringSegment GetParameter(StringSegment parameterName)
    {
        var parametersParser = _parameterParser;
        
        while (parametersParser.ParseNextParameter(out var parameter))
        {
            if (parameter.HasName(parameterName))
            {
                return parameter.Value;
            }
        }
        
        return new StringSegment();
    }
    
    /* get encoding */
    public static Encoding GetEncoding(string mediaType)
    {
        return GetEncoding(new StringSegment(mediaType));
    }
        
    public static Encoding GetEncoding(StringSegment mediaType)
    {
        var parsedMediaType = new MediaType(mediaType);
        return parsedMediaType.Encoding;
    }
             
    /* replace encoding */
    public static string ReplaceEncoding(string mediaType, Encoding encoding)
    {
        return ReplaceEncoding(new StringSegment(mediaType), encoding);
    }
            
    public static string ReplaceEncoding(StringSegment mediaType, Encoding encoding)
    {
        var parsedMediaType = new MediaType(mediaType);
        var charset = parsedMediaType.GetParameter("charset");
        
        if (charset.HasValue && 
            charset.Equals(encoding.WebName, StringComparison.OrdinalIgnoreCase))
        {
            return mediaType.Value;
        }
        
        if (!charset.HasValue)
        {
            return CreateMediaTypeWithEncoding(mediaType, encoding);
        }
        
        var charsetOffset = charset.Offset - mediaType.Offset;
        var restOffset = charsetOffset + charset.Length;
        var restLength = mediaType.Length - restOffset;
        var finalLength = charsetOffset + encoding.WebName.Length + restLength;
        
        var builder = new StringBuilder(
            mediaType.Buffer, 
            mediaType.Offset, 
            charsetOffset, 
            finalLength);
        
        builder.Append(encoding.WebName);
        builder.Append(mediaType.Buffer, restOffset, restLength);
        
        return builder.ToString();
    }
          
    
    
    
        
    private static string CreateMediaTypeWithEncoding(
        StringSegment mediaType, 
        Encoding encoding)
    {
        return $"{mediaType.Value}; charset={encoding.WebName}";
    }
    
    private bool MatchesType(MediaType set)
    {
        return set.MatchesAllTypes ||
               set.Type.Equals(Type, StringComparison.OrdinalIgnoreCase);
    }
    
    private bool MatchesSubtype(MediaType set)
    {
        if (set.MatchesAllSubTypes)
        {
            return true;
        }
        
        if (set.SubTypeSuffix.HasValue)
        {
            if (SubTypeSuffix.HasValue)
            {
                // Both the set and the media type being checked have suffixes, so both parts must match.
                return MatchesSubtypeWithoutSuffix(set) && MatchesSubtypeSuffix(set);
            }
            else
            {
                // The set has a suffix, but the media type being checked doesn't. 
                // We never consider this to match.
                return false;
            }
        }
        else
        {
            // If this subtype or suffix matches the subtype of the set, it is considered a subtype.
            // Ex: application/json > application/val+json
            return MatchesEitherSubtypeOrSuffix(set);
        }
    }
    
    private bool MatchesSubtypeWithoutSuffix(MediaType set)
    {
        return set.MatchesAllSubTypesWithoutSuffix ||
               set.SubTypeWithoutSuffix.Equals(
            		SubTypeWithoutSuffix, 
		            StringComparison.OrdinalIgnoreCase);
    }
    
    private bool MatchesSubtypeSuffix(MediaType set)
    {
        // We don't have support for wildcards on suffixes alone (e.g., "application/entity+*")
        // because there's no clear use case for it.
        return set.SubTypeSuffix.Equals(SubTypeSuffix, StringComparison.OrdinalIgnoreCase);
    }
    
    private bool MatchesEitherSubtypeOrSuffix(MediaType set)
    {
        return set.SubType.Equals(SubType, StringComparison.OrdinalIgnoreCase) ||
               set.SubType.Equals(SubTypeSuffix, StringComparison.OrdinalIgnoreCase);
    }
    
    private bool ContainsAllParameters(MediaTypeParameterParser setParameters)
    {
        var parameterFound = true;
        while (setParameters.ParseNextParameter(out var setParameter) && parameterFound)
        {
            if (setParameter.HasName("q"))
            {
                // "q" and later parameters are not involved in media type matching. 
                // Quoting the RFC: The first "q" parameter (if any) separates the 
                // media-range parameter(s) from the accept-params.
                break;
            }
            
            if (setParameter.HasName("*"))
            {
                // A parameter named "*" has no effect on media type matching, 
                // as it is only used as an indication that the entire media type string 
                // should be treated as a wildcard.
                continue;
            }
            
            // Copy the parser as we need to iterate multiple times over it.
            // We can do this because it's a struct
            var subSetParameters = _parameterParser;
            parameterFound = false;
            while (subSetParameters.ParseNextParameter(out var subSetParameter) && 
                   !parameterFound)
            {
                parameterFound = subSetParameter.Equals(setParameter);
            }
        }
        
        return parameterFound;
    }                
}

```

###### 4.1.1.1 media type parameter & parser

```c#
public readonly struct MediaType
{
    // media type parameter
    private readonly struct MediaTypeParameter : IEquatable<MediaTypeParameter>
    {
        public StringSegment Name { get; }    
        public StringSegment Value { get; }
        
        public MediaTypeParameter(StringSegment name, StringSegment value)
        {
            Name = name;
            Value = value;
        }
                        
        public bool HasName(string name)
        {
            return HasName(new StringSegment(name));
        }
        
        public bool HasName(StringSegment name)
        {
            return Name.Equals(name, StringComparison.OrdinalIgnoreCase);
        }
        
        public bool Equals(MediaTypeParameter other)
        {
            return HasName(other.Name) && 
                   Value.Equals(other.Value, StringComparison.OrdinalIgnoreCase);
        }
        
        public override string ToString() => $"{Name}={Value}";
    }
    
    // media type parameter parser
    private struct MediaTypeParameterParser
    {
        private readonly string _mediaTypeBuffer;
        private readonly int? _length;
        
        public int CurrentOffset { get; private set; }        
        public bool ParsingFailed { get; private set; }
        
        public MediaTypeParameterParser(
            string mediaTypeBuffer, 
            int offset, 
            int? length)
        {
            _mediaTypeBuffer = mediaTypeBuffer;
            _length = length;
            CurrentOffset = offset;
            ParsingFailed = false;
        }
                        
        public bool ParseNextParameter(out MediaTypeParameter result)
        {
            if (_mediaTypeBuffer == null)
            {
                ParsingFailed = true;
                result = default(MediaTypeParameter);
                return false;
            }
            
            var parameterLength = GetParameterLength(
                _mediaTypeBuffer, 
                CurrentOffset, 
                out result);
            
            CurrentOffset +=  parameterLength;
            
            if (parameterLength == 0)
            {
                ParsingFailed = _length != null && CurrentOffset < _length;
                return false;
            }
            
            return true;
        }
        
        private static int GetParameterLength(
            string input, 
            int startIndex, 
            out MediaTypeParameter parsedValue)
        {
            if (OffsetIsOutOfRange(startIndex, input.Length) || 
                input[startIndex] != ';')
            {
                parsedValue = default(MediaTypeParameter);
                return 0;
            }
            
            var nameLength = GetNameLength(input, startIndex, out var name);            
            var current = startIndex + nameLength;
            
            if (nameLength == 0 || 
                OffsetIsOutOfRange(current, input.Length) || 
                input[current] != '=')
            {
                if (current == input.Length && 
                    name.Equals("*", StringComparison.OrdinalIgnoreCase))
                {
                    // As a special case, we allow a trailing ";*" to indicate a wildcard string allowing any other parameters. 
                    // It's the same as ";*=*".
                    var asterisk = new StringSegment("*");
                    parsedValue = new MediaTypeParameter(asterisk, asterisk);
                    return current - startIndex;
                }
                else
                {
                    parsedValue = default(MediaTypeParameter);
                    return 0;
                }
            }
            
            var valueLength = GetValueLength(input, current, out var value);
            
            parsedValue = new MediaTypeParameter(name, value);
            current +=  valueLength;
            
            return current - startIndex;
        }
        
        private static int GetNameLength(
            string input, 
            int startIndex, 
            out StringSegment name)
        {
            var current = startIndex;
            
            current++; // skip ';'
            current +=  HttpTokenParsingRules.GetWhitespaceLength(input, current);
            
            var nameLength = HttpTokenParsingRules.GetTokenLength(input, current);
            if (nameLength == 0)
            {
                name = default(StringSegment);
                return 0;
            }
            
            name = new StringSegment(input, current, nameLength);
            
            current +=  nameLength;
            current +=  HttpTokenParsingRules.GetWhitespaceLength(input, current);
            
            return current - startIndex;
        }
        
        private static int GetValueLength(
            string input, 
            int startIndex, 
            out StringSegment value)
        {
            var current = startIndex;
            
            current++; // skip '='.
            current +=  HttpTokenParsingRules.GetWhitespaceLength(input, current);
            
            var valueLength = HttpTokenParsingRules.GetTokenLength(input, current);
            
            if (valueLength == 0)
            {
                // A value can either be a token or a quoted string. 
                // Check if it is a quoted string.
                var result = HttpTokenParsingRules.GetQuotedStringLength(
                    input, 
                    current, 
                    out valueLength);
                
                if (result != HttpParseResult.Parsed)
                {
                    // We have an invalid value. Reset the name and return.
                    value = default(StringSegment);
                    return 0;
                }
                
                // Quotation marks are not part of a quoted parameter value.
                value = new StringSegment(input, current + 1, valueLength - 2);
            }
            else
            {
                value = new StringSegment(input, current, valueLength);
            }
            
            current +=  valueLength;
            current +=  HttpTokenParsingRules.GetWhitespaceLength(input, current);
            
            return current - startIndex;
        }
        
        private static bool OffsetIsOutOfRange(int offset, int length)
        {
            return offset < 0 || offset >= length;
        }
    }
}

```

###### 4.1.1.2 http token parsing rules

```c#
internal static class HttpTokenParsingRules
{
    private static readonly bool[] TokenChars;
    private const int MaxNestedCount = 5;
    
    internal const char CR = '\r';
    internal const char LF = '\n';
    internal const char SP = ' ';
    internal const char Tab = '\t';
    internal const int MaxInt64Digits = 19;
    internal const int MaxInt32Digits = 10;
    
    // iso-8859-1, Western European (ISO)
    internal static readonly Encoding DefaultHttpEncoding = Encoding.GetEncoding(28591);
    
    static HttpTokenParsingRules()
    {
        // token = 1*<any CHAR except CTLs or separators>
        // CTL = <any US-ASCII control character (octets 0 - 31) and DEL (127)>
        
        TokenChars = new bool[128]; // everything is false
        
        for (int i = 33; i < 127; i++) // skip Space (32) & DEL (127)
        {
            TokenChars[i] = true;
        }
        
        // remove separators: these are not valid token characters
        TokenChars[(byte)'('] = false;
        TokenChars[(byte)')'] = false;
        TokenChars[(byte)'<'] = false;
        TokenChars[(byte)'>'] = false;
        TokenChars[(byte)'@'] = false;
        TokenChars[(byte)','] = false;
        TokenChars[(byte)';'] = false;
        TokenChars[(byte)':'] = false;
        TokenChars[(byte)'\\'] = false;
        TokenChars[(byte)'"'] = false;
        TokenChars[(byte)'/'] = false;
        TokenChars[(byte)'['] = false;
        TokenChars[(byte)']'] = false;
        TokenChars[(byte)'?'] = false;
        TokenChars[(byte)'='] = false;
        TokenChars[(byte)'{'] = false;
        TokenChars[(byte)'}'] = false;
    }
    
    internal static bool IsTokenChar(char character)
    {
        // Must be between 'space' (32) and 'DEL' (127)
        if (character > 127)
        {
            return false;
        }
        
        return TokenChars[character];
    }
    
    internal static int GetTokenLength(string input, int startIndex)
    {
        Debug.Assert(input != null);
        
        if (startIndex >= input.Length)
        {
            return 0;
        }
        
        var current = startIndex;
        
        while (current < input.Length)
        {
            if (!IsTokenChar(input[current]))
            {
                return current - startIndex;
            }
            current++;
        }
        return input.Length - startIndex;
    }
    
    internal static int GetWhitespaceLength(string input, int startIndex)
    {
        Debug.Assert(input != null);
        
        if (startIndex >= input.Length)
        {
            return 0;
        }
        
        var current = startIndex;
        
        while (current < input.Length)
        {
            var c = input[current];
            
            if ((c == SP) || (c == Tab))
            {
                current++;
                continue;
            }
            
            if (c == CR)
            {
                // If we have a #13 char, it must be followed by #10 and then at least one SP or HT.
                if ((current + 2 < input.Length) && (input[current + 1] == LF))
                {
                    char spaceOrTab = input[current + 2];
                    if ((spaceOrTab == SP) || (spaceOrTab == Tab))
                    {
                        current += 3;
                        continue;
                    }
                }
            }
            
            return current - startIndex;
        }
        
        // All characters between startIndex and the end of the string are LWS characters.
        return input.Length - startIndex;
    }
    
    internal static HttpParseResult GetQuotedStringLength(string input, int startIndex, out int length)
    {
        var nestedCount = 0;
        return GetExpressionLength(input, startIndex, '"', '"', false, ref nestedCount, out length);
    }
    
    // quoted-pair = "\" CHAR
    // CHAR = <any US-ASCII character (octets 0 - 127)>
    internal static HttpParseResult GetQuotedPairLength(string input, int startIndex, out int length)
    {
        Debug.Assert(input != null);
        Debug.Assert((startIndex >= 0) && (startIndex < input.Length));
        
        length = 0;
        
        if (input[startIndex] != '\\')
        {
            return HttpParseResult.NotParsed;
        }
        
        // Quoted-char has 2 characters. Check whether there are 2 chars left ('\' + char)
        // If so, check whether the character is in the range 0-127. If not, it's an invalid value.
        if ((startIndex + 2 > input.Length) || (input[startIndex + 1] > 127))
        {
            return HttpParseResult.InvalidFormat;
        }
        
        // We don't care what the char next to '\' is.
        length = 2;
        return HttpParseResult.Parsed;
    }
    
    // TEXT = <any OCTET except CTLs, but including LWS>
    // LWS = [CRLF] 1*( SP | HT )
    // CTL = <any US-ASCII control character (octets 0 - 31) and DEL (127)>
    //
    // Since we don't really care about the content of a quoted string or comment, we're more tolerant and
    // allow these characters. We only want to find the delimiters ('"' for quoted string and '(', ')' for comment).
    //
    // 'nestedCount': Comments can be nested. We allow a depth of up to 5 nested comments, i.e. something like
    // "(((((comment)))))". If we wouldn't define a limit an attacker could send a comment with hundreds of nested
    // comments, resulting in a stack overflow exception. In addition having more than 1 nested comment (if any)
    // is unusual.
    private static HttpParseResult GetExpressionLength(
        string input,
        int startIndex,
        char openChar,
        char closeChar,
        bool supportsNesting,
        ref int nestedCount,
        out int length)
    {
        Debug.Assert(input != null);
        Debug.Assert((startIndex >= 0) && (startIndex < input.Length));
        
        length = 0;
        
        if (input[startIndex] != openChar)
        {
            return HttpParseResult.NotParsed;
        }
        
        var current = startIndex + 1; // Start parsing with the character next to the first open-char
        while (current < input.Length)
        {
            // Only check whether we have a quoted char, if we have at least 3 characters left to read (i.e.
            // quoted char + closing char). Otherwise the closing char may be considered part of the quoted char.
            if ((current + 2 < input.Length) &&
                (GetQuotedPairLength(input, current, out var quotedPairLength) == HttpParseResult.Parsed))
            {
                // We ignore invalid quoted-pairs. Invalid quoted-pairs may mean that it looked like a quoted pair,
                // but we actually have a quoted-string: e.g. "\ü" ('\' followed by a char >127 - quoted-pair only
                // allows ASCII chars after '\'; qdtext allows both '\' and >127 chars).
                current = current + quotedPairLength;
                continue;
            }
            
            // If we support nested expressions and we find an open-char, then parse the nested expressions.
            if (supportsNesting && (input[current] == openChar))
            {
                nestedCount++;
                try
                {
                    // Check if we exceeded the number of nested calls.
                    if (nestedCount > MaxNestedCount)
                    {
                        return HttpParseResult.InvalidFormat;
                    }
                    
                    var nestedResult = GetExpressionLength(
                        input,
                        current,
                        openChar,
                        closeChar,
                        supportsNesting,
                        ref nestedCount,
                        out var nestedLength);
                    
                    switch (nestedResult)
                    {
                        case HttpParseResult.Parsed:
                            // add the length of the nested expression and continue.
                            current += nestedLength; 
                            break;
                            
                        case HttpParseResult.NotParsed:
                            Debug.Fail("'NotParsed' is unexpected: We started nested expression " +
                                       "parsing, because we found the open-char. So either it's a valid nested " +
                                       "expression or it has invalid format.");
                            break;
                            
                        case HttpParseResult.InvalidFormat:
                            // If the nested expression is invalid, we can't continue, so we fail with invalid format.
                            return HttpParseResult.InvalidFormat;
                            
                        default:
                            Debug.Fail("Unknown enum result: " + nestedResult);
                            break;
                    }
                }
                finally
                {
                    nestedCount--;
                }
            }
            
            if (input[current] == closeChar)
            {
                length = current - startIndex + 1;
                return HttpParseResult.Parsed;
            }
            current++;
        }
        
        // We didn't see the final quote, therefore we have an invalid expression string.
        return HttpParseResult.InvalidFormat;
    }
}

```

###### 4.1.1.3 http parse result

```c#
internal enum HttpParseResult
{
    Parsed,
    NotParsed,
    InvalidFormat,
}

```

###### 4.1.1.4 media type segment with quality

```c#
public readonly struct MediaTypeSegmentWithQuality
{
    public StringSegment MediaType { get; }
    public double Quality { get; }
    
    public MediaTypeSegmentWithQuality(StringSegment mediaType, double quality)
    {
        MediaType = mediaType;
        Quality = quality;
    }
    
    public override string ToString()
    {
        // For logging purposes
        return MediaType.ToString();
    }
}

public readonly struct MediaType
{
    public static MediaTypeSegmentWithQuality CreateMediaTypeSegmentWithQuality(
        string mediaType, 
        int start)
    {
        var parsedMediaType = new MediaType(mediaType, start, length: null);
        
        // Short-circuit use of the MediaTypeParameterParser if constructor detected an invalid type or subtype.
        // Parser would set ParsingFailed==true in this case. 
        // But, we handle invalid parameters as a separate case.
        if (parsedMediaType.Type.Equals(default(StringSegment)) ||
            parsedMediaType.SubType.Equals(default(StringSegment)))
        {
            return default(MediaTypeSegmentWithQuality);
        }
        
        var parser = parsedMediaType._parameterParser;
        
        var quality = 1.0d;
        while (parser.ParseNextParameter(out var parameter))
        {
            if (parameter.HasName(QualityParameter))
            {
                // If media type contains two `q` values i.e. it's invalid in an uncommon way, pick last value.
                quality = double.Parse(
                    parameter.Value.Value, 
                    NumberStyles.AllowDecimalPoint,
                    NumberFormatInfo.InvariantInfo);
            }
        }
        
        // We check if the parsed media type has a value at this stage when we have iterated
        // over all the parameters and we know if the parsing was successful.
        if (parser.ParsingFailed)
        {
            return default(MediaTypeSegmentWithQuality);
        }
        
        return new MediaTypeSegmentWithQuality(
            new StringSegment(mediaType, start, parser.CurrentOffset - start),
            quality);
    }
}

```

##### 4.1.2 media type collection

```c#
public class MediaTypeCollection : Collection<string>
{       
    public void Add(MediaTypeHeaderValue item)
    {
        if (item == null)
        {
            throw new ArgumentNullException(nameof(item));            
        }
        
        Add(item.ToString());
    }
       
    public void Insert(int index, MediaTypeHeaderValue item)
    {
        if (index < 0 || index > Count)
        {
            throw new ArgumentOutOfRangeException(nameof(index));
        }        
        if (item == null)
        {
            throw new ArgumentNullException(nameof(item));
        }
        
        Insert(index, item.ToString());
    }
           
    public bool Remove(MediaTypeHeaderValue item)
    {
        if (item == null)
        {
            throw new ArgumentNullException(nameof(item));
        }
        
        return Remove(item.ToString());
    }
}

```

###### 4.1.2.1 media type header value

```c#
internal static class MediaTypeHeaderValues
{
    public static readonly MediaTypeHeaderValue ApplicationJson = 
        MediaTypeHeaderValue.Parse("application/json").CopyAsReadOnly();
    
    public static readonly MediaTypeHeaderValue TextJson = 
        MediaTypeHeaderValue.Parse("text/json").CopyAsReadOnly();
    
    public static readonly MediaTypeHeaderValue ApplicationAnyJsonSyntax =
        MediaTypeHeaderValue.Parse("application/*+json").CopyAsReadOnly();
    
    public static readonly MediaTypeHeaderValue ApplicationXml = 
        MediaTypeHeaderValue.Parse("application/xml").CopyAsReadOnly();
    
    public static readonly MediaTypeHeaderValue TextXml = 
        MediaTypeHeaderValue.Parse("text/xml").CopyAsReadOnly();
    
    public static readonly MediaTypeHeaderValue ApplicationAnyXmlSyntax =
        MediaTypeHeaderValue.Parse("application/*+xml").CopyAsReadOnly();
}

```

#### 4.2 input formatter

##### 4.2.1 接口

```c#
public interface IInputFormatter
{    
    bool CanRead(InputFormatterContext context);        
    Task<InputFormatterResult> ReadAsync(InputFormatterContext context);
}

```

###### 4.2.1.1 input formatter context

```c#
public class InputFormatterContext
{
    public bool TreatEmptyInputAsDefaultValue { get; }        
    public HttpContext HttpContext { get; }       
    public string ModelName { get; }       
    public ModelStateDictionary ModelState { get; }       
    public ModelMetadata Metadata { get; }        
    public Type ModelType { get; }        
    public Func<Stream, Encoding, TextReader> ReaderFactory { get; }
    
    public InputFormatterContext(
        HttpContext httpContext,
        string modelName,
        ModelStateDictionary modelState,
        ModelMetadata metadata,        
        Func<Stream, Encoding, TextReader> readerFactory)
            : this(
                httpContext, 
                modelName, 
                modelState, 
                metadata, 
                readerFactory, 
                treatEmptyInputAsDefaultValue: false)
    {
    }
       
    public InputFormatterContext(
        HttpContext httpContext,
        string modelName,
        ModelStateDictionary modelState,
        ModelMetadata metadata,
        Func<Stream, Encoding, TextReader> readerFactory,
        bool treatEmptyInputAsDefaultValue)
    {
        if (httpContext == null)
        {
            throw new ArgumentNullException(nameof(httpContext));
        }        
        if (modelName == null)
        {
            throw new ArgumentNullException(nameof(modelName));
        }        
        if (modelState == null)
        {
            throw new ArgumentNullException(nameof(modelState));
        }        
        if (metadata == null)
        {
            throw new ArgumentNullException(nameof(metadata));
        }        
        if (readerFactory == null)
        {
            throw new ArgumentNullException(nameof(readerFactory));
        }
        
        HttpContext = httpContext;
        ModelName = modelName;
        ModelState = modelState;
        Metadata = metadata;
        ReaderFactory = readerFactory;
        TreatEmptyInputAsDefaultValue = treatEmptyInputAsDefaultValue;
        ModelType = metadata.ModelType;
    }                
}

```

##### 4.2.2 抽象基类

```c#
public abstract class InputFormatter : 
	IInputFormatter, 
	IApiRequestFormatMetadataProvider
{        
    public MediaTypeCollection SupportedMediaTypes { get; } = new MediaTypeCollection();

    /* can read */
    
    /// <inheritdoc />
    public virtual bool CanRead(InputFormatterContext context)
    {
        if (SupportedMediaTypes.Count == 0)
        {
            var message = 
                Resources.FormatFormatter_NoMediaTypes(
	                GetType().FullName,                    
    	            nameof(SupportedMediaTypes));
            
            throw new InvalidOperationException(message);
        }
        
        // can read type 方法，在派生类中重写
        if (!CanReadType(context.ModelType))
        {
            return false;
        }
        
        // 解析 content type
        var contentType = context.HttpContext.Request.ContentType;
        if (string.IsNullOrEmpty(contentType))
        {
            return false;
        }
        
        // Confirm the request's content type is more specific than 
        // a media type this formatter supports e.g. OK if
        // client sent "text/plain" data and this formatter supports "text/*".
        return IsSubsetOfAnySupportedContentType(contentType);
    }
           
    private bool IsSubsetOfAnySupportedContentType(string contentType)
    {
        // 由 content type 创建 media type
        var parsedContentType = new MediaType(contentType);
        // 通过 media type 的方法判断 content type 是否 supported media type 的子集
        for (var i = 0; i < SupportedMediaTypes.Count; i++)
        {
            var supportedMediaType = new MediaType(SupportedMediaTypes[i]);
            if (parsedContentType.IsSubsetOf(supportedMediaType))
            {
                return true;
            }
        }
        return false;
    }
    
     protected virtual bool CanReadType(Type type)
    {
        return true;
    }
    
    /* read async */
    
    /// <inheritdoc />
    public virtual Task<InputFormatterResult> ReadAsync(InputFormatterContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        // 解析 http request
        var request = context.HttpContext.Request;
        
        // 如果 request 为 empty，创建...
        if (request.ContentLength == 0)
        {
            if (context.TreatEmptyInputAsDefaultValue)
            {
                return InputFormatterResult
                    .SuccessAsync(GetDefaultValueForType(context.ModelType));
            }
            
            return InputFormatterResult.NoValueAsync();
        }
        
        // 调用具体方法，在派生类中实现
        return ReadRequestBodyAsync(context);
    }
        
    protected virtual object GetDefaultValueForType(Type modelType)
    {
        if (modelType == null)            
        {
            throw new ArgumentNullException(nameof(modelType));
        }        
        if (modelType.IsValueType)
        {
            return Activator.CreateInstance(modelType);
        }
        
        return null;
    }                              
        
    // 在派生类实现具体 read 方法，
    // 结果封装为 input format result（model是最终绑定结果）
    public abstract Task<InputFormatterResult> ReadRequestBodyAsync(
        InputFormatterContext context);
                  
    /* get supported content type */
    
    /// <inheritdoc />
    public virtual IReadOnlyList<string> GetSupportedContentTypes(
        string contentType, 
        Type objectType)
    {
        if (SupportedMediaTypes.Count == 0)
        {
            var message = Resources.FormatFormatter_NoMediaTypes(
                GetType().FullName,
                nameof(SupportedMediaTypes));
            
            throw new InvalidOperationException(message);
        }
        
        if (!CanReadType(objectType))
        {
            return null;
        }
        
        // 如果 content type 为 null，即 request 没有指定 content type，
        // 所有 formatter 支持的 media type 都是 valid
        if (contentType == null)
        {
            // If contentType is null, then any type we support is valid.
            return SupportedMediaTypes;
        }
        else
        {
            // 由 content type 创建 media type
            var parsedContentType = new MediaType(contentType);
            
            List<string> mediaTypes = null;
            
            // Confirm this formatter supports a more specific media type than 
            // requested e.g. OK if "text/*" requested and formatter supports "text/plain". 
            // Treat contentType like it came from an Content-Type header.
            foreach (var mediaType in SupportedMediaTypes)
            {
                var parsedMediaType = new MediaType(mediaType);
                /* 通过 media type 的方法判断，
                   如果 content type 是 supported type 的子集，
                   将 content type 添加到 supported media type */
                if (parsedMediaType.IsSubsetOf(parsedContentType))
                {
                    if (mediaTypes == null)
                    {
                        mediaTypes = new List<string>(SupportedMediaTypes.Count);
                    }
                    
                    mediaTypes.Add(mediaType);
                }
            }
            
            return mediaTypes;
        }
    }                    
}

```

###### 4.2.2.1 input formatter result

```c#
public class InputFormatterResult
{
    public bool HasError { get; }        
    public bool IsModelSet { get; }        
    public object? Model { get; }
    
     private InputFormatterResult(object model)
    {
        Model = model;
        IsModelSet = true;
    }
    
    private InputFormatterResult(bool hasError)
    {
        HasError = hasError;
    }
       
    /* for static success instance */
    public static InputFormatterResult Success(object model)
    {
        return new InputFormatterResult(model);
    }
        
    public static Task<InputFormatterResult> SuccessAsync(object model)
    {
        return Task.FromResult(Success(model));
    }
        
    /* for static failure instance */
    private static readonly InputFormatterResult _failure = 
        new InputFormatterResult(hasError: true);
            
    public static InputFormatterResult Failure()        
    {
        return _failure;
    }
    
    private static readonly Task<InputFormatterResult> _failureAsync = 
        Task.FromResult(_failure);
           
    public static Task<InputFormatterResult> FailureAsync()
    {
        return _failureAsync;
    }
    
    /* for static no value instance */    
    private static readonly InputFormatterResult _noValue = 
        new InputFormatterResult(hasError: false);
    
    public static InputFormatterResult NoValue()
    {
        return _noValue;
    }
        
    private static readonly Task<InputFormatterResult> _noValueAsync = 
        Task.FromResult(_noValue);

    public static Task<InputFormatterResult> NoValueAsync()
    {
        return _noValueAsync;
    }    
}

```

##### 4.2.3 text input formatter

```c#
public abstract class TextInputFormatter : InputFormatter
{       
    protected static readonly Encoding UTF8EncodingWithoutBOM = 
        new UTF8Encoding(
        		encoderShouldEmitUTF8Identifier: false, 
        		throwOnInvalidBytes: true);
       
    protected static readonly Encoding UTF16EncodingLittleEndian = 
        new UnicodeEncoding(
        		bigEndian: false, 
        		byteOrderMark: true, 
        		throwOnInvalidBytes: true);
        
    public IList<Encoding> SupportedEncodings { get; } = new List<Encoding>();

    /// <inheritdoc />
    public override Task<InputFormatterResult> ReadRequestBodyAsync(
        InputFormatterContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        // 解析 encoding
        var selectedEncoding = SelectCharacterEncoding(context);
        // 如果 encoding 为 null，抛出异常
        if (selectedEncoding == null)
        {
            var message = Resources.FormatUnsupportedContentType(
                context.HttpContext.Request.ContentType);            
            var exception = new UnsupportedContentTypeException(message);
            
            context.ModelState
                   .AddModelError(
                		context.ModelName, 
                		exception, 
                		context.Metadata);
            
            return InputFormatterResult.FailureAsync();
        }
        // 使用具体 read body 方法，在派生类中实现
        return ReadRequestBodyAsync(context, selectedEncoding);
    }                            
    
    // 解析 encoding
    protected Encoding SelectCharacterEncoding(InputFormatterContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (SupportedEncodings.Count == 0)
        {
            var message = 
                Resources.FormatTextInputFormatter_SupportedEncodingsMustNotBeEmpty(
                    nameof(SupportedEncodings));            
            throw new InvalidOperationException(message);
        }
        
        /* 解析 content type 对应的 media type */
        var requestContentType = context.HttpContext.Request.ContentType;
        var requestMediaType = string.IsNullOrEmpty(requestContentType) 
            					   ? default 
            					   : new MediaType(requestContentType);
        
        /* 如果 media type 指定了 charset， */
        if (requestMediaType.Charset.HasValue)
        {
            /* 如果 supported encoding 中存在与 media encoding 同名的 encoding，
               返回该 encoding */
            // Create Encoding based on requestMediaType.Charset to support charset aliases 
            // and custom Encoding providers. Charset -> Encoding -> encoding.WebName chain 
            // canonicalizes the charset name.
            var requestEncoding = requestMediaType.Encoding;
            if (requestEncoding != null)
            {                
                for (int i = 0; i < SupportedEncodings.Count; i++)
                {
                    if (string.Equals(
                        	requestEncoding.WebName,
	                        SupportedEncodings[i].WebName,
    	                    StringComparison.OrdinalIgnoreCase))
                    {
                        return SupportedEncodings[i];
                    }
                }
            }
            /* 否则，即 supported encoding 中不存在同名 encoding，
               返回 null */            
            // The client specified an encoding in the content type header of the request
            // but we don't understand it. 
            // In this situation we don't try to pick any other encoding from the list of 
            // supported encodings and read the body with that encoding.
            // Instead, we return null and that will translate later on into a 415 Unsupported 
            // Media Type response.
            return null;        
        }
		
        /* media type 没有指定charset */
        // We want to do our best effort to read the body of the request even in the
        // cases where the client doesn't send a content type header or sends a content
        // type header without encoding. 
        // For that reason we pick the first encoding of the  list of supported encodings 
        // and try to use that to read the body. 
        // This encoding is UTF-8 by default in our formatters, which generally is a safe 
        // choice for the encoding.
        return SupportedEncodings[0];
    }
    
    // 在派生类中实现具体 read 方法
    public abstract Task<InputFormatterResult> ReadRequestBodyAsync(
        InputFormatterContext context,
        Encoding encoding);
}

```

###### 4.2.3.1 input formatter exception policy

```c#
public interface IInputFormatterExceptionPolicy
{   
    InputFormatterExceptionPolicy ExceptionPolicy { get; }
}

public enum InputFormatterExceptionPolicy
{     
    AllExceptions = 0,             
    MalformedInputExceptions = 1,
}

```

###### 4.2.3.2 system text json input formatter

```c#
public class SystemTextJsonInputFormatter : 
	TextInputFormatter, 
	IInputFormatterExceptionPolicy
{
    private readonly ILogger<SystemTextJsonInputFormatter> _logger;
     /// <inheritdoc />
    InputFormatterExceptionPolicy IInputFormatterExceptionPolicy.ExceptionPolicy => 
        InputFormatterExceptionPolicy.MalformedInputExceptions;
        
    public JsonSerializerOptions SerializerOptions { get; }
        
    public SystemTextJsonInputFormatter(
        JsonOptions options,
        ILogger<SystemTextJsonInputFormatter> logger)
    {
        /* 注入 options 和 logger */
        SerializerOptions = options.JsonSerializerOptions;
        _logger = logger;
        
        /* 添加 supported encoding */
        SupportedEncodings.Add(UTF8EncodingWithoutBOM);
        SupportedEncodings.Add(UTF16EncodingLittleEndian);
        
        /* 添加 supported media type*/
        SupportedMediaTypes.Add(MediaTypeHeaderValues.ApplicationJson);
        SupportedMediaTypes.Add(MediaTypeHeaderValues.TextJson);
        SupportedMediaTypes.Add(MediaTypeHeaderValues.ApplicationAnyJsonSyntax);
    }
           
    /* 实现 read body 方法 */
    /// <inheritdoc />
    public sealed override async Task<InputFormatterResult> ReadRequestBodyAsync(
        InputFormatterContext context,
        Encoding encoding)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (encoding == null)
        {
            throw new ArgumentNullException(nameof(encoding));
        }
        
        // 解析 http context
        var httpContext = context.HttpContext;
        // read 到 stream
        var (inputStream, usesTranscodingStream) = GetInputStream(httpContext, encoding);
        
        object model;
        
        try
        {
            // 逆序列化 stream 到 model
            model = await JsonSerializer.DeserializeAsync(
                							inputStream, 
                							context.ModelType, 
                							SerializerOptions);
        }
        catch (JsonException jsonException)
        {
            var path = jsonException.Path;
            
            var formatterException = 
                new InputFormatterException(jsonException.Message, jsonException);
            
            context.ModelState
                   .TryAddModelError(
                		path, 
                		formatterException, 
                		context.Metadata);
            
            Log.JsonInputException(_logger, jsonException);            
            return InputFormatterResult.Failure();
        }
        catch (Exception exception) when (exception is FormatException || 
                                          exception is OverflowException)
        {
            // The code in System.Text.Json never throws these exceptions. 
            // However a custom converter could produce these errors for instance when
            // parsing a value. 
            // These error messages are considered safe to report to users using ModelState.   
            context.ModelState
                   .TryAddModelError(
                		string.Empty, 
                		exception, 
                		context.Metadata);
            
            Log.JsonInputException(_logger, exception);            
            return InputFormatterResult.Failure();
        }
        finally
        {
            if (usesTranscodingStream)
            {
                await inputStream.DisposeAsync();
            }
        }
        
        /* model 为 null，且 no default value，
           返回 no value result */
        if (model == null && 
            !context.TreatEmptyInputAsDefaultValue)
        {
            // Some nonempty inputs might deserialize as null, for example whitespace,
            // or the JSON-encoded value "null". The upstream BodyModelBinder needs to
            // be notified that we don't regard this as a real input so it can register
            // a model binding error.
            return InputFormatterResult.NoValue();
        }
        /* model 不为 null，返回封装 model 的 formatter result */
        else
        {
            Log.JsonInputSuccess(_logger, context.ModelType);
            return InputFormatterResult.Success(model);
        }
    }
    
    // 读取 http request body 到 input stream
    private (Stream inputStream, bool usesTranscodingStream) 
        GetInputStream(HttpContext httpContext, Encoding encoding)
    {
        if (encoding.CodePage == Encoding.UTF8.CodePage)
        {
            return (httpContext.Request.Body, false);
        }
        
        var inputStream = Encoding.CreateTranscodingStream(
            						   httpContext.Request.Body, 
            						   encoding, 
            						   Encoding.UTF8, 
            						   leaveOpen: true);
        return (inputStream, true);
    }
    
    private static class Log
    {
        private static readonly Action<ILogger, string, Exception> 
            _jsonInputFormatterException;
        private static readonly Action<ILogger, string, Exception> 
            _jsonInputSuccess;
        
        static Log()
        {
            _jsonInputFormatterException = LoggerMessage.Define<string>(
                LogLevel.Debug,
                new EventId(1, "SystemTextJsonInputException"),
                "JSON input formatter threw an exception: {Message}");
            _jsonInputSuccess = LoggerMessage.Define<string>(
                LogLevel.Debug,
                new EventId(2, "SystemTextJsonInputSuccess"),
                "JSON input formatter succeeded, deserializing to type '{TypeName}'");
        }
        
        public static void JsonInputException(ILogger logger, Exception exception) 
            => _jsonInputFormatterException(logger, exception.Message, exception);
        
        public static void JsonInputSuccess(ILogger logger, Type modelType)
            => _jsonInputSuccess(logger, modelType.FullName, null);
    }
}

```

#### 4.3 output formatter

##### 4.3.1 接口

```c#
public interface IOutputFormatter
{        
    bool CanWriteResult(OutputFormatterCanWriteContext context); 
    Task WriteAsync(OutputFormatterWriteContext context);
}

```

###### 4.3.1.1 output formatter can write context

```c#
public abstract class OutputFormatterCanWriteContext
{
    public virtual HttpContext HttpContext { get; protected set; }        
    public virtual StringSegment ContentType { get; set; }        
    public virtual bool ContentTypeIsServerDefined { get; set; }       
    public virtual object? Object { get; protected set; }        
    public virtual Type? ObjectType { get; protected set; }
    
    protected OutputFormatterCanWriteContext(HttpContext httpContext)
    {
        if (httpContext == null)
        {
            throw new ArgumentNullException(nameof(httpContext));
        }
        
        HttpContext = httpContext;
    }                
}

```

###### 4.3.1.2 output formatter write context

```c#
public class OutputFormatterWriteContext : OutputFormatterCanWriteContext
{    
    // 创建 text write 的委托，
    // 创建的 text write 按照 encoding 写入 http response body
    public virtual Func<Stream, Encoding, TextWriter> WriterFactory { get; protected set; }
    
    public OutputFormatterWriteContext(
        HttpContext httpContext, 
        Func<Stream, Encoding, TextWriter> writerFactory, 
        Type? objectType, 
        object? @object)            
        	: base(httpContext)
    {
        if (writerFactory == null)
        {
            throw new ArgumentNullException(nameof(writerFactory));
        }
        
        WriterFactory = writerFactory;
        ObjectType = objectType;
        Object = @object;
    }        
}

```

##### 4.3.2 抽象基类

```c#
public abstract class OutputFormatter : 
	IOutputFormatter, 
	IApiResponseTypeMetadataProvider
{        
    public MediaTypeCollection SupportedMediaTypes { get; } = new MediaTypeCollection();
                
    /* can write result */
    
    /// <inheritdoc />
    public virtual bool CanWriteResult(OutputFormatterCanWriteContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (SupportedMediaTypes.Count == 0)
        {
            var message = Resources.FormatFormatter_NoMediaTypes(
                						GetType().FullName,
						                nameof(SupportedMediaTypes));
            
            throw new InvalidOperationException(message);
        }
        
        if (!CanWriteType(context.ObjectType))
        {
            return false;
        }
        
        /* 如果 content type 没有赋值，*/
        if (!context.ContentType.HasValue)
        {
            /* 将 supported media type 写入 content type，
               并返回 true */
            // If the desired content type is set to null, 
            // then the current formatter can write anything it wants.
            context.ContentType = new StringSegment(SupportedMediaTypes[0]);
            return true;
        }
        /* 否则，即 content type 指定了内容，*/
        else
        {
            /* 如果 content type 是 supported type 的子集，
               返回 true */
            var parsedContentType = new MediaType(context.ContentType);
            for (var i = 0; i < SupportedMediaTypes.Count; i++)
            {
                var supportedMediaType = new MediaType(SupportedMediaTypes[i]);
                if (supportedMediaType.HasWildcard)
                {
                    // For supported media types that are wildcard patterns, confirm that 
                    // the requested media type satisfies the wildcard pattern (e.g., 
                    // if "text/entity+json;v=2" requested and formatter supports 
                    // "text/*+json").
                    // We only do this when comparing against server-defined content types 
                    // (e.g., those from [Produces] or Response.ContentType), otherwise 
                    // we'd potentially be reflecting back arbitrary Accept header values.
                    if (context.ContentTypeIsServerDefined && 
                        parsedContentType.IsSubsetOf(supportedMediaType))
                    {
                        return true;
                    }
                }
                else
                {
                    // For supported media types that are not wildcard patterns, 
                    // confirm that this formatter supports a more specific media type 
                    // than requested e.g. OK if "text/*" requested and formatter supports 
                    // "text/plain".contentType is typically what we got in an Accept header.
                    if (supportedMediaType.IsSubsetOf(parsedContentType))
                    {
                        context.ContentType = new StringSegment(SupportedMediaTypes[i]);
                        return true;
                    }
                }
            }
        }
        
        return false;
    }
    
    /* write async */
    
    /// <inheritdoc />
    public virtual Task WriteAsync(OutputFormatterWriteContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        // 写入 header        
        WriteResponseHeaders(context);
        // 写入 body，在派生类中实现
        return WriteResponseBodyAsync(context);
    }
        
    public virtual void WriteResponseHeaders(OutputFormatterWriteContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        var response = context.HttpContext.Response;
        // 将 content type 写入 response
        response.ContentType = context.ContentType.Value;
    }
        
    // 在派生类中实现具体 write 方法
    public abstract Task WriteResponseBodyAsync(OutputFormatterWriteContext context);
        
    /* get supported content type */
    
    /// <inheritdoc />
    public virtual IReadOnlyList<string> GetSupportedContentTypes(
        string contentType,
        Type objectType)
    {
        if (SupportedMediaTypes.Count == 0)
        {
            var message = Resources.FormatFormatter_NoMediaTypes(
                GetType().FullName,
                nameof(SupportedMediaTypes));
            
            throw new InvalidOperationException(message);
        }
        
        if (!CanWriteType(objectType))
        {
            return null;
        }
        
        List<string> mediaTypes = null;
        
        // 解析 content type 对应的 media type
        var parsedContentType = contentType != null 
            						? new MediaType(contentType) 
            						: default(MediaType);
        
        // 如果 content type 是 supported media type 的子集，
        // 将 supported type 注入 media types
        foreach (var mediaType in SupportedMediaTypes)
        {
            var parsedMediaType = new MediaType(mediaType);
            if (parsedMediaType.HasWildcard)
            {
                // For supported media types that are wildcard patterns, confirm that the 
                // requested media type satisfies the wildcard pattern 
                // (e.g., if "text/entity+json;v=2" requested and formatter supports 
                // "text/*+json").
                // Treat contentType like it came from a [Produces] attribute.
                if (contentType != null && 
                    parsedContentType.IsSubsetOf(parsedMediaType))
                {
                    if (mediaTypes == null)
                    {
                        mediaTypes = new List<string>(SupportedMediaTypes.Count);
                    }
                    
                    mediaTypes.Add(contentType);
                }
            }
            else
            {
                // Confirm this formatter supports a more specific media type than 
                // requested e.g. OK if "text/*" requested and formatter supports "text/plain".
                // Treat contentType like it came from an Accept header.
                if (contentType == null || 
                    parsedMediaType.IsSubsetOf(parsedContentType))
                {
                    if (mediaTypes == null)
                    {
                        mediaTypes = new List<string>(SupportedMediaTypes.Count);
                    }
                    
                    mediaTypes.Add(mediaType);
                }
            }
        }
        
        // 返回结果
        return mediaTypes;
    }
    
    protected virtual bool CanWriteType(Type type)
    {
        return true;
    }
}

```

##### 4.3.3 text output formatter

```c#
public abstract class TextOutputFormatter : OutputFormatter
{
    private IDictionary<string, string> _outputMediaTypeCache;
    private IDictionary<string, string> OutputMediaTypeCache
    {
        get
        {
            if (_outputMediaTypeCache == null)
            {
                var cache = new Dictionary<string, string>();
                foreach (var mediaType in SupportedMediaTypes)
                {
                    cache.Add(
                        mediaType, 
                        MediaType.ReplaceEncoding(
                            		mediaType, 
                            		Encoding.UTF8));
                }

                // Safe race condition, worst case scenario we initialize the field 
                // multiple times with dictionaries containing the same values.
                _outputMediaTypeCache = cache;
            }
            
            return _outputMediaTypeCache;
        }
    }
    
    public IList<Encoding> SupportedEncodings { get; }
            
    protected TextOutputFormatter()
    {
        SupportedEncodings = new List<Encoding>();
    }
                                
    /// <inheritdoc />
    public override Task WriteAsync(OutputFormatterWriteContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        /* 解析 content type */
        var selectedMediaType = context.ContentType;
        // 如果 content type 没有 value
        if (!selectedMediaType.HasValue)
        {
            /* 将 supported media types[0] 作为 media type 注入到 content type */
            // If content type is not set then set it based on supported media types.
            if (SupportedEncodings.Count > 0)
            {
                selectedMediaType = new StringSegment(SupportedMediaTypes[0]);
            }
            /* 如果 supported encoding 为 null，抛出异常 */
            else
            {
                throw new InvalidOperationException(
                    Resources.FormatOutputFormatterNoMediaType(GetType().FullName));
            }
        }
        
        /* 解析 encoding */
        // a- select charset encoding
        var selectedEncoding = SelectCharacterEncoding(context);
        // 如果 encoding 不为 null，
        // 将 content type、encoding 做出 charset，注入 content type
        if (selectedEncoding != null)
        {
            // b- get media type with charset 
            // Override the content type value even if one already existed.
            var mediaTypeWithCharset = 
                GetMediaTypeWithCharset(
                	selectedMediaType.Value, 
                	selectedEncoding);
            selectedMediaType = new StringSegment(mediaTypeWithCharset);
        }
        // 否则，即 encoding 为 null，返回 406       
        else
        {
            var response = context.HttpContext.Response;
            response.StatusCode = StatusCodes.Status406NotAcceptable;
            return Task.CompletedTask;
        }
        
        context.ContentType = selectedMediaType;
        
        // 写入 header
        WriteResponseHeaders(context);
        // 写入 body，在派生类中实现
        return WriteResponseBodyAsync(context, selectedEncoding);
    }
    
    /// <inheritdoc />
    public sealed override Task WriteResponseBodyAsync(
        OutputFormatterWriteContext context)
    {
        var message = 
            Resources.FormatTextOutputFormatter_WriteResponseBodyAsyncNotSupported(
            	$"{nameof(WriteResponseBodyAsync)}({nameof(OutputFormatterWriteContext)})",
                nameof(TextOutputFormatter),
                $"{nameof(WriteResponseBodyAsync)}({nameof(OutputFormatterWriteContext)},
            	"{nameof(Encoding)})");

        throw new InvalidOperationException(message);
    }
            
    // 在派生类中实现具体的 body 写入方法
    public abstract Task WriteResponseBodyAsync(
        OutputFormatterWriteContext context, 
        Encoding selectedEncoding);
    
    /* a- 解析 accept charset（header value）*/
        
    public virtual Encoding SelectCharacterEncoding(OutputFormatterWriteContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (SupportedEncodings.Count == 0)
        {
            var message = Resources.FormatTextOutputFormatter_SupportedEncodingsMustNotBeEmpty(
                    nameof(SupportedEncodings));
            throw new InvalidOperationException(message);
        }
        
        // 解析 accept charset（header value）
        var acceptCharsetHeaderValues = GetAcceptCharsetHeaderValues(context);
        // 解析 accept charset 对应的 encoding
        var encoding = MatchAcceptCharacterEncoding(acceptCharsetHeaderValues);
        
        /* 如果 encoding 不为 null，返回 encoding */
        if (encoding != null)
        {
            return encoding;
        }
        /* 否则，即 encoding 为 null，
           返回 supported encoding 中找到与 content type charset 同名的 encoding */
        if (context.ContentType.HasValue)
        {
            var parsedContentType = new MediaType(context.ContentType);
            var contentTypeCharset = parsedContentType.Charset;
            if (contentTypeCharset.HasValue)
            {
                for (var i = 0; i < SupportedEncodings.Count; i++)
                {
                    var supportedEncoding = SupportedEncodings[i];
                    if (contentTypeCharset.Equals(
                        	supportedEncoding.WebName, 
                        	StringComparison.OrdinalIgnoreCase))
                    {
                        // This is supported.
                        return SupportedEncodings[i];
                    }
                }
            }
        }
        /* 如果没有同名 encoding，返回 encodings[0] */
        return SupportedEncodings[0];
    }
                    
    internal static IList<StringWithQualityHeaderValue> 
        GetAcceptCharsetHeaderValues(OutputFormatterWriteContext context)
    {
        var request = context.HttpContext.Request;
        if (StringWithQualityHeaderValue.TryParseList(
            	request.Headers[HeaderNames.AcceptCharset], 
            	out IList<StringWithQualityHeaderValue> result))
        {
            return result;
        }
        
        return Array.Empty<StringWithQualityHeaderValue>();
    }
        
    private Encoding MatchAcceptCharacterEncoding(
        IList<StringWithQualityHeaderValue> acceptCharsetHeaders)
    {
        if (acceptCharsetHeaders != null && 
            acceptCharsetHeaders.Count > 0)
        {
            var acceptValues = Sort(acceptCharsetHeaders);
            for (var i = 0; i < acceptValues.Count; i++)
            {
                var charset = acceptValues[i].Value;
                if (!StringSegment.IsNullOrEmpty(charset))
                {
                    for (var j = 0; j < SupportedEncodings.Count; j++)
                    {
                        var encoding = SupportedEncodings[j];
                        if (charset.Equals(
                            	encoding.WebName, 
                            	StringComparison.OrdinalIgnoreCase) ||
                            charset.Equals("*", StringComparison.Ordinal))
                        {
                            return encoding;
                        }
                    }
                }
            }
        }
        
        return null;
    }
    
    // There's no allocation-free way to sort an IList and we may have to filter anyway,
    // so we're going to have to live with the copy + insertion sort.
    private IList<StringWithQualityHeaderValue> 
        Sort(IList<StringWithQualityHeaderValue> values)
    {
        var sortNeeded = false;
        
        for (var i = 0; i < values.Count; i++)
        {
            var value = values[i];
            if (value.Quality == HeaderQuality.NoMatch)
            {
                // Exclude this one
            }
            else if (value.Quality != null)
            {
                sortNeeded = true;
            }
        }
        
        if (!sortNeeded)
        {
            return values;
        }
        
        var sorted = new List<StringWithQualityHeaderValue>();
        for (var i = 0; i < values.Count; i++)
        {
            var value = values[i];
            if (value.Quality == HeaderQuality.NoMatch)
            {
                // Exclude this one
            }
            else
            {
                // Doing an insertion sort.
                var position = sorted.BinarySearch(
                    				value, 
                    				StringWithQualityHeaderValueComparer.QualityComparer);     
                if (position >= 0)
                {
                    sorted.Insert(position + 1, value);
                }
                else
                {
                    sorted.Insert(~position, value);
                }
            }
        }
        
        // We want a descending sort, but BinarySearch does ascending
        sorted.Reverse();
        return sorted;
    }
    
    /* b- 解析 charset 对应的 encoding */
    private string GetMediaTypeWithCharset(
        			   string mediaType, 
        			   Encoding encoding)
    {
        if (string.Equals(
            	encoding.WebName, 
            	Encoding.UTF8.WebName, 
            	StringComparison.OrdinalIgnoreCase) &&
            OutputMediaTypeCache.ContainsKey(mediaType))
        {
            return OutputMediaTypeCache[mediaType];
        }
        
        return MediaType.ReplaceEncoding(mediaType, encoding);
    }                
}

```

###### 4.3.3.1 json options?

###### 4.3.3.2 system text json output formatter

```c#
public class SystemTextJsonOutputFormatter : TextOutputFormatter
{
    public JsonSerializerOptions SerializerOptions { get; }
    
    public SystemTextJsonOutputFormatter(JsonSerializerOptions jsonSerializerOptions)
    {
        /* 注入 serialize options */
        SerializerOptions = jsonSerializerOptions;
        
        /* 注入 support encodings */
        SupportedEncodings.Add(Encoding.UTF8);
        SupportedEncodings.Add(Encoding.Unicode);
        
        /* 注入 support media type */
        SupportedMediaTypes.Add(MediaTypeHeaderValues.ApplicationJson);
        SupportedMediaTypes.Add(MediaTypeHeaderValues.TextJson);
        SupportedMediaTypes.Add(MediaTypeHeaderValues.ApplicationAnyJsonSyntax);
    }
    
    // 实现 write body 方法
    /// <inheritdoc />
    public sealed override async Task WriteResponseBodyAsync(
        OutputFormatterWriteContext context, 
        Encoding selectedEncoding)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (selectedEncoding == null)
        {
            throw new ArgumentNullException(nameof(selectedEncoding));
        }
        
        var httpContext = context.HttpContext;
        
        // context.ObjectType reflects the declared model type when specified.
        // For polymorphic scenarios where the user declares a return type, but returns a 
        // derived type, we want to serialize all the properties on the derived type. 
        // This keeps parity with the behavior you get when the user does not declare 
        // the return type and with Json.Net at least at the top level.
        var objectType = context.Object
            					?.GetType() 
            					?? context.ObjectType 
            					?? typeof(object);
        
        // 解析 response（write）stream
        var responseStream = httpContext.Response.Body;
        
        /* 如果 encoding 是 utf8 */
        if (selectedEncoding.CodePage == Encoding.UTF8.CodePage)
        {
            // 序列化 object 并写入 response stream
            await JsonSerializer.SerializeAsync(
                					responseStream, 
                					context.Object, 
                					objectType, 
                					SerializerOptions);
            
            await responseStream.FlushAsync();
        }
        /* 否则，即不是 utf8 */
        else
        {
            // 创建 transcoding stream
            // JsonSerializer only emits UTF8 encoded output, but we need to write 
            // the response in the encoding specified by selectedEncoding
            var transcodingStream = 
                Encoding.CreateTranscodingStream(
                			httpContext.Response.Body, 
                			selectedEncoding, 
                			Encoding.UTF8, 
                			leaveOpen: true);
            
            ExceptionDispatchInfo exceptionDispatchInfo = null;
            
            // 序列化 object 并写入 transcoding stream
            try
            {
                await JsonSerializer.SerializeAsync(
                    					transcodingStream, 
                    					context.Object, 
                    					objectType, 
                    					SerializerOptions);
                
                await transcodingStream.FlushAsync();
            }
            catch (Exception ex)
            {
                // TranscodingStream may write to the inner stream as part of it's disposal.
                // We do not want this exception "ex" to be eclipsed by any exception 
                // encountered during the write. We will stash it and explicitly 
                // rethrow it during the finally block.
                exceptionDispatchInfo = ExceptionDispatchInfo.Capture(ex);
            }
            finally
            {
                try
                {
                    await transcodingStream.DisposeAsync();
                }
                catch when (exceptionDispatchInfo != null)
                {
                }
                
                exceptionDispatchInfo?.Throw();
            }
        }
    }
    
    /* 创建 json output formatter 的静态方法 */        
    internal static SystemTextJsonOutputFormatter CreateFormatter(JsonOptions jsonOptions)
    {
        var jsonSerializerOptions = jsonOptions.JsonSerializerOptions;
        
        if (jsonSerializerOptions.Encoder is null)
        {
            // If the user hasn't explicitly configured the encoder, 
            // use the less strict encoder that does not encode all non-ASCII characters.
            jsonSerializerOptions = new JsonSerializerOptions(jsonSerializerOptions)
            {
                Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping,
            };
        }
        
        return new SystemTextJsonOutputFormatter(jsonSerializerOptions);
    }                
}

```

###### 4.3.3.3 string context formatter

```c#
public class StringOutputFormatter : TextOutputFormatter
{    
    public StringOutputFormatter()
    {
        SupportedEncodings.Add(Encoding.UTF8);
        SupportedEncodings.Add(Encoding.Unicode);           
        SupportedMediaTypes.Add("text/plain");    
    }
    
    /// <inheritdoc/>
    public override bool CanWriteResult(OutputFormatterCanWriteContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        if (context.ObjectType == typeof(string) || 
            context.Object is string)
        {
            // Call into base to check if the current request's content type 
            // is a supported media type.
            return base.CanWriteResult(context);
        }
        
        return false;
    }
    
    /// <inheritdoc/>
    public override Task WriteResponseBodyAsync(
        OutputFormatterWriteContext context, 
        Encoding encoding)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (encoding == null)
        {
            throw new ArgumentNullException(nameof(encoding));
        }
        
        var valueAsString = (string)context.Object;
        
        if (string.IsNullOrEmpty(valueAsString))
        {
            return Task.CompletedTask;
        }
        
        var response = context.HttpContext.Response;
        return response.WriteAsync(valueAsString, encoding);
    }
}

```

##### 4.3.4 stream output formatter

```c#
public class StreamOutputFormatter : IOutputFormatter
{       
    /// <inheritdoc />
    public bool CanWriteResult(OutputFormatterCanWriteContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        // Ignore the passed in content type, if the object is a Stream.
        if (context.Object is Stream)
        {
            return true;
        }
        
        return false;
    }
    
    /// <inheritdoc />
    public async Task WriteAsync(OutputFormatterWriteContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        using (var valueAsStream = ((Stream)context.Object))
        {
            var response = context.HttpContext.Response;
            
            if (context.ContentType != null)
            {
                response.ContentType = context.ContentType.ToString();
            }
            
            await valueAsStream.CopyToAsync(response.Body);
        }
    }
}

```

##### 4.3.5 http no content formatter

```c#
public class HttpNoContentOutputFormatter : IOutputFormatter
{        
    public bool TreatNullValueAsNoContent { get; set; } = true;
    
    /// <inheritdoc />
    public bool CanWriteResult(OutputFormatterCanWriteContext context)
    {
        // ignore the contentType and just look at the content.
        // This formatter will be selected if the content is null.
        // We check for Task as a user can directly create an ObjectContentResult 
        // with the unwrapped type.
        if (context.ObjectType == typeof(void) || 
            context.ObjectType == typeof(Task))
        {
            return true;
        }
        
        return TreatNullValueAsNoContent && 
               context.Object == null;
    }
    
    /// <inheritdoc />
    public Task WriteAsync(OutputFormatterWriteContext context)
    {
        var response = context.HttpContext.Response;
        response.ContentLength = 0;
        
        if (response.StatusCode == StatusCodes.Status200OK)
        {
            response.StatusCode = StatusCodes.Status204NoContent;
        }
        
        return Task.CompletedTask;
    }
}

```

#### 4.4 formatter collection

```c#
public class FormatterCollection<TFormatter> : 
	Collection<TFormatter> where TFormatter : notnull
{   
    public FormatterCollection()
    {
    }
            
    public FormatterCollection(IList<TFormatter> list) : base(list)
    {
    }
        
    public void RemoveType<T>() where T : TFormatter
    {
        RemoveType(typeof(T));
    }
            
    public void RemoveType(Type formatterType)
    {
        for (var i = Count - 1; i >= 0; i--)
        {
            var formatter = this[i];
            if (formatter.GetType() == formatterType)
            {
                RemoveAt(i);
            }
        }
    }
}

```

#### 4.5 output formatter selector

##### 4.5.1 抽象基类

```c#
public abstract class OutputFormatterSelector
{    
    public abstract IOutputFormatter? SelectFormatter(
        OutputFormatterCanWriteContext context, 
        IList<IOutputFormatter> formatters, 
        MediaTypeCollection mediaTypes);
}

```

##### 4.5.2 default output formatter selector

```c#
public class DefaultOutputFormatterSelector : OutputFormatterSelector
{
    private static readonly Comparison<MediaTypeSegmentWithQuality> _sortFunction = (left, right) =>
    	{
        	return left.Quality > right.Quality 
                ? -1 
                : (left.Quality == right.Quality ? 0 : );
    	};
    
    private readonly ILogger _logger;
    private readonly IList<IOutputFormatter> _formatters;
    private readonly bool _respectBrowserAcceptHeader;
    private readonly bool _returnHttpNotAcceptable;
        
    public DefaultOutputFormatterSelector(
        IOptions<MvcOptions> options, 
        ILoggerFactory loggerFactory)
    {
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }        
        if (loggerFactory == null)
        {
            throw new ArgumentNullException(nameof(loggerFactory));
        }
        
        // 注入 logger
        _logger = loggerFactory.CreateLogger<DefaultOutputFormatterSelector>();
        // 创建 formatter 集合
        _formatters = new ReadOnlyCollection<IOutputFormatter>(options.Value.OutputFormatters);
        /* 从 mvc options 中解析 */
        _respectBrowserAcceptHeader = options.Value.RespectBrowserAcceptHeader;
        _returnHttpNotAcceptable = options.Value.ReturnHttpNotAcceptable;
    }
    
    /// <inheritdoc/>
    public override IOutputFormatter? SelectFormatter(
        OutputFormatterCanWriteContext context, 
        IList<IOutputFormatter> formatters, 
        MediaTypeCollection contentTypes)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (formatters == null)
        {
            throw new ArgumentNullException(nameof(formatters));
        }        
        if (contentTypes == null)
        {
            throw new ArgumentNullException(nameof(contentTypes));
        }
        
        // a- 验证 content type
        ValidateContentTypes(contentTypes);
        
        // 如果输入的备选 formatter 为 empty，
        // 用 selector 的 formatter 作为备选；   
        // 如果 selector formatter 也为 empty，抛出异常
        if (formatters.Count == 0)
        {
            formatters = _formatters;
            if (formatters.Count == 0)
            {
                throw new InvalidOperationException(
                    Resources.FormatOutputFormattersAreRequired(
                        typeof(MvcOptions).FullName,
                        nameof(MvcOptions.OutputFormatters),
                        typeof(IOutputFormatter).FullName));
            }
        }
        
        _logger.RegisteredOutputFormatters(formatters);
        
        // 解析 http request
        var request = context.HttpContext.Request;
        // b- 从 request 解析 media type
        var acceptableMediaTypes = GetAcceptableMediaTypes(request);
        
        var selectFormatterWithoutRegardingAcceptHeader = false;        
        IOutputFormatter? selectedFormatter = null;
        
        // accept media type 为 empty，
        if (acceptableMediaTypes.Count == 0)
        {
            // There is either no Accept header value, or it contained */* and we
            // are not currently respecting the 'browser accept header'.
            _logger.NoAcceptForNegotiation();
                        
            selectFormatterWithoutRegardingAcceptHeader = true;
        }
        else
        {
            // content types 为 empty
            if (contentTypes.Count == 0)
            {
                _logger.SelectingOutputFormatterUsingAcceptHeader(acceptableMediaTypes);
                
                /* 1- formatter using sorted accept header */
                // Use whatever formatter can meet the client's request
                selectedFormatter = SelectFormatterUsingSortedAcceptHeaders(
                    context,
                    formatters,
                    acceptableMediaTypes);
            }
            // content types 不为 empty
            else
            {
                _logger.SelectingOutputFormatterUsingAcceptHeaderAndExplicitContentTypes(
                    acceptableMediaTypes, 
                    contentTypes);
                
                /* 2- formatter using sorted accept header & content type */
                // Verify that a content type from the context is 
                // compatible with the client's request
                selectedFormatter = SelectFormatterUsingSortedAcceptHeadersAndContentTypes(
                    context,
                    formatters,
                    acceptableMediaTypes,
                    contentTypes);
            }
            
            // 如果没有选择到 formatter，
            if (selectedFormatter == null)
            {
                _logger.NoFormatterFromNegotiation(acceptableMediaTypes);
                
                if (!_returnHttpNotAcceptable)
                {
                    selectFormatterWithoutRegardingAcceptHeader = true;
                }
            }
        }
        
        // 标记了 without regarding accept header 
        if (selectFormatterWithoutRegardingAcceptHeader)
        {
            // content types 为 empty
            if (contentTypes.Count == 0)
            {
                _logger.SelectingOutputFormatterWithoutUsingContentTypes();
                
                /* 3- formatter without content type */
                selectedFormatter = SelectFormatterNotUsingContentType(
                    context,
                    formatters);
            }
            // content types 不为 empty
            else
            {
                _logger.SelectingOutputFormatterUsingContentTypes(contentTypes);
                
                /* 4- formatter using any acceptable content type */
                selectedFormatter = SelectFormatterUsingAnyAcceptableContentType(
                    context,
                    formatters,
                    contentTypes);
            }
        }
        
        if (selectedFormatter != null)
        {
            _logger.FormatterSelected(selectedFormatter, context);
        }
        
        return selectedFormatter;
    }
    
    // a- 验证 content type
    private void ValidateContentTypes(MediaTypeCollection contentTypes)
    {
        for (var i = 0; i < contentTypes.Count; i++)
        {
            var contentType = contentTypes[i];
            
            var parsedContentType = new MediaType(contentType);
            
            if (parsedContentType.HasWildcard)
            {
                var message = Resources.FormatObjectResult_MatchAllContentType(
                        contentType,
                        nameof(ObjectResult.ContentTypes));
                throw new InvalidOperationException(message);
            }
        }
    }
    
    // b- 从 http request 解析 accept media type
    private List<MediaTypeSegmentWithQuality> GetAcceptableMediaTypes(HttpRequest request)
    {
        var result = new List<MediaTypeSegmentWithQuality>();
        
        // 解析 accept header 到 result
        AcceptHeaderParser.ParseAcceptHeader(
            request.Headers[HeaderNames.Accept], 
            result);
        
        // 遍历header，如果有 match all types，
        // 清空 result 并 返回
        for (var i = 0; i < result.Count; i++)
        {
            var mediaType = new MediaType(result[i].MediaType);
            if (!_respectBrowserAcceptHeader && 
                mediaType.MatchesAllSubTypes && 
                mediaType.MatchesAllTypes)
            {
                result.Clear();
                return result;
            }
        }
        
        result.Sort(_sortFunction);        
        return result;
    }
    
    /* 1- */
    private IOutputFormatter? SelectFormatterUsingSortedAcceptHeaders(
        OutputFormatterCanWriteContext formatterContext,
        IList<IOutputFormatter> formatters,
        IList<MediaTypeSegmentWithQuality> sortedAcceptHeaders)
    {
        for (var i = 0; i < sortedAcceptHeaders.Count; i++)
        {
            var mediaType = sortedAcceptHeaders[i];
            
            formatterContext.ContentType = mediaType.MediaType;
            formatterContext.ContentTypeIsServerDefined = false;
            
            for (var j = 0; j < formatters.Count; j++)
            {
                var formatter = formatters[j];
                if (formatter.CanWriteResult(formatterContext))
                {
                    
                    return formatter;
                }
            }
        }
        
        return null;
    }
    
    /* 2- */
    private IOutputFormatter? SelectFormatterUsingSortedAcceptHeadersAndContentTypes(
        OutputFormatterCanWriteContext formatterContext,
        IList<IOutputFormatter> formatters,
        IList<MediaTypeSegmentWithQuality> sortedAcceptableContentTypes,
        MediaTypeCollection possibleOutputContentTypes)
    {
        for (var i = 0; i < sortedAcceptableContentTypes.Count; i++)
        {
            var acceptableContentType = 
                new MediaType(sortedAcceptableContentTypes[i].MediaType);
            for (var j = 0; j < possibleOutputContentTypes.Count; j++)
            {
                var candidateContentType = new MediaType(possibleOutputContentTypes[j]);
                if (candidateContentType.IsSubsetOf(acceptableContentType))
                {
                    for (var k = 0; k < formatters.Count; k++)
                    {
                        var formatter = formatters[k];
                        formatterContext.ContentType = 
                            new StringSegment(possibleOutputContentTypes[j]);
                        formatterContext.ContentTypeIsServerDefined = true;
                        if (formatter.CanWriteResult(formatterContext))
                        {
                            return formatter;
                        }
                    }
                }
            }
        }
        
        return null;
    }
    
    /* 3- */
    private IOutputFormatter? SelectFormatterNotUsingContentType(
        OutputFormatterCanWriteContext formatterContext,
        IList<IOutputFormatter> formatters)
    {
        _logger.SelectFirstCanWriteFormatter();
        
        foreach (var formatter in formatters)
        {
            formatterContext.ContentType = new StringSegment();
            formatterContext.ContentTypeIsServerDefined = false;
            
            if (formatter.CanWriteResult(formatterContext))
            {
                return formatter;
            }
        }
        
        return null;
    }
            
    /* 4- */
    private IOutputFormatter? SelectFormatterUsingAnyAcceptableContentType(
        OutputFormatterCanWriteContext formatterContext,
        IList<IOutputFormatter> formatters,
        MediaTypeCollection acceptableContentTypes)
    {
        foreach (var formatter in formatters)
        {
            foreach (var contentType in acceptableContentTypes)
            {
                formatterContext.ContentType = new StringSegment(contentType);
                formatterContext.ContentTypeIsServerDefined = true;

                if (formatter.CanWriteResult(formatterContext))
                {
                    return formatter;
                }
            }
        }
        
        return null;
    }                
}

```



#### 4.5 formatter filter

##### 4.5.1 接口

```c#
internal interface IFormatFilter : IFilterMetadata
{    
    string? GetFormat(ActionContext context);
}

```

##### 4.5.2 formatter filter

```c#
public class FormatFilter : IFormatFilter, IResourceFilter, IResultFilter
{
    private readonly MvcOptions _options;
    private readonly ILogger _logger;
       
    public FormatFilter(IOptions<MvcOptions> options, ILoggerFactory loggerFactory)
    {
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }        
        if (loggerFactory == null)
        {
            throw new ArgumentNullException(nameof(loggerFactory));
        }
        
        _options = options.Value;
        _logger = loggerFactory.CreateLogger(GetType());
    }
        
    public virtual string? GetFormat(ActionContext context)
    {
        if (context.RouteData.Values.TryGetValue("format", out var obj))
        {
            // null and string.Empty are equivalent for route values.
            var routeValue = Convert.ToString(obj, CultureInfo.InvariantCulture);
            return string.IsNullOrEmpty(routeValue) ? null : routeValue;
        }
        
        var query = context.HttpContext.Request.Query["format"];
        if (query.Count > 0)
        {
            return query.ToString();
        }
        
        return null;
    }
            
    public void OnResourceExecuting(ResourceExecutingContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        var format = GetFormat(context);
        if (format == null)
        {
            // no format specified by user, so the filter is muted
            return;
        }
        
        var contentType = _options.FormatterMappings.GetMediaTypeMappingForFormat(format);
        if (contentType == null)
        {
            _logger.UnsupportedFormatFilterContentType(format);
            
            // no contentType exists for the format, return 404
            context.Result = new NotFoundResult();
            return;
        }
        
        // Determine media types this action supports.
        var responseTypeFilters = context.Filters.OfType<IApiResponseMetadataProvider>();
        var supportedMediaTypes = new MediaTypeCollection();
        foreach (var filter in responseTypeFilters)
        {
            filter.SetContentTypes(supportedMediaTypes);
        }
        
        // Check if support is adequate for requested media type.
        if (supportedMediaTypes.Count == 0)
        {
            _logger.ActionDoesNotExplicitlySpecifyContentTypes();
            return;
        }
        
        // We need to check if the action can generate the content type the user asked for. That is, treat the
        // request's format and IApiResponseMetadataProvider-provided content types similarly to an Accept
        // header and an output formatter's SupportedMediaTypes: Confirm action supports a more specific media
        // type than requested e.g. OK if "text/*" requested and action supports "text/plain".
        if (!IsSuperSetOfAnySupportedMediaType(contentType, supportedMediaTypes))
        {
            _logger.ActionDoesNotSupportFormatFilterContentType(contentType, supportedMediaTypes);
            context.Result = new NotFoundResult();
        }
    }
    
    private bool IsSuperSetOfAnySupportedMediaType(string contentType, MediaTypeCollection supportedMediaTypes)
    {
        var parsedContentType = new MediaType(contentType);
        for (var i = 0; i < supportedMediaTypes.Count; i++)
        {
            var supportedMediaType = new MediaType(supportedMediaTypes[i]);
            if (supportedMediaType.IsSubsetOf(parsedContentType))
            {
                return true;
            }
        }
        
        return false;
    }
    
    public void OnResourceExecuted(ResourceExecutedContext context)
    {
    }
    
    public void OnResultExecuting(ResultExecutingContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        var format = GetFormat(context);
        if (format == null)
        {
            // no format specified by user, so the filter is muted
            return;
        }
        
        if (context.Result is not ObjectResult objectResult)
        {
            return;
        }
        
        // If the action sets a single content type, then it takes precedence over the user
        // supplied content type based on format mapping.
        if (objectResult.ContentTypes.Count == 1 ||
            !string.IsNullOrEmpty(context.HttpContext.Response.ContentType))
        {
            _logger.CannotApplyFormatFilterContentType(format);
            return;
        }
        
        var contentType = _options.FormatterMappings.GetMediaTypeMappingForFormat(format);
        objectResult.ContentTypes.Clear();
        if (!string.IsNullOrEmpty(contentType))
        {
            objectResult.ContentTypes.Add(contentType);
        }
    }
    
    /// <inheritdoc />
    public void OnResultExecuted(ResultExecutedContext context)
    {
    }
}

```

###### 4.5.2.1 formatter mappings

```c#
public class FormatterMappings
{
    private readonly Dictionary<string, string> _map = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
       
    /* set media type */
    public void SetMediaTypeMappingForFormat(string format, string contentType)
    {
        if (format == null)
        {
            throw new ArgumentNullException(nameof(format));
        }        
        if (contentType == null)
        {
            throw new ArgumentNullException(nameof(contentType));
        }
        
        SetMediaTypeMappingForFormat(format, MediaTypeHeaderValue.Parse(contentType));
    }
       
    public void SetMediaTypeMappingForFormat(string format, MediaTypeHeaderValue contentType)
    {
        if (format == null)
        {
            throw new ArgumentNullException(nameof(format));
        }        
        if (contentType == null)
        {
            throw new ArgumentNullException(nameof(contentType));
        }
        
        ValidateContentType(contentType);
        format = RemovePeriodIfPresent(format);
        _map[format] = contentType.ToString();
    }

    /* get media type */    
    public string? GetMediaTypeMappingForFormat(string format)
    {
        if (string.IsNullOrEmpty(format))
        {
            var message = Resources.FormatFormatFormatterMappings_GetMediaTypeMappingForFormat_InvalidFormat(
                nameof(format));
            
            throw new ArgumentException(message, nameof(format));
        }
        
        format = RemovePeriodIfPresent(format);        
        _map.TryGetValue(format, out var value);
        
        return value;
    }
    
    /* clear media type */    
    public bool ClearMediaTypeMappingForFormat(string format)
    {
        if (format == null)
        {
            throw new ArgumentNullException(nameof(format));
        }
        
        format = RemovePeriodIfPresent(format);
        return _map.Remove(format);
    }
    
    // validate content type
    private void ValidateContentType(MediaTypeHeaderValue contentType)
    {
        if (contentType.Type == "*" || contentType.SubType == "*")
        {
            throw new ArgumentException(
                string.Format(CultureInfo.CurrentCulture, Resources.FormatterMappings_NotValidMediaType, contentType),
                nameof(contentType));
        }
    }
    
    // remove period if present
    private string RemovePeriodIfPresent(string format)
    {
        if (string.IsNullOrEmpty(format))
        {
            throw new ArgumentException(
                Resources.ArgumentCannotBeNullOrEmpty, 
                nameof(format));
        }
        
        if (format.StartsWith(".", StringComparison.Ordinal))
        {
            if (format == ".")
            {
                throw new ArgumentException(
                    string.Format(CultureInfo.CurrentCulture, Resources.Format_NotValid, format), 
                    nameof(format));
            }
            
            format = format.Substring(1);
        }
        
        return format;
    }
}

```





### 2. action result

#### 2.1 action result

##### 2.1.1 action result

```c#
public interface IActionResult
{    
    Task ExecuteResultAsync(ActionContext context);
}

public abstract class ActionResult : IActionResult
{    
    public virtual Task ExecuteResultAsync(ActionContext context)
    {
        ExecuteResult(context);
        return Task.CompletedTask;
    }
        
    public virtual void ExecuteResult(ActionContext context)
    {
    }
}
```

action context??

##### 2.1.2 action result executor

```c#
public interface IActionResultExecutor<in TResult> 
    where TResult : notnull, IActionResult
{    
    Task ExecuteAsync(ActionContext context, TResult result);
}

```

#### 2.2 empty result

```c#
public class EmptyResult : ActionResult
{    
    public override void ExecuteResult(ActionContext context)
    {
    }
}

```

#### 2.3 file result

##### 2.3.1 file result (base)

###### 2.3.1.1 file result

```c#
public abstract class FileResult : ActionResult
{        
    // http media 的 content type
    public string ContentType { get; }
    
    /* for client cache */
    public DateTimeOffset? LastModified { get; set; }        
    public EntityTagHeaderValue EntityTag { get; set; }        
    public bool EnableRangeProcessing { get; set; }
    
    /* file download name */
    private string _fileDownloadName;
    public string FileDownloadName
    {
        get 
        {
            return _fileDownloadName ?? string.Empty; 
        }
        set 
        {
            _fileDownloadName = value; 
        }
    }
    
    protected FileResult(string contentType)
    {
        if (contentType == null)
        {
            throw new ArgumentNullException(nameof(contentType));
        }
        
        ContentType = contentType;
    }                                   
}

```

###### 2.3.1.2 file result executor base

```c#
public class FileResultExecutorBase
{        
    private const string AcceptRangeHeaderValue = "bytes";        
    protected const int BufferSize = 64 * 1024;
    
    protected ILogger Logger { get; }                    
    public FileResultExecutorBase(ILogger logger)
    {
        Logger = logger;
    }
                                                                  
    protected static ILogger CreateLogger<T>(ILoggerFactory factory)
    {
        if (factory == null)
        {
            throw new ArgumentNullException(nameof(factory));
        }
        
        return factory.CreateLogger<T>();
    }
                
    private static DateTimeOffset RoundDownToWholeSeconds(DateTimeOffset dateTimeOffset)
    {
        var ticksToRemove = dateTimeOffset.Ticks % TimeSpan.TicksPerSecond;
        return dateTimeOffset.Subtract(TimeSpan.FromTicks(ticksToRemove));
    }
    
    // write async
    protected static async Task WriteFileAsync(
        HttpContext context, 
        Stream fileStream, 
        RangeItemHeaderValue? range, 
        long rangeLength)
    {
        // 获取 http response body 的引用
        var outputStream = context.Response.Body;
        
        using (fileStream)
        {
            try
            {
                // 如果没有指定 range header value
                if (range == null)
                {
                    // 将 file stream 复制到 http response body(stream)
                    await StreamCopyOperation.CopyToAsync(
                        fileStream, 
                        outputStream, 
                        count: null, 
                        bufferSize: BufferSize, 
                        cancel: context.RequestAborted);
                }
                // 如果指定了 range header value
                else
                {
                    // 从 file stream 中 截取符合 range 的部分
                    fileStream.Seek(range.From!.Value, SeekOrigin.Begin);
                    // 将截取部分复制到 http response body(stream)
                    await StreamCopyOperation.CopyToAsync(
                        fileStream, 
                        outputStream, 
                        rangeLength, 
                        BufferSize, 
                        context.RequestAborted);
                }
            }
            catch (OperationCanceledException)
            {
                // Don't throw this exception, 
                // it's most likely caused by the client disconnecting.
                // However, if it was cancelled for any other reason 
                // we need to prevent empty responses.
                context.Abort();
            }
        }
    }
    
    // set headers and log
    protected virtual (RangeItemHeaderValue? range, 
                       long rangeLength, 
                       bool serveBody) SetHeadersAndLog(
        ActionContext context,
        FileResult result,
        long? fileLength,
        bool enableRangeProcessing,
        DateTimeOffset? lastModified = null,
        EntityTagHeaderValue? etag = null)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        /* 解析 http request header */
        var request = context.HttpContext.Request;
        var httpRequestHeaders = request.GetTypedHeaders();
        
        /* 解析 last modified，
           如果 last modified 有值，取整到 second */        
        if (lastModified.HasValue)
        {
            lastModified = RoundDownToWholeSeconds(lastModified.Value);
        }
        
        /* a - 获取 pre condition state */
        var preconditionState = GetPreconditionState(
            httpRequestHeaders, 
            lastModified, 
            etag);
        
        /* b - 设置 last modified and etag header */
        var response = context.HttpContext.Response;
        SetLastModifiedAndEtagHeaders(
            response, 
            lastModified, 
            etag);

        /* 如果解析到的 precondition 是 304 或者 412，
           返回对应的元组 */        
        if (preconditionState == PreconditionState.NotModified)
        {
            response.StatusCode = StatusCodes.Status304NotModified;
            return (range: null, rangeLength: 0, serveBody: false);
        }
        else if (preconditionState == PreconditionState.PreconditionFailed)
        {
            response.StatusCode = StatusCodes.Status412PreconditionFailed;
            return (range: null, rangeLength: 0, serveBody: false);
        }
        
        /* c - 设置 content type */
        SetContentType(context, result);
        SetContentDispositionHeader(context, result);
        
        /* file length 有值，即 file 不为空 */
        if (fileLength.HasValue)
        {
            /* 设置 content length */
            // Assuming the request is not a range request, and the response body is not empty, 
            // the Content-Length header is set to the length of the entire file. 
            // If the request is a valid range request, this header is overwritten with the length of 
            // the range as part of the range processing (see method SetContentLength).            
            response.ContentLength = fileLength.Value;
            
            /* 设置 accept range header */
            // Handle range request
            if (enableRangeProcessing)
            {
                /* d1 - 设置 accept range header */
                SetAcceptRangeHeader(response);
                
                // If the request method is HEAD or GET, 
                // PreconditionState is Unspecified or ShouldProcess, 
                // and IfRange header is valid,
                // range should be processed and Range headers should be set
                if ((HttpMethods.IsHead(request.Method) || HttpMethods.IsGet(request.Method)) && 
                    (preconditionState == PreconditionState.Unspecified || 
                     preconditionState == PreconditionState.ShouldProcess) && 
                    /* d2 - 判断 range valid */
                    (IfRangeValid(httpRequestHeaders, lastModified, etag)))
                {
                    /* d3 - 设置 range headers */
                    return SetRangeHeaders(context, httpRequestHeaders, fileLength.Value);
                }
            }            
            else
            {
                Logger.NotEnabledForRangeProcessing();
            }
        }
        
        return (range: null, rangeLength: 0, serveBody: !HttpMethods.IsHead(request.Method));
    }       
    
    /* a- get precondition state */    
    internal enum PreconditionState
    {
        Unspecified,
        NotModified,
        ShouldProcess,
        PreconditionFailed
    }
    
    internal PreconditionState GetPreconditionState(
        RequestHeaders httpRequestHeaders,
        DateTimeOffset? lastModified,
        EntityTagHeaderValue? etag)
    {
        var ifMatchState = PreconditionState.Unspecified;
        var ifNoneMatchState = PreconditionState.Unspecified;
        var ifModifiedSinceState = PreconditionState.Unspecified;
        var ifUnmodifiedSinceState = PreconditionState.Unspecified;
        
        // 14.24 If-Match
        var ifMatch = httpRequestHeaders.IfMatch;
        if (etag != null)
        {
            ifMatchState = GetEtagMatchState(
                useStrongComparison: true,
                etagHeader: ifMatch,
                etag: etag,
                matchFoundState: PreconditionState.ShouldProcess,
                matchNotFoundState: PreconditionState.PreconditionFailed);
            
            if (ifMatchState == PreconditionState.PreconditionFailed)
            {
                Logger.IfMatchPreconditionFailed(etag);
            }
        }
        
        // 14.26 If-None-Match
        var ifNoneMatch = httpRequestHeaders.IfNoneMatch;
        if (etag != null)
        {
            ifNoneMatchState = GetEtagMatchState(
                useStrongComparison: false,
                etagHeader: ifNoneMatch,
                etag: etag,
                matchFoundState: PreconditionState.NotModified,
                matchNotFoundState: PreconditionState.ShouldProcess);
        }
        
        var now = RoundDownToWholeSeconds(DateTimeOffset.UtcNow);
        
        // 14.25 If-Modified-Since
        var ifModifiedSince = httpRequestHeaders.IfModifiedSince;
        if (lastModified.HasValue && 
            ifModifiedSince.HasValue && 
            ifModifiedSince <= now)
        {
            var modified = ifModifiedSince < lastModified;
            ifModifiedSinceState = modified 
                ? PreconditionState.ShouldProcess 
                : PreconditionState.NotModified;
        }
        
        // 14.28 If-Unmodified-Since
        var ifUnmodifiedSince = httpRequestHeaders.IfUnmodifiedSince;
        if (lastModified.HasValue && 
            ifUnmodifiedSince.HasValue && 
            ifUnmodifiedSince <= now)
        {
            var unmodified = ifUnmodifiedSince >= lastModified;
            ifUnmodifiedSinceState = unmodified 
                ? PreconditionState.ShouldProcess 
                : PreconditionState.PreconditionFailed;
            
            if (ifUnmodifiedSinceState == PreconditionState.PreconditionFailed)
            {
                Logger.IfUnmodifiedSincePreconditionFailed(
                    lastModified, 
                    ifUnmodifiedSince);
            }
        }
        
        var state = GetMaxPreconditionState(
            ifMatchState, 
            ifNoneMatchState, 
            ifModifiedSinceState, 
            ifUnmodifiedSinceState);
        
        return state;
    }    
    
    // 通过 etag 判断 precondition 状态
    private static PreconditionState GetEtagMatchState(
        bool useStrongComparison,
        IList<EntityTagHeaderValue> etagHeader,
        EntityTagHeaderValue etag,
        PreconditionState matchFoundState,
        PreconditionState matchNotFoundState)
    {
        if (etagHeader?.Count > 0)
        {
            var state = matchNotFoundState;
            foreach (var entityTag in etagHeader)
            {
                if (entityTag.Equals(EntityTagHeaderValue.Any) || 
                    entityTag.Compare(etag, useStrongComparison))
                {
                    state = matchFoundState;
                    break;
                }
            }
            
            return state;
        }
        
        return PreconditionState.Unspecified;
    }
    
    // 从多个 precondition state 中找到最大值
    private static PreconditionState GetMaxPreconditionState(
        params PreconditionState[] states)
    {
        var max = PreconditionState.Unspecified;
        for (var i = 0; i < states.Length; i++)
        {
            if (states[i] > max)
            {
                max = states[i];
            }
        }
        
        return max;
    }
    
    /* b- set last modified & etag header */
    private static void SetLastModifiedAndEtagHeaders(
        HttpResponse response, 
        DateTimeOffset? lastModified, 
        EntityTagHeaderValue? etag)
    {
        var httpResponseHeaders = response.GetTypedHeaders();
        if (lastModified.HasValue)
        {
            httpResponseHeaders.LastModified = lastModified;
        }
        if (etag != null)
        {
            httpResponseHeaders.ETag = etag;
        }
    }
    
    /* c- set content and disposition */
    // 设置 content type
    private static void SetContentType(
        ActionContext context, 
        FileResult result)
    {
        var response = context.HttpContext.Response;
        response.ContentType = result.ContentType;
    }
    
    // 设置 content disposition（attachment）
    private static void SetContentDispositionHeader(        
        ActionContext context, 
        FileResult result)
    {
        if (!string.IsNullOrEmpty(result.FileDownloadName))
        {
            // From RFC 2183, Sec. 2.3:
            // The sender may want to suggest a filename to be used if the entity is
            // detached and stored in a separate file. If the receiving MUA writes
            // the entity to a file, the suggested filename should be used as a
            // basis for the actual filename, where possible.
            var contentDisposition = new ContentDispositionHeaderValue("attachment");
            contentDisposition.SetHttpFileName(result.FileDownloadName);
            context.HttpContext
                   .Response
                   .Headers[HeaderNames.ContentDisposition] = contentDisposition.ToString();
        }
    }
    
    /* set range header */
    // d1 - 设置 accept range header（bytes）
    private static void SetAcceptRangeHeader(HttpResponse response)
    {
        // 常量 AcceptRangeHeaderValue -> "bytes"
        response.Headers[HeaderNames.AcceptRanges] = AcceptRangeHeaderValue;
    }
    
    // d2 - 判断 range valid
    internal bool IfRangeValid(
        RequestHeaders httpRequestHeaders,
        DateTimeOffset? lastModified,
        EntityTagHeaderValue? etag)
    {
        // 14.27 If-Range
        var ifRange = httpRequestHeaders.IfRange;
        if (ifRange != null)
        {
            // If the validator given in the If-Range header field matches the
            // current validator for the selected representation of the target
            // resource, then the server SHOULD process the Range header field as
            // requested.  If the validator does not match, the server MUST ignore
            // the Range header field.
            if (ifRange.LastModified.HasValue)
            {
                if (lastModified.HasValue && 
                    lastModified > ifRange.LastModified)
                {
                    Logger.IfRangeLastModifiedPreconditionFailed(
                        lastModified, 
                        ifRange.LastModified);
                    return false;
                }
            }
            else if (etag != null && 
                     ifRange.EntityTag != null && 
                     !ifRange
                     .EntityTag
                     .Compare(etag, useStrongComparison: true))
            {
                Logger.IfRangeETagPreconditionFailed(
                    etag, 
                    ifRange.EntityTag);
                return false;
            }
        }
        
        return true;
    }
    
    // d3 - 设置 range header
    private (RangeItemHeaderValue? range, 
             long rangeLength, 
             bool serveBody) SetRangeHeaders(
        		ActionContext context,
        		RequestHeaders httpRequestHeaders,
        		long fileLength)
    {
        var response = context.HttpContext.Response;
        // 获取 header
        var httpResponseHeaders = response.GetTypedHeaders();
        // 获取 body
        var serveBody = !HttpMethods.IsHead(context.HttpContext.Request.Method);
                
        /* 判断 range request，计算 range */
        // Range may be null for empty range header, invalid ranges, parsing errors, 
        // multiple ranges and when the file length is zero.
        var (isRangeRequest, range) = 
            RangeHelper.ParseRange(
            	context.HttpContext,
            	httpRequestHeaders,
            	fileLength,
            	Logger);
        
        /* 如果没有 range request，返回 range = null */
        if (!isRangeRequest)
        {
            return (range: null, rangeLength: 0, serveBody);
        }
        
        /* 请求 range request，但是 range = null，返回 416 */
        // Requested range is not satisfiable
        if (range == null)
        {
            // 14.16 Content-Range - A server sending a response with status code 416 
            // (Requested range not satisfiable)
            // SHOULD include a Content-Range field with a byte-range-resp-spec of "*". 
            // The instance-length specifies the current length of the selected resource.  
            // e.g. */length
            response.StatusCode = StatusCodes.Status416RangeNotSatisfiable;
            httpResponseHeaders.ContentRange = new ContentRangeHeaderValue(fileLength);
            response.ContentLength = 0;
            
            return (range: null, rangeLength: 0, serveBody: false);
        }
        
        /* 请求 range request，且计算得 range 不为null，
           返回 206 和 range header */
        response.StatusCode = StatusCodes.Status206PartialContent;
        httpResponseHeaders.ContentRange = 
            new ContentRangeHeaderValue(
            	range.From!.Value,
            	range.To!.Value,
	            fileLength);
        
        // Overwrite the Content-Length header for valid range 
        // requests with the range length.
        var rangeLength = SetContentLength(response, range);
        
        return (range, rangeLength, serveBody);
    }
    
    private static long SetContentLength(
        HttpResponse response, 
        RangeItemHeaderValue range)
    {
        var start = range.From!.Value;
        var end = range.To!.Value;
        var length = end - start + 1;
        response.ContentLength = length;
        return length;
    }        
}

```

##### 2.3.2 file content result

###### 2.3.2.1 result

```c#
public class FileContentResult : FileResult
{
    /* file content */
    private byte[] _fileContents;        
    public byte[] FileContents
    {
        get => _fileContents;
        set
        {
            if (value == null)
            {
                throw new ArgumentNullException(nameof(value));
            }
            
            _fileContents = value;
        }
    }
    
    public FileContentResult(
        byte[] fileContents, 
        string contentType)            
        	: this(
                fileContents, 
                MediaTypeHeaderValue.Parse(contentType))
    {
    }
        
    public FileContentResult(
        byte[] fileContents, 
        MediaTypeHeaderValue contentType)            
        	: base(contentType?.ToString())
    {
        if (fileContents == null)
        {
            throw new ArgumentNullException(nameof(fileContents));
        }
        
        FileContents = fileContents;
    }
                    
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));            
        }
        
        // 从 action context 解析 file content result executor
        var executor = context
            .HttpContext
            .RequestServices
            .GetRequiredService<IActionResultExecutor<FileContentResult>>();
        // 用 file content result executor 执行 result
        return executor.ExecuteAsync(context, this);
    }
}

```

###### 2.3.2.2 executor

```c#
public class FileContentResultExecutor : 
	FileResultExecutorBase, 
	IActionResultExecutor<FileContentResult>
{
    
    public FileContentResultExecutor(ILoggerFactory loggerFactory)            
        : base(CreateLogger<FileContentResultExecutor>(loggerFactory))
    {
    }
    
    /// <inheritdoc />
    public virtual Task ExecuteAsync(
        ActionContext context, 
        FileContentResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        Logger.ExecutingFileResult(result);
        
        /* 1 - 设置 header */
        var (range, rangeLength, serveBody) = 
            SetHeadersAndLog(
            	context,
            	result,
            	result.FileContents.Length,
            	result.EnableRangeProcessing,
	            result.LastModified,	
            	result.EntityTag);
		
        /* 2 - 写入 body */
        if (!serveBody)
        {
            return Task.CompletedTask;
        }        
        return WriteFileAsync(context, result, range, rangeLength);
    }
            
    protected virtual Task WriteFileAsync(
        ActionContext context, 
        FileContentResult result, 
        RangeItemHeaderValue? range, 
        long rangeLength)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        if (range != null && rangeLength == 0)
        {
            return Task.CompletedTask;
        }
        
        if (range != null)
        {
            Logger.WritingRangeToBody();
        }
        
        var fileContentStream = new MemoryStream(result.FileContents);
        
        return WriteFileAsync(
            context.HttpContext, 
            fileContentStream, 
            range, 
            rangeLength);
    }
}

```

##### 2.3.3 file stream result

###### 2.3.3.1 result

```c#
public class FileStreamResult : FileResult
{
    /* file stream */
    private Stream _fileStream;
    public Stream FileStream
    {
        get => _fileStream;
        set
        {
            if (value == null)
            {
                throw new ArgumentNullException(nameof(value));
            }
            
            _fileStream = value;
        }
    }
    
    public FileStreamResult(
        Stream fileStream, 
        string contentType)
        	: this(
                fileStream, 
                MediaTypeHeaderValue.Parse(contentType))
    {
    }
        
    public FileStreamResult(
        Stream fileStream, 
        MediaTypeHeaderValue contentType)
        	: base(contentType?.ToString())
    {
        if (fileStream == null)
        {
            throw new ArgumentNullException(nameof(fileStream));
        }

        FileStream = fileStream;
    }
                
    /// <inheritdoc />
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        // 从 action context 中解析 filt stream result executor
        var executor = 
            context.HttpContext
            	   .RequestServices
            	   .GetRequiredService<IActionResultExecutor<FileStreamResult>>();
        // 使用 file stream executor 执行 execute        
        return executor.ExecuteAsync(context, this);
    }
}

```

###### 2.3.3.2 executor

```c#
public class FileStreamResultExecutor : 
	FileResultExecutorBase, 
	IActionResultExecutor<FileStreamResult>
{
    
    public FileStreamResultExecutor(ILoggerFactory loggerFactory)            
        : base(CreateLogger<FileStreamResultExecutor>(loggerFactory))
    {
    }
    
    /// <inheritdoc />
    public virtual async Task ExecuteAsync(
        ActionContext context, 
        FileStreamResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        using (result.FileStream)
        {
            Logger.ExecutingFileResult(result);
            
            long? fileLength = null;
            if (result.FileStream.CanSeek)
            {
                fileLength = result.FileStream.Length;
            }
            
            /* 1 - 设置 header */
            var (range, rangeLength, serveBody) = 
                SetHeadersAndLog(
                	context,
                	result,
                	fileLength,
                	result.EnableRangeProcessing,
                	result.LastModified,
                	result.EntityTag);
            /* 2 - 写入 body */
            if (!serveBody)
            {
                return;
            }            
            await WriteFileAsync(context, result, range, rangeLength);
        }
    }
           
    protected virtual Task WriteFileAsync(
        ActionContext context,
        FileStreamResult result,
        RangeItemHeaderValue? range,
        long rangeLength)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        if (range != null && rangeLength == 0)
        {
            return Task.CompletedTask;
        }
        
        if (range != null)
        {
            Logger.WritingRangeToBody();
        }
        
        return WriteFileAsync(
            context.HttpContext, 
            result.FileStream, 
            range, rangeLength);
    }
}

```

##### 2.3.4 physical file result

###### 2.3.4.1 result

```c#
public class PhysicalFileResult : FileResult
{
    /* file name */
    private string _fileName;
    public string FileName
    {
        get => _fileName;
        set => _fileName = value ?? throw new ArgumentNullException(nameof(value));
    }
        
    public PhysicalFileResult(
        string fileName, 
        string contentType)            
        	: this(
                fileName, 
                MediaTypeHeaderValue.Parse(contentType))
    {
        if (fileName == null)
        {
            throw new ArgumentNullException(nameof(fileName));
        }
    }
           
    public PhysicalFileResult(
        string fileName, 
        MediaTypeHeaderValue contentType)            
        	: base(contentType?.ToString())
    {
        FileName = fileName ?? throw new ArgumentNullException(nameof(fileName));
    }
                
    /// <inheritdoc />
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        // 从 action context 中解析 physical file result executor
        var executor = 
            context.HttpContext
	               .RequestServices
       		       .GetRequiredService<IActionResultExecutor<PhysicalFileResult>>();
        // 使用 physical file result executor 执行 execute
        return executor.ExecuteAsync(context, this);
    }
}

```

###### 2.3.4.2 executor

```c#
public class PhysicalFileResultExecutor : 
	FileResultExecutorBase, 
	IActionResultExecutor<PhysicalFileResult>
{
        
    public PhysicalFileResultExecutor(ILoggerFactory loggerFactory)            
        : base(CreateLogger<PhysicalFileResultExecutor>(loggerFactory))
    {
    }
    
    /// <inheritdoc />
    public virtual Task ExecuteAsync(
        ActionContext context, 
        PhysicalFileResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }   
        
        // 从 result 解析 file info，
        // 如果 file 不存在，抛出异常
        var fileInfo = GetFileInfo(result.FileName);
        if (!fileInfo.Exists)
        {
            throw new FileNotFoundException(
                Resources.FormatFileResult_InvalidPath(result.FileName), 
                result.FileName);
        }
        
        Logger.ExecutingFileResult(result, result.FileName);
        
        /* 1 - 设置 header */
        // last modified 设置为 file 的 modified 时间
        var lastModified = result.LastModified ?? fileInfo.LastModified;
        var (range, rangeLength, serveBody) = 
            SetHeadersAndLog(
	            context,
    	        result,
        	    fileInfo.Length,
            	result.EnableRangeProcessing,
	            lastModified,
    	        result.EntityTag);
        /* 2 - 写入 body */
        if (serveBody)
        {
            return WriteFileAsync(context, result, range, rangeLength);
        }        
        return Task.CompletedTask;
    }
    
    /// <inheritdoc/>
    protected virtual Task WriteFileAsync(
        ActionContext context, 
        PhysicalFileResult result, 
        RangeItemHeaderValue range, 
        long rangeLength)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        if (range != null && rangeLength == 0)
        {
            return Task.CompletedTask;
        }
        
        var response = context.HttpContext.Response;
        if (!Path.IsPathRooted(result.FileName))
        {
            throw new NotSupportedException(
                Resources.FormatFileResult_PathNotRooted(result.FileName));
        }
        
        if (range != null)
        {
            Logger.WritingRangeToBody();
        }
        
        // 如果 range 不为 null，从 range 返回 range length 的 file 内容
        if (range != null)
        {
            return response.SendFileAsync(
                				result.FileName,
                				offset: range.From ?? 0L,
                				count: rangeLength);
        }
        // 否则，即 range 为 null，从头（offset=0）返回 file 内容
        return response.SendFileAsync(
            					result.FileName,
            					offset: 0,
            					count: null);
    }
    
    /* get file info */
                       
    protected virtual FileMetadata GetFileInfo(string path)
    {
        var fileInfo = new FileInfo(path);
        return new FileMetadata
        {
            Exists = fileInfo.Exists,
            Length = fileInfo.Length,
            LastModified = fileInfo.LastWriteTimeUtc,
        };
    }
            
    protected class FileMetadata
    {        
        public bool Exists { get; set; }                
        public long Length { get; set; }                
        public DateTimeOffset LastModified { get; set; }
    }
}

```

##### 2.3.5 virtual file result

###### 2.3.5.1 result

```c#
public class VirtualFileResult : FileResult
{
    /* file name */
    private string _fileName;
    public string FileName
    {
        get => _fileName;
        set => _fileName = value ?? throw new ArgumentNullException(nameof(value));
    }

    public IFileProvider FileProvider { get; set; }
    
    public VirtualFileResult(
        string fileName, 
        string contentType)            
        	: this(
                fileName, 
                MediaTypeHeaderValue.Parse(contentType))
    {
    }
            
    public VirtualFileResult(
        string fileName, 
        MediaTypeHeaderValue contentType)            
        	: base(contentType?.ToString())
    {
        FileName = fileName ?? throw new ArgumentNullException(nameof(fileName));
    }
                            
    /// <inheritdoc />
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        // 从 action context 解析 virtual file result executor
        var executor = 
            context.HttpContext
	               .RequestServices
       		       .GetRequiredService<IActionResultExecutor<VirtualFileResult>>();
        // 使用 virtual file result executor 执行 execute
        return executor.ExecuteAsync(context, this);
    }
}

```

###### 2.3.5.2. executor

```c#
public class VirtualFileResultExecutor : 
	FileResultExecutorBase, 
	IActionResultExecutor<VirtualFileResult>
{
    private readonly IWebHostEnvironment _hostingEnvironment;
            
    public VirtualFileResultExecutor(
        ILoggerFactory loggerFactory, 
        IWebHostEnvironment hostingEnvironment)            
        	: base(CreateLogger<VirtualFileResultExecutor>(loggerFactory))
    {
        if (hostingEnvironment == null)
        {
            throw new ArgumentNullException(nameof(hostingEnvironment));
        }
        
        _hostingEnvironment = hostingEnvironment;
    }
    
    /// <inheritdoc />
    public virtual Task ExecuteAsync(
        ActionContext context, 
        VirtualFileResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        // 获取 file info，
        // 如果 file 不存在，抛出异常
        var fileInfo = GetFileInformation(result);
        if (!fileInfo.Exists)
        {
            throw new FileNotFoundException(
                Resources.FormatFileResult_InvalidPath(result.FileName), 
                result.FileName);
        }
        
        Logger.ExecutingFileResult(result, result.FileName);
        
        /* 1 - 设置 last modified */
        // 使用 file 的 modified 时间作为 last modified
        var lastModified = result.LastModified ?? fileInfo.LastModified;
        var (range, rangeLength, serveBody) = 
            SetHeadersAndLog(
	            context,
    	        result,
        	    fileInfo.Length,
            	result.EnableRangeProcessing,
	            lastModified,
    	        result.EntityTag);
        /* 2 - 写入 body */
        if (serveBody)
        {
            return WriteFileAsync(context, result, fileInfo, range, rangeLength);
        }        
        return Task.CompletedTask;
    }
    
    /// <inheritdoc/>
    protected virtual Task WriteFileAsync(
        ActionContext context, 
        VirtualFileResult result, 
        IFileInfo fileInfo, 
        RangeItemHeaderValue? range, 
        long rangeLength)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        if (range != null && rangeLength == 0)
        {
            return Task.CompletedTask;
        }
        
        var response = context.HttpContext.Response;
        
        if (range != null)
        {
            Logger.WritingRangeToBody();
        }
        
        if (range != null)
        {
            return response.SendFileAsync(
                				fileInfo,
                				offset: range.From ?? 0L,
                				count: rangeLength);
        }
        
        return response.SendFileAsync(
            					fileInfo,
            					offset: 0,
            					count: null);
    }
    
    /* 获取 file info */
        
    private IFileInfo GetFileInformation(VirtualFileResult result)
    {
        var fileProvider = GetFileProvider(result);
        
        if (fileProvider is NullFileProvider)
        {
            throw new InvalidOperationException(
                Resources.VirtualFileResultExecutor_NoFileProviderConfigured);
        }
        
        var normalizedPath = result.FileName;
        if (normalizedPath.StartsWith("~", StringComparison.Ordinal))
        {
            normalizedPath = normalizedPath.Substring(1);
        }
        
        var fileInfo = fileProvider.GetFileInfo(normalizedPath);
        return fileInfo;
    }
    
    // 获取 file provider
    private IFileProvider GetFileProvider(VirtualFileResult result)
    {
        if (result.FileProvider != null)
        {
            return result.FileProvider;
        }
        
        // 从 hosting environment 获取 web root file provider
        result.FileProvider = _hostingEnvironment.WebRootFileProvider;
        return result.FileProvider;
    }            
}

```

#### 2.4 redirect result

```c#
public interface IKeepTempDataResult : IActionResult
{
}

```

##### 2.4.1 local redirect result

###### 2.4.1.1 result

```c#
public class LocalRedirectResult : ActionResult
{    
    private string _localUrl;
     public string Url
    {
        get => _localUrl;
        set
        {
            if (string.IsNullOrEmpty(value))
            {
                throw new ArgumentException(
                    Resources.ArgumentCannotBeNullOrEmpty, 
                    nameof(value));
            }
            
            _localUrl = value;
        }
    }
    
    public bool Permanent { get; set; }        
    public bool PreserveMethod { get; set; }	// for http post            
    public IUrlHelper UrlHelper { get; set; }
    
    public LocalRedirectResult(string localUrl)
        : this(
            localUrl, 
            permanent: false)
    {
    }

    public LocalRedirectResult(
        string localUrl, 
        bool permanent)
        	: this(
	            localUrl, 
    	        permanent, 
        	    preserveMethod: false)
    {
    }
        
    public LocalRedirectResult(
        string localUrl, 
        bool permanent, 
        bool preserveMethod)
    {
        if (string.IsNullOrEmpty(localUrl))
        {
            throw new ArgumentException(
                Resources.ArgumentCannotBeNullOrEmpty, 
                nameof(localUrl));
        }
        
        Permanent = permanent;
        PreserveMethod = preserveMethod;
        Url = localUrl;
    }
                
    /// <inheritdoc />
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        // 从 action context 解析 local redirect result executor
        var executor = 
            context.HttpContext
            	   .RequestServices
            	   .GetRequiredService<IActionResultExecutor<LocalRedirectResult>>();
        // 使用 local redirect result executor 执行 execute
        return executor.ExecuteAsync(context, this);
    }
}

```

###### 2.4.1.2 executor

```c#
public class LocalRedirectResultExecutor : IActionResultExecutor<LocalRedirectResult>
{
    private readonly ILogger _logger;       
    private readonly IUrlHelperFactory _urlHelperFactory;
        
    public LocalRedirectResultExecutor(
        ILoggerFactory loggerFactory, 
        IUrlHelperFactory urlHelperFactory)
    {
        if (loggerFactory == null)
        {
            throw new ArgumentNullException(nameof(loggerFactory));
        }        
        if (urlHelperFactory == null)
        {
            throw new ArgumentNullException(nameof(urlHelperFactory));
        }
        
        _logger = loggerFactory.CreateLogger<LocalRedirectResultExecutor>();
        _urlHelperFactory = urlHelperFactory;
    }
    
    /// <inheritdoc />
    public virtual Task ExecuteAsync(
        ActionContext context, 
        LocalRedirectResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        var urlHelper = result.UrlHelper ?? _urlHelperFactory.GetUrlHelper(context);
        
        // IsLocalUrl is called to handle Urls starting with '~/'.
        if (!urlHelper.IsLocalUrl(result.Url))
        {
            throw new InvalidOperationException(Resources.UrlNotLocal);
        }
        
        // 解析 destination result
        var destinationUrl = urlHelper.Content(result.Url);
        _logger.LocalRedirectResultExecuting(destinationUrl);
        
        /* 如果 preserve method = true，*/
        if (result.PreserveMethod)
        {
            // 返回 307(temporary)、308(permanent)
            context.HttpContext
                   .Response
                   .StatusCode = result.Permanent 
                					? StatusCodes.Status308PermanentRedirect 
                					: StatusCodes.Status307TemporaryRedirect;
            // 重写 http response header 的 location
            context.HttpContext
                   .Response
                   .Headers[HeaderNames.Location] = destinationUrl;
        }
        /* 否则，即preserve method = false，*/
        else
        {
            // 调用 http response 的 redirect 方法
            context.HttpContext
                   .Response
                   .Redirect(destinationUrl, result.Permanent);
        }
        
        return Task.CompletedTask;
    }
}

```

##### 2.4.2 redirect result

###### 2.4.2.1 result

```c#
public class RedirectResult : 
	ActionResult, 
	IKeepTempDataResult
{
    private string _url;
    public string Url
    {
        get => _url;
        set
        {
            if (string.IsNullOrEmpty(value))
            {
                throw new ArgumentException(
                    Resources.ArgumentCannotBeNullOrEmpty, 
                    nameof(value));
            }
            
            _url = value;
        }
    }
    
    public bool Permanent { get; set; }            
    public bool PreserveMethod { get; set; }	// for http post            
    public IUrlHelper UrlHelper { get; set; }
    
    public RedirectResult(string url) 
        : this(
            url, 
            permanent: false)
    {
        if (url == null)
        {
            throw new ArgumentNullException(nameof(url));
        }
    }
        
    public RedirectResult(
        string url, 
        bool permanent)            
        	: this(
                url, 
                permanent, 
                preserveMethod: false)
    {
    }
       
    public RedirectResult(
        string url, 
        bool permanent, 
        bool preserveMethod)
    {
        if (url == null)
        {
            throw new ArgumentNullException(nameof(url));
        }        
        if (string.IsNullOrEmpty(url))
        {
            throw new ArgumentException(
                Resources.ArgumentCannotBeNullOrEmpty, 
                nameof(url));
        }
        
        Permanent = permanent;
        PreserveMethod = preserveMethod;
        Url = url;
    }
              
    /// <inheritdoc />
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        // 解析 content result executor
        var executor = 
            context.HttpContext
            	   .RequestServices
            	   .GetRequiredService<IActionResultExecutor<RedirectResult>>();
        // 使用 content result executor 的 execute 方法
        return executor.ExecuteAsync(context, this);
    }
}

```

###### 2.4.2.2 executor

```c#
public class RedirectResultExecutor : IActionResultExecutor<RedirectResult>
{
    private readonly ILogger _logger;
    private readonly IUrlHelperFactory _urlHelperFactory;
        
    public RedirectResultExecutor(
        ILoggerFactory loggerFactory, 
        IUrlHelperFactory urlHelperFactory)
    {
        if (loggerFactory == null)
        {
            throw new ArgumentNullException(nameof(loggerFactory));
        }        
        if (urlHelperFactory == null)
        {
            throw new ArgumentNullException(nameof(urlHelperFactory));
        }
        
        _logger = loggerFactory.CreateLogger<RedirectResultExecutor>();
        _urlHelperFactory = urlHelperFactory;
    }
    
    /// <inheritdoc />
    public virtual Task ExecuteAsync(
        ActionContext context, 
        RedirectResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        // 从 redirect result 中解析或者创建 url helper
        var urlHelper = result.UrlHelper ?? _urlHelperFactory.GetUrlHelper(context);
        
        /* 解析 destinational url，
           如果是本地 url，处理 ~/ 符号 */
        // IsLocalUrl is called to handle URLs starting with '~/'.
        var destinationUrl = result.Url;
        if (urlHelper.IsLocalUrl(destinationUrl))
        {
            destinationUrl = urlHelper.Content(result.Url);
        }
        
        _logger.RedirectResultExecuting(destinationUrl);
        
        /* 如果标记了 preserve method，
           返回 307(temporary) 或 308(permanent) */        
        if (result.PreserveMethod)
        {
            context.HttpContext.Response.StatusCode = 
                result.Permanent 
                	? StatusCodes.Status308PermanentRedirect 
                	: StatusCodes.Status307TemporaryRedirect;
            // 重写 response header 的 location
            context.HttpContext
                   .Response
                   .Headers[HeaderNames.Location] = destinationUrl;
        }
        /* 否则，即 preserve method = false，
           调用 response 的 redirect 方法 */        
        else
        {
            context.HttpContext
                   .Response
                   .Redirect(destinationUrl, result.Permanent);
        }
        
        return Task.CompletedTask;
    }
}

```

##### 2.4.3 redirect to action result

###### 2.4.3.1 result

```c#
public class RedirectToActionResult : 	
	ActionResult, 	
	IKeepTempDataResult
{        
    public IUrlHelper UrlHelper { get; set; }
        
    public string ActionName { get; set; }        
    public string ControllerName { get; set; }      
    public RouteValueDictionary RouteValues { get; set; }       
    public bool Permanent { get; set; }        
    public bool PreserveMethod { get; set; }        
    public string Fragment { get; set; }
        
        
    public RedirectToActionResult(
        string actionName,
        string controllerName,
        object routeValues)
        	: this(
                actionName, 
                controllerName, 
                routeValues, 
                permanent: false)
    {
    }
        
    public RedirectToActionResult(
        string actionName,
        string controllerName,
        object routeValues,
        string fragment)
        	: this(
                actionName, 
                controllerName, 
                routeValues, 
                permanent: false, 
                fragment: fragment)
    {
    }
       
    public RedirectToActionResult(
        string actionName,
        string controllerName,
        object routeValues,
        bool permanent)
        	: this(
                actionName, 
                controllerName, 
                routeValues, 
                permanent, 
                fragment: null)
    {
    }
        
    public RedirectToActionResult(
        string actionName,
        string controllerName,
        object routeValues,
        bool permanent,
        bool preserveMethod)
        	: this(
                actionName, 
                controllerName, 
                routeValues, 
                permanent, 
                preserveMethod, 
                fragment: null)
    {
    }
        
    public RedirectToActionResult(
        string actionName,
        string controllerName,
        object routeValues,
        bool permanent,
        string fragment)
        	: this(
                actionName, 
                controllerName, 
                routeValues, 
                permanent, 
                preserveMethod: false, 
                fragment: fragment)
    {
    }
       
    public RedirectToActionResult(
        string actionName,
        string controllerName,
        object routeValues,
        bool permanent,
        bool preserveMethod,
        string fragment)
    {
        ActionName = actionName;
        ControllerName = controllerName;
        RouteValues = routeValues == null ? null : new RouteValueDictionary(routeValues);
        Permanent = permanent;
        PreserveMethod = preserveMethod;
        Fragment = fragment;
    }
           
    /// <inheritdoc />
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        // 从 action context 中解析 redirect to action result executor
        var executor = 
            context.HttpContext
      	           .RequestServices
        	       .GetRequiredService<IActionResultExecutor<RedirectToActionResult>>();
        // 使用 executor 执行 execute
        return executor.ExecuteAsync(context, this);
    }
}

```

###### 2.4.3.2 executor

```c#
public class RedirectToActionResultExecutor 
    : IActionResultExecutor<RedirectToActionResult>
{
    private readonly ILogger _logger;
    private readonly IUrlHelperFactory _urlHelperFactory;
           
    public RedirectToActionResultExecutor(
        ILoggerFactory loggerFactory, 
        IUrlHelperFactory urlHelperFactory)
    {
        if (loggerFactory == null)
        {
            throw new ArgumentNullException(nameof(loggerFactory));
        }        
        if (urlHelperFactory == null)
        {
            throw new ArgumentNullException(nameof(urlHelperFactory));
        }
        
        _logger = loggerFactory.CreateLogger<RedirectToActionResult>();
        _urlHelperFactory = urlHelperFactory;
    }
    
        /// <inheritdoc />
    public virtual Task ExecuteAsync(
        ActionContext context, 
        RedirectToActionResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        /* 解析 destination url */
        var urlHelper = result.UrlHelper ?? _urlHelperFactory.GetUrlHelper(context);
        
        var destinationUrl = urlHelper.Action(
            result.ActionName,
            result.ControllerName,
            result.RouteValues,
            protocol: null,
            host: null,
            fragment: result.Fragment);
        
        if (string.IsNullOrEmpty(destinationUrl))
        {
            throw new InvalidOperationException(Resources.NoRoutesMatched);
        }

        _logger.RedirectToActionResultExecuting(destinationUrl);
        
        /* 如果 preserve method = true，*/
        if (result.PreserveMethod)
        {
            // 返回 307(temporary) 或 308(permanent)
            context.HttpContext
                   .Response
                   .StatusCode = result.Permanent 
                					? StatusCodes.Status308PermanentRedirect 
                					: StatusCodes.Status307TemporaryRedirect;
            // 重写 http response header 的 location
            context.HttpContext
                   .Response
                   .Headers[HeaderNames.Location] = destinationUrl;
        }
        /* 否则，即preserve method = false */
        else
        {
            // 调用 http response 的 redirect 方法
            context.HttpContext
                   .Response
                   .Redirect(destinationUrl, result.Permanent);
        }
        
        return Task.CompletedTask;
    }
}

```

##### 2.4.4 redirect to page result

###### 2.4.4.1 result

```c#
public class RedirectToPageResult : ActionResult, IKeepTempDataResult
{
    public IUrlHelper UrlHelper { get; set; }    
    
    public string PageName { get; set; }        
    public string PageHandler { get; set; }        
    public RouteValueDictionary RouteValues { get; set; }        
    public bool Permanent { get; set; }        
    public bool PreserveMethod { get; set; }        
    public string Fragment { get; set; }    
    
    public string Protocol { get; set; }        
    public string Host { get; set; }
    
    public RedirectToPageResult(string pageName)
        : this(
            pageName, 
            routeValues: null)
    {
    }
        
    public RedirectToPageResult(
        string pageName, 
        string pageHandler)
        	: this(
                pageName, 
                pageHandler, 
                routeValues: null)
    {
    }
        
    public RedirectToPageResult(
        string pageName, 
        object routeValues)
        	: this(
                pageName, 
                pageHandler: null, 
                routeValues: routeValues, 
                permanent: false)
    {
    }
        
    public RedirectToPageResult(
        string pageName, 
        string pageHandler, 
        object routeValues)
        	: this(
                pageName, 
                pageHandler, 
                routeValues, 
                permanent: false)
    {
    }
        
    public RedirectToPageResult(
        string pageName,
        string pageHandler,
        object routeValues,
        bool permanent)
        	: this(
                pageName, 
                pageHandler, 
                routeValues, 
                permanent, 
                fragment: null)
    {
    }
        
    public RedirectToPageResult(
        string pageName,
        string pageHandler,
        object routeValues,
        bool permanent,
        bool preserveMethod)
	        : this(
                pageName, 
                pageHandler, 
                routeValues, 
                permanent, 
                preserveMethod, 
                fragment: ull)
    {
    }
        
    public RedirectToPageResult(
        string pageName,
        string pageHandler,
        object routeValues,
        string fragment)
        	: this(
                pageName, 
                pageHandler, 
                routeValues, 
                permanent: false, 
                fragment: fragment)
    {
    }
       
    public RedirectToPageResult(
        string pageName,
        string pageHandler,
        object routeValues,
        bool permanent,
        string fragment)
        	: this(
                pageName, 
                pageHandler, 
                routeValues, 
                permanent, 
                preserveMethod: false, 
                fragment: fragment)
    {
    }
        
    public RedirectToPageResult(
        string pageName,
        string pageHandler,
        object routeValues,
        bool permanent,
        bool preserveMethod,
        string fragment)
    {
        PageName = pageName;
        PageHandler = pageHandler;
        RouteValues = routeValues == null ? null : new RouteValueDictionary(routeValues);
        PreserveMethod = preserveMethod;
        Permanent = permanent;
        Fragment = fragment;
    }
                
    /// <inheritdoc />
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        // 从 action context 中解析 redirect to page result executor
        var executor = 
            context.HttpContext
	               .RequestServices
       		       .GetRequiredService<IActionResultExecutor<RedirectToPageResult>>();
        // 使用 executor 执行 execute
        return executor.ExecuteAsync(context, this);
    }
}

```

###### 2.4.4.2 executor

```c#
public class RedirectToPageResultExecutor 
    : IActionResultExecutor<RedirectToPageResult>
{
    private readonly ILogger _logger;
    private readonly IUrlHelperFactory _urlHelperFactory;
        
    public RedirectToPageResultExecutor(
        ILoggerFactory loggerFactory, 
        IUrlHelperFactory urlHelperFactory)
    {
        if (loggerFactory == null)
        {
            throw new ArgumentNullException(nameof(loggerFactory));
        }        
        if (urlHelperFactory == null)
        {
            throw new ArgumentNullException(nameof(urlHelperFactory));
        }
        
        _logger = loggerFactory.CreateLogger<RedirectToRouteResult>();
        _urlHelperFactory = urlHelperFactory;
    }
    
        /// <inheritdoc />
    public virtual Task ExecuteAsync(
        ActionContext context, 
        RedirectToPageResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        /* 解析 destination url */
        var urlHelper = result.UrlHelper ?? _urlHelperFactory.GetUrlHelper(context);
        
        var destinationUrl = urlHelper.Page(
            result.PageName,
            result.PageHandler,
            result.RouteValues,
            result.Protocol,
            result.Host,
            fragment: result.Fragment);
        
        if (string.IsNullOrEmpty(destinationUrl))
        {
            throw new InvalidOperationException(
                Resources.FormatNoRoutesMatchedForPage(result.PageName));
        }
        
        _logger.RedirectToPageResultExecuting(result.PageName);
        
        /* 如果 preserve method = true */
        if (result.PreserveMethod)
        {
            // 返回 307 或 308
            context.HttpContext
                   .Response
                   .StatusCode = result.Permanent 
                					? StatusCodes.Status308PermanentRedirect 
                					: StatusCodes.Status307TemporaryRedirect;
            // 重写 http response header 的 location
            context.HttpContext
                   .Response
                   .Headers[HeaderNames.Location] = destinationUrl;
        }
        /* 否则，即 preserve method = false */
        else
        {
            // 调用 http response 的 redirect 方法
            context.HttpContext.Response.Redirect(destinationUrl, result.Permanent);
        }
        
        return Task.CompletedTask;
    }
}

```

##### 2.4.5 redirect to route result

###### 2.4.5.1 result

```c#
public class RedirectToRouteResult : 
	ActionResult, 
	IKeepTempDataResult
{
    public IUrlHelper UrlHelper { get; set; }
        
    public string RouteName { get; set; }        
    public RouteValueDictionary RouteValues { get; set; }        
    public bool Permanent { get; set; }       
    public bool PreserveMethod { get; set; }        
    public string Fragment { get; set; }
    
    public RedirectToRouteResult(object routeValues)
        : this(
            routeName: null, 
            routeValues: routeValues)
    {
    }
        
    public RedirectToRouteResult(
        string routeName,
        object routeValues)
        	: this(
                routeName, 
                routeValues, 
                permanent: false)
    {
    }
        
    public RedirectToRouteResult(
        string routeName,
        object routeValues,
        bool permanent)
        	: this(
                routeName, 
                routeValues, 
                permanent, 
                fragment: null)
    {
    }
        
    public RedirectToRouteResult(
        string routeName,
        object routeValues,
        bool permanent,
        bool preserveMethod)
        	: this(
                routeName, 
                routeValues, 
                permanent, 
                preserveMethod, 
                fragment: null)
    {
    }
        
    public RedirectToRouteResult(
        string routeName,
        object routeValues,
        string fragment)
        	: this(
                routeName, 
                routeValues, 
                permanent: false, 
                fragment: fragment)
    {
    }
        
    public RedirectToRouteResult(
        string routeName,
        object routeValues,
        bool permanent,
        string fragment)
        	: this(
                routeName, 
                routeValues, 
                permanent, 
                preserveMethod: false, 
                fragment: fragment)
    {
    }
        
    public RedirectToRouteResult(
        string routeName,
        object routeValues,
        bool permanent,
        bool preserveMethod,
        string fragment)
    {
        RouteName = routeName;
        RouteValues = routeValues == null ? null : new RouteValueDictionary(routeValues);
        PreserveMethod = preserveMethod;
        Permanent = permanent;
        Fragment = fragment;
    }
            
    /// <inheritdoc />
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        // 从 action context 解析 redirect to route result executor
        var executor = 
            context.HttpContext
	               .RequestServices
    	           .GetRequiredService<IActionResultExecutor<RedirectToRouteResult>>();
        // 使用 executor 执行 execute
        return executor.ExecuteAsync(context, this);
    }
}

```

###### 2.4.5.2 executor

```c#
public class RedirectToRouteResultExecutor : IActionResultExecutor<RedirectToRouteResult>
{
    private readonly ILogger _logger;
    private readonly IUrlHelperFactory _urlHelperFactory;
        
    public RedirectToRouteResultExecutor(
        ILoggerFactory loggerFactory, 
        IUrlHelperFactory urlHelperFactory)
    {
        if (loggerFactory == null)
        {
            throw new ArgumentNullException(nameof(loggerFactory));
        }        
        if (urlHelperFactory == null)
        {
            throw new ArgumentNullException(nameof(urlHelperFactory));
        }
        
        _logger = loggerFactory.CreateLogger<RedirectToRouteResult>();
        _urlHelperFactory = urlHelperFactory;
    }
    
    /// <inheritdoc />
    public virtual Task ExecuteAsync(
        ActionContext context, 
        RedirectToRouteResult result)
    {
        /* 解析 destination url */
        var urlHelper = result.UrlHelper ?? _urlHelperFactory.GetUrlHelper(context);
        
        var destinationUrl = urlHelper.RouteUrl(
            result.RouteName,
            result.RouteValues,
            protocol: null,
            host: null,
            fragment: result.Fragment);
        
        if (string.IsNullOrEmpty(destinationUrl))
        {
            throw new InvalidOperationException(Resources.NoRoutesMatched);
        }
        
        _logger.RedirectToRouteResultExecuting(destinationUrl, result.RouteName);
        
        /* 如果 preserve method = true */
        if (result.PreserveMethod)
        {
            // 返回 307 或 308 
            context.HttpContext
                   .Response
                   .StatusCode = result.Permanent 
                					? StatusCodes.Status308PermanentRedirect 
                					: StatusCodes.Status307TemporaryRedirect;
            // 重写 http response header 的 location
            context.HttpContext
                   .Response
                   .Headers[HeaderNames.Location] = destinationUrl;
        }
        /* 否则，即 preserve method = false */
        else
        {
            // 调用 http response 的 redirect 方法
            context.HttpContext.Response.Redirect(destinationUrl, result.Permanent);
        }
        
        return Task.CompletedTask;
    }
}

```



#### 2.5 status code action result 

```c#
public interface IStatusCodeActionResult : IActionResult
{    
    int? StatusCode { get; }
}

```

##### 2.5.1 content result

###### 2.5.1.1 result

```c#
public class ContentResult : 
	ActionResult, 
	IStatusCodeActionResult
{    
    public string Content { get; set; }        
    public string ContentType { get; set; }        
    public int? StatusCode { get; set; }
    
    /// <inheritdoc />
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        // 解析 content result executor 
        var executor = 
            context.HttpContext
            	   .RequestServices
            	   .GetRequiredService<IActionResultExecutor<ContentResult>>();
        // 使用 content result executor 的 execute 方法
        return executor.ExecuteAsync(context, this);
    }
}

```

###### 2.5.1.2 executor

```c#
public class ContentResultExecutor : IActionResultExecutor<ContentResult>
{
    private const string DefaultContentType = "text/plain; charset=utf-8";
    
    private readonly ILogger<ContentResultExecutor> _logger;
    private readonly IHttpResponseStreamWriterFactory _httpResponseStreamWriterFactory;
        
    public ContentResultExecutor(
        ILogger<ContentResultExecutor> logger, 
        IHttpResponseStreamWriterFactory httpResponseStreamWriterFactory)
    {
        _logger = logger;
        _httpResponseStreamWriterFactory = httpResponseStreamWriterFactory;
    }
    
    /// <inheritdoc />
    public virtual async Task ExecuteAsync(
        ActionContext context, 
        ContentResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        var response = context.HttpContext.Response;
        
        // 解析 resolved content type 和 resolved content type encoding
        ResponseContentTypeHelper
            .ResolveContentTypeAndEncoding(
	            result.ContentType,
    	        response.ContentType,
        	    DefaultContentType,
            	out var resolvedContentType,
	            out var resolvedContentTypeEncoding);
        
        // 重写 http response 的 content type
        response.ContentType = resolvedContentType;
        
        // 重写 http response 的 status code
        if (result.StatusCode != null)
        {
            response.StatusCode = result.StatusCode.Value;
        }
        
        _logger.ContentResultExecuting(resolvedContentType);
        
        // 向 http response 中写入 result.content        
        if (result.Content != null)
        {
            response.ContentLength = 
                resolvedContentTypeEncoding.GetByteCount(result.Content);
            
            // 使用注入的 http response stream writer factory 创建 writer
            await using (var textWriter = _
                         httpResponseStreamWriterFactory
                         	.CreateWriter(
                                response.Body, 
                                resolvedContentTypeEncoding))
            {
                /* 写入 content */
                await textWriter.WriteAsync(result.Content);
                
                // Flushing the HttpResponseStreamWriter does not flush the underlying stream.
                // This just flushes the buffered text in the writer.
                // We do this rather than letting dispose handle it because 
                // dispose would call Write and we want to call WriteAsync.
                await textWriter.FlushAsync();
            }
        }
    }
}

```

##### 2.5.2 json result

###### 2.5.2.1 result

```c#
public class JsonResult : 
	ActionResult, 
	IStatusCodeActionResult
{
    public string ContentType { get; set; }                    
    public int? StatusCode { get; set; }
    
    public object Value { get; set; } 
    public object SerializerSettings { get; set; }
            
    public JsonResult(object value)
    {
        Value = value;
    }
            
    public JsonResult(object value, object serializerSettings)
    {
        Value = value;
        SerializerSettings = serializerSettings;
    }
                   
    /// <inheritdoc />
    public override Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {                
            throw new ArgumentNullException(nameof(context));            
        }
        // 从 action context 解析 json result executor
        var services = context.HttpContext.RequestServices;
        var executor = services.GetRequiredService<IActionResultExecutor<JsonResult>>();
        // 使用 executor 执行 execute
        return executor.ExecuteAsync(context, this);
    }
}

```



###### 2.5.2.2 executor

```c#
internal sealed class SystemTextJsonResultExecutor : IActionResultExecutor<JsonResult>
{
    // content type = “application/json"
    private static readonly string DefaultContentType = 
        new MediaTypeHeaderValue("application/json")
    	{
        	Encoding = Encoding.UTF8
    	}
    	.ToString();
    
    private readonly JsonOptions _options;
    private readonly ILogger<SystemTextJsonResultExecutor> _logger;
    private readonly AsyncEnumerableReader _asyncEnumerableReaderFactory;
    
    public SystemTextJsonResultExecutor(
        IOptions<JsonOptions> options,
        ILogger<SystemTextJsonResultExecutor> logger,
        IOptions<MvcOptions> mvcOptions)
    {
        _options = options.Value;
        _logger = logger;
        _asyncEnumerableReaderFactory = new AsyncEnumerableReader(mvcOptions.Value);
    }
    
    public async Task ExecuteAsync(
        ActionContext context, 
        JsonResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        var jsonSerializerOptions = GetSerializerOptions(result);        
        var response = context.HttpContext.Response;
        
        // 解析 content type 和 content type encoding
        ResponseContentTypeHelper.ResolveContentTypeAndEncoding(
            result.ContentType,
            response.ContentType,
            DefaultContentType,
            out var resolvedContentType,
            out var resolvedContentTypeEncoding);
        
        // 向 response 中写入 content type        
        response.ContentType = resolvedContentType;
        
        if (result.StatusCode != null)
        {
            response.StatusCode = result.StatusCode.Value;
        }
        
        Log.JsonResultExecuting(_logger, result.Value);
        
        /* 异步读取 result 的 value */
        var value = result.Value;
        if (value != null && 
            _asyncEnumerableReaderFactory
            	.TryGetReader(value.GetType(), out var reader))
        {
            Log.BufferingAsyncEnumerable(_logger, value);
            value = await reader(value);
        }
        
        var objectType = value?.GetType() ?? typeof(object);
        
        // Keep this code in sync with SystemTextJsonOutputFormatter
        var responseStream = response.Body;
        
        /* 如果是 utf8 */
        if (resolvedContentTypeEncoding.CodePage == Encoding.UTF8.CodePage)
        {
            // 序列化 value
            await JsonSerializer.SerializeAsync(
                responseStream, 
                value, 
                objectType, 
                jsonSerializerOptions);
            // 写入 response
            await responseStream.FlushAsync();
        }
        /* 否则，即不是 utf8 */
        else
        {
            /* 编码 */
            // JsonSerializer only emits UTF8 encoded output, 
            // but we need to write the response in the encoding specified by
            // selectedEncoding
            var transcodingStream = Encoding.CreateTranscodingStream(
                response.Body, 
                resolvedContentTypeEncoding, 
                Encoding.UTF8, 
                leaveOpen: true);
            
            ExceptionDispatchInfo? exceptionDispatchInfo = null;
            try
            {
                // 序列化编码后的 value
                await JsonSerializer.SerializeAsync(
                    transcodingStream, 
                    value, 
                    objectType, 
                    jsonSerializerOptions);
                // 写入 response
                await transcodingStream.FlushAsync();
            }
            catch (Exception ex)
            {
                // TranscodingStream may write to the inner stream as part of it's disposal.
                // We do not want this exception "ex" to be eclipsed 
                // by any exception encountered during the write. 
                // We will stash it and explicitly rethrow it during the finally block.
                exceptionDispatchInfo = ExceptionDispatchInfo.Capture(ex);
            }
            finally
            {
                try
                {
                    await transcodingStream.DisposeAsync();
                }
                catch when (exceptionDispatchInfo != null)
                {
                }
                
                exceptionDispatchInfo?.Throw();
            }
        }
    }
    
    // 解析 json serialize options    
    private JsonSerializerOptions GetSerializerOptions(JsonResult result)
    {
        var serializerSettings = result.SerializerSettings;
        if (serializerSettings == null)
        {
            return _options.JsonSerializerOptions;
        }
        else
        {
            if (serializerSettings is not JsonSerializerOptions settingsFromResult)
            {
                throw new InvalidOperationException(
                    Resources.FormatProperty_MustBeInstanceOfType(
	                    nameof(JsonResult),
    	                nameof(JsonResult.SerializerSettings),
        	            typeof(JsonSerializerOptions)));
            }
            
            return settingsFromResult;
        }
    }
    
    private static class Log
    {
        private static readonly Action<ILogger, string?, Exception?> 
            _jsonResultExecuting = 
            	LoggerMessage.Define<string?>(
		            LogLevel.Information,
    		        new EventId(1, "JsonResultExecuting"),
        		    "Executing JsonResult, writing value of type '{Type}'.");
        
        private static readonly Action<ILogger, string?, Exception?> 
            _bufferingAsyncEnumerable = 
            	LoggerMessage.Define<string?>(
		            LogLevel.Debug,
        		    new EventId(2, "BufferingAsyncEnumerable"),
		            "Buffering IAsyncEnumerable instance of type '{Type}'.");
        
        public static void JsonResultExecuting(ILogger logger, object value)
        {
            if (logger.IsEnabled(LogLevel.Information))
            {
                var type = value == null ? "null" : value.GetType().FullName;
                _jsonResultExecuting(logger, type, null);
            }
        }
        
        public static void BufferingAsyncEnumerable(ILogger logger, object asyncEnumerable)
        {
            if (logger.IsEnabled(LogLevel.Debug))
            {
                _bufferingAsyncEnumerable(logger, asyncEnumerable.GetType().FullName, null);
            }
        }
    }
}

```

##### 2.5.3 object result

###### 2.5.3.1 result

```c#
public class ObjectResult : 
	ActionResult, 
	IStatusCodeActionResult
{
    private MediaTypeCollection _contentTypes;
    public MediaTypeCollection ContentTypes
    {
        get => _contentTypes;
        set => _contentTypes = value ?? throw new ArgumentNullException(nameof(value));
    }
        
    public int? StatusCode { get; set; }    
    [ActionResultObjectValue]
    public object Value { get; set; }
    public Type DeclaredType { get; set; }    
    public FormatterCollection<IOutputFormatter> Formatters { get; set; }
                                                
    public ObjectResult(object value)
    {
        Value = value;
        Formatters = new FormatterCollection<IOutputFormatter>();
        _contentTypes = new MediaTypeCollection();
    }
                
    /// <inheritdoc/>
    public override Task ExecuteResultAsync(ActionContext context)
    {
        // 从 action context 中解析 object result executor
        var executor = 
            context.HttpContext
	               .RequestServices
       		       .GetRequiredService<IActionResultExecutor<ObjectResult>>();
        // 使用 executor 执行 execute
        return executor.ExecuteAsync(context, this);
    }
    
    // for executor
    public virtual void OnFormatting(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        if (Value is ProblemDetails details)
        {
            if (details.Status != null && 
                StatusCode == null)
            {
                StatusCode = details.Status;
            }
            else if (details.Status == null && 
                     StatusCode != null)
            {
                details.Status = StatusCode;
            }
        }
        
        if (StatusCode.HasValue)
        {
            context.HttpContext
                   .Response
                   .StatusCode = StatusCode.Value;
        }
    }
}

```



###### 2.5.3.2 executor

```c#
public class ObjectResultExecutor : IActionResultExecutor<ObjectResult>
{    
    private readonly AsyncEnumerableReader _asyncEnumerableReaderFactory;
    
    protected OutputFormatterSelector FormatterSelector { get; }
    protected Func<Stream, Encoding, TextWriter> WriterFactory { get; }
    protected ILogger Logger { get; }
                       
    public ObjectResultExecutor(
        OutputFormatterSelector formatterSelector,
        IHttpResponseStreamWriterFactory writerFactory,
        ILoggerFactory loggerFactory,
        IOptions<MvcOptions> mvcOptions)
    {
        if (formatterSelector == null)
        {
            throw new ArgumentNullException(nameof(formatterSelector));
        }        
        if (writerFactory == null)
        {
            throw new ArgumentNullException(nameof(writerFactory));
        }        
        if (loggerFactory == null)
        {
            throw new ArgumentNullException(nameof(loggerFactory));
        }
        
        /* 注入服务*/
        FormatterSelector = formatterSelector;
        WriterFactory = writerFactory.CreateWriter;
        Logger = loggerFactory.CreateLogger<ObjectResultExecutor>();
        
        /* 创建 async reader */
        var options = mvcOptions?.Value ?? throw new ArgumentNullException(nameof(mvcOptions));
        _asyncEnumerableReaderFactory = new AsyncEnumerableReader(options);
    }
                   
    public virtual Task ExecuteAsync(
        ActionContext context, 
        ObjectResult result)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }        
        if (result == null)
        {
            throw new ArgumentNullException(nameof(result));
        }
        
        // a - 推断 content type
        InferContentTypes(context, result);
        
        /* 设置 object type，
           从 result 中的 declare type 解析，
           如果 declare type 为 null 或者 object，设置为 value 的类型 */
        var objectType = result.DeclaredType;
        
        if (objectType == null || 
            objectType == typeof(object))
        {
            objectType = result.Value?.GetType();
        }
        
        /* 异步解析 value */
        var value = result.Value;
        
        if (value != null && 
            _asyncEnumerableReaderFactory
            	.TryGetReader(value.GetType(), out var reader))
        {
            // b - execute enumerable
            return ExecuteAsyncEnumerable(context, result, value, reader);
        }
        
        // c - execute core
        return ExecuteAsyncCore(context, result, objectType, value);
    }
    
    // a - 推断 content type
    private static void InferContentTypes(
        ActionContext context, 
        ObjectResult result)
    {
        /* 如果 result 中存在 content type，
           即认为 result 的 content type 完成设置，返回 */
        Debug.Assert(result.ContentTypes != null);
        if (result.ContentTypes.Count != 0)
        {
            return;
        }
        
        /* 添加 content type */
        // If the user sets the content type both on the ObjectResult 
        // (example: by Produces) and Response object,
        // then the one set on ObjectResult takes precedence over the Response object
        var responseContentType = context.HttpContext.Response.ContentType;
        if (!string.IsNullOrEmpty(responseContentType))
        {
            // 如果 http response 的 content type 不为空，添加
            result.ContentTypes.Add(responseContentType);
        }
        else if (result.Value is ProblemDetails)
        {
            // 如果 result.value 是 problemdetails，添加下列 content type            
            result.ContentTypes.Add("application/problem+json");
            result.ContentTypes.Add("application/problem+xml");
        }
    }
    
    // b -
    private async Task ExecuteAsyncEnumerable(
        ActionContext context, 
        ObjectResult result, 
        object asyncEnumerable, 
        Func<object, Task<ICollection>> reader)
    {
        Log.BufferingAsyncEnumerable(Logger, asyncEnumerable);
        // 获取 enumerable 类型
        var enumerated = await reader(asyncEnumerable);
        await ExecuteAsyncCore(context, result, enumerated.GetType(), enumerated);
    }
    
    // c -
    private Task ExecuteAsyncCore(
        ActionContext context, 
        ObjectResult result, 
        Type? objectType, 
        object? value)
    {
        // 创建 formatter context，即注入 object 相关信息
        var formatterContext = new OutputFormatterWriteContext(
            context.HttpContext,
            WriterFactory,
            objectType,
            value);
        
        // 解析 formatter
        var selectedFormatter = FormatterSelector.SelectFormatter(
            formatterContext,
            (IList<IOutputFormatter>)result.Formatters ?? Array.Empty<IOutputFormatter>(),
            result.ContentTypes);
        
        // formatter 为 null，即不支持 format，返回 406
        if (selectedFormatter == null)
        {
            // No formatter supports this.
            Logger.NoFormatter(formatterContext, result.ContentTypes);
            
            context.HttpContext.Response.StatusCode = StatusCodes.Status406NotAcceptable;
            return Task.CompletedTask;
        }
        
        Logger.ObjectResultExecuting(result, value);
        
        // 使用 formatter 将 result value 写入 http response
        result.OnFormatting(context);
        return selectedFormatter.WriteAsync(formatterContext);
    }
            
    private static class Log
    {
        private static readonly Action<ILogger, string?, Exception?> _bufferingAsyncEnumerable;
        
        static Log()
        {
            _bufferingAsyncEnumerable = LoggerMessage.Define<string?>(
                LogLevel.Debug,
                new EventId(1, "BufferingAsyncEnumerable"),
                "Buffering IAsyncEnumerable instance of type '{Type}'.");
        }
        
        public static void BufferingAsyncEnumerable(ILogger logger, object asyncEnumerable)
        {
            if (logger.IsEnabled(LogLevel.Debug))
            {
                _bufferingAsyncEnumerable(logger, asyncEnumerable.GetType().FullName, null);
            }
        }
    }
}

```

###### 2.5.3.3 default states code attribute

```c#
[AttributeUsage(
    AttributeTargets.Class, 
    AllowMultiple = false, 
    Inherited = true)]
public sealed class DefaultStatusCodeAttribute : Attribute
{
    public int StatusCode { get; }
    
    public DefaultStatusCodeAttribute(int statusCode)
    {
        StatusCode = statusCode;
    }            
}

```

###### 2.5.3.4 action result object value attribute

```c#
// Attribute annotated on ActionResult constructor, helper method parameters, 
// and properties to indicate that the parameter or property is used 
// to set the "value" for ActionResult.
[AttributeUsage(
    AttributeTargets.Parameter | AttributeTargets.Property, 
    AllowMultiple = false, Inherited = false)]
public sealed class ActionResultObjectValueAttribute : Attribute
{
}

```

##### 2.5.4 object result 派生类

###### 2.5.4.1 -200 ok object result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class OkObjectResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status200OK;
        
    public OkObjectResult(object value) : base(value)
    {
        StatusCode = DefaultStatusCode;
    }
}

```

###### 2.5.4.2 -201 create result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class CreatedResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status201Created;
    
    private string _location;
    public string Location
    {
        get => _location;
        set
        {
            if (value == null)
            {
                throw new ArgumentNullException(nameof(value));
            }
            
            _location = value;
        }
    }
        
    public CreatedResult(
        string location, 
        object value) : base(value)
    {
        if (location == null)
        {
            throw new ArgumentNullException(nameof(location));
        }
        
        Location = location;
        StatusCode = DefaultStatusCode;
    }
            
    public CreatedResult(
        Uri location, 
        object value) : base(value)
    {
        if (location == null)
        {
            throw new ArgumentNullException(nameof(location));
        }
        
        if (location.IsAbsoluteUri)
        {
            Location = location.AbsoluteUri;
        }
        else
        {
            Location = location.GetComponents(
                					UriComponents.SerializationInfoString, 
                					UriFormat.UriEscaped);
        }
        
        StatusCode = DefaultStatusCode;
    }
            
    public override void OnFormatting(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        base.OnFormatting(context);        
        context.HttpContext
               .Response
               .Headers[HeaderNames.Location] = Location;
    }
}

// create at ation result
[DefaultStatusCode(DefaultStatusCode)]
public class CreatedAtActionResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status201Created;
    
    public IUrlHelper UrlHelper { get; set; }
        
    public string ActionName { get; set; }        
    public string ControllerName { get; set; }        
    public RouteValueDictionary RouteValues { get; set; }
    
    public CreatedAtActionResult(
        string actionName,
        string controllerName,
        object routeValues,
        [ActionResultObjectValue] object value) : base(value)
    {
        ActionName = actionName;
        ControllerName = controllerName;
        RouteValues = routeValues == null ? null : new RouteValueDictionary(routeValues);
        StatusCode = DefaultStatusCode;
    }
                   
    /// <inheritdoc />
    public override void OnFormatting(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        base.OnFormatting(context);
                
        var request = context.HttpContext.Request;
        
        /* 解析 url */
        var urlHelper = UrlHelper;
        if (urlHelper == null)
        {
            var services = context.HttpContext.RequestServices;
            urlHelper = services.GetRequiredService<IUrlHelperFactory>().GetUrlHelper(context);
        }
        
        var url = urlHelper.Action(
            					ActionName,
					            ControllerName,
					            RouteValues,
					            request.Scheme,
					            request.Host.ToUriComponent());
        
        if (string.IsNullOrEmpty(url))
        {
            throw new InvalidOperationException(Resources.NoRoutesMatched);
        }
        
        /* 重写 http response header 的 location */
        context.HttpContext.Response.Headers[HeaderNames.Location] = url;
    }
}

// create at route result
[DefaultStatusCode(DefaultStatusCode)]
public class CreatedAtRouteResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status201Created;
        
    public IUrlHelper UrlHelper { get; set; }       
    public string RouteName { get; set; }        
    public RouteValueDictionary RouteValues { get; set; }
    
    public CreatedAtRouteResult(
        object routeValues, 
        [ActionResultObjectValue] object value)            
        	: this(
                routeName: null, 
                routeValues: 
                routeValues, 
                value: value)        
    {
    }
            
    public CreatedAtRouteResult(
        string routeName,
        object routeValues,
        [ActionResultObjectValue] object value) : base(value)
    {
        RouteName = routeName;
        RouteValues = routeValues == null ? null : new RouteValueDictionary(routeValues);
        StatusCode = DefaultStatusCode;
    }
                
    /// <inheritdoc />
    public override void OnFormatting(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        base.OnFormatting(context);
        
        /* 解析 url */
        var urlHelper = UrlHelper;
        if (urlHelper == null)
        {
            var services = context.HttpContext.RequestServices;
            urlHelper = services.GetRequiredService<IUrlHelperFactory>().GetUrlHelper(context);
        }
        
        var url = urlHelper.Link(RouteName, RouteValues);
        
        if (string.IsNullOrEmpty(url))
        {
            throw new InvalidOperationException(Resources.NoRoutesMatched);
        }
        
        /* 重写 http response header 的 location */
        context.HttpContext.Response.Headers[HeaderNames.Location] = url;
    }
}

```

###### 2.5.4.3 -202 accepted result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class AcceptedResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status202Accepted;
    
    public string Location { get; set; }
    
    public AcceptedResult() : base(value: null)
    {
        StatusCode = DefaultStatusCode;
    }
            
    public AcceptedResult(
        string location, 
        [ActionResultObjectValue] object value) : base(value)
    {
        Location = location;
        StatusCode = DefaultStatusCode;
    }
            
    public AcceptedResult(
        Uri locationUri, 
        [ActionResultObjectValue] object value) : base(value)
    {
        if (locationUri == null)
        {
            throw new ArgumentNullException(nameof(locationUri));
        }
        
        if (locationUri.IsAbsoluteUri)
        {
            Location = locationUri.AbsoluteUri;
        }
        else
        {
            Location = locationUri.GetComponents(
                					   UriComponents.SerializationInfoString, 
                					   UriFormat.UriEscaped);
        }
        
        StatusCode = DefaultStatusCode;
    }
        
    /// <inheritdoc />
    public override void OnFormatting(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        base.OnFormatting(context);
        
        if (!string.IsNullOrEmpty(Location))
        {
            // 重写 http response header 的 location
            context.HttpContext.Response.Headers[HeaderNames.Location] = Location;
        }
    }
}

[DefaultStatusCode(DefaultStatusCode)]
public class AcceptedAtActionResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status202Accepted;
    
    public IUrlHelper UrlHelper { get; set; }
        
    public string ActionName { get; set; }        
    public string ControllerName { get; set; }        
    public RouteValueDictionary RouteValues { get; set; }
        
    public AcceptedAtActionResult(
        string actionName,
        string controllerName,
        object routeValues,
        [ActionResultObjectValue] object value) : base(value)
    {
        ActionName = actionName;
        ControllerName = controllerName;
        RouteValues = routeValues == null ? null : new RouteValueDictionary(routeValues);
        StatusCode = DefaultStatusCode;
    }
                
    /// <inheritdoc />
    public override void OnFormatting(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        base.OnFormatting(context);
        
        var request = context.HttpContext.Request;
        
        /* 解析 url */
        var urlHelper = UrlHelper;
        if (urlHelper == null)
        {
            var services = context.HttpContext.RequestServices;
            urlHelper = services.GetRequiredService<IUrlHelperFactory>().GetUrlHelper(context);
        }
        
        var url = urlHelper.Action(
            ActionName,
            ControllerName,
            RouteValues,
            request.Scheme,
            request.Host.ToUriComponent());
        
        if (string.IsNullOrEmpty(url))
        {
            throw new InvalidOperationException(Resources.NoRoutesMatched);
        }
        
        /* 重写 http response header 的 location 为 url */
        context.HttpContext.Response.Headers[HeaderNames.Location] = url;
    }
}

[DefaultStatusCode(DefaultStatusCode)]
public class AcceptedAtRouteResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status202Accepted;
           
    public IUrlHelper UrlHelper { get; set; }
            
    public string RouteName { get; set; }        
    public RouteValueDictionary RouteValues { get; set; }
    
    public AcceptedAtRouteResult(
        object routeValues, 
        [ActionResultObjectValue] object value)            
        	: this(
                routeName: null, 
                routeValues: routeValues, 
                value: value)
    {
    }
            
    public AcceptedAtRouteResult(
        string routeName,
        object routeValues,
        [ActionResultObjectValue] object value) : base(value)
    {
        RouteName = routeName;
        RouteValues = routeValues == null ? null : new RouteValueDictionary(routeValues);
        StatusCode = DefaultStatusCode;
    }
    
    /// <inheritdoc />
    public override void OnFormatting(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        base.OnFormatting(context);
        
        /* 解析 url */
        var urlHelper = UrlHelper;
        if (urlHelper == null)
        {
            var services = context.HttpContext.RequestServices;
            urlHelper = services.GetRequiredService<IUrlHelperFactory>().GetUrlHelper(context);
        }
        
        var url = urlHelper.Link(RouteName, RouteValues);
        
        if (string.IsNullOrEmpty(url))
        {
            throw new InvalidOperationException(Resources.NoRoutesMatched);
        }
        
        /* 重写 http response header 的 location 为 url */
        context.HttpContext.Response.Headers[HeaderNames.Location] = url;
    }
}

```

###### 2.5.4.4 -400 bad request object result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class BadRequestObjectResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status400BadRequest;
            
    public BadRequestObjectResult([ActionResultObjectValue] object error) : base(error)
    {
        StatusCode = DefaultStatusCode;
    }
            
    public BadRequestObjectResult(
        [ActionResultObjectValue] ModelStateDictionary modelState)            
        	: base(new SerializableError(modelState))
    {
        if (modelState == null)
        {
            throw new ArgumentNullException(nameof(modelState));
        }
        
        StatusCode = DefaultStatusCode;
    }
}

```

###### 2.5.4.5 -401 unauthorized object result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class UnauthorizedObjectResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status401Unauthorized;
        
    public UnauthorizedObjectResult(
        [ActionResultObjectValue] object value) : base(value)
    {
        StatusCode = DefaultStatusCode;
    }
}

```

###### 2.5.4.6 -404 not found object result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class NotFoundObjectResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status404NotFound;
        
    public NotFoundObjectResult([ActionResultObjectValue] object value) : base(value)
    {
        StatusCode = DefaultStatusCode;
    }
}

```

###### 2.5.4.7 -409 conflict object result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class ConflictObjectResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status409Conflict;
        
    public ConflictObjectResult([ActionResultObjectValue] object error) : base(error)
    {
        StatusCode = DefaultStatusCode;
    }
        
    public ConflictObjectResult(
        [ActionResultObjectValue] ModelStateDictionary modelState)            
        	: base(new SerializableError(modelState))
    {
        if (modelState == null)
        {
            throw new ArgumentNullException(nameof(modelState));
        }
        
        StatusCode = DefaultStatusCode;
    }
}

```

###### 2.5.4.8 -422 unprocessable entity object result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class UnprocessableEntityObjectResult : ObjectResult
{
    private const int DefaultStatusCode = StatusCodes.Status422UnprocessableEntity;
            
    public UnprocessableEntityObjectResult(
        [ActionResultObjectValue] ModelStateDictionary modelState)            
        	: this(new SerializableError(modelState))
    {
    }
            
    public UnprocessableEntityObjectResult(
        [ActionResultObjectValue] object error) : base(error)
    {
        StatusCode = DefaultStatusCode;
    }
}

```

#### 2.6 problem details

##### 2.6.1 problem details

```c#
[JsonConverter(typeof(ProblemDetailsJsonConverter))]
public class ProblemDetails
{    
    [JsonPropertyName("type")]
    public string Type { get; set; }
    
    [JsonPropertyName("title")]
    public string Title { get; set; }
        
    [JsonPropertyName("status")]
    public int? Status { get; set; }
        
    [JsonPropertyName("detail")]
    public string Detail { get; set; }
        
    [JsonPropertyName("instance")]
    public string Instance { get; set; }
        
    [JsonExtensionData]
    public IDictionary<string, object> Extensions { get; } = new Dictionary<string, object>(StringComparer.Ordinal);
}

```

###### 2.6.1.1 problem details json converter

```c#
internal class ProblemDetailsJsonConverter : JsonConverter<ProblemDetails>
{
    private static readonly JsonEncodedText Type = JsonEncodedText.Encode("type");
    private static readonly JsonEncodedText Title = JsonEncodedText.Encode("title");
    private static readonly JsonEncodedText Status = JsonEncodedText.Encode("status");
    private static readonly JsonEncodedText Detail = JsonEncodedText.Encode("detail");
    private static readonly JsonEncodedText Instance = JsonEncodedText.Encode("instance");
    
    /* read 方法 */
    public override ProblemDetails Read(
        ref Utf8JsonReader reader, 
        Type typeToConvert, 
        JsonSerializerOptions options)
    {
        var problemDetails = new ProblemDetails();
        
        // 如果不是 start object，抛出异常
        if (reader.TokenType != JsonTokenType.StartObject)
        {
            throw new JsonException(Resources.UnexpectedJsonEnd);
        }
        // reader 一直读取
        while (reader.Read() && 
               reader.TokenType != JsonTokenType.EndObject)
        {
            ReadValue(ref reader, problemDetails, options);
        }
        // 如果 reader 不是 end object，抛出异常
        if (reader.TokenType != JsonTokenType.EndObject)
        {
            throw new JsonException(Resources.UnexpectedJsonEnd);
        }
        
        return problemDetails;
    }
    
    

    /* write 方法 */
    public override void Write(
        Utf8JsonWriter writer, 
        ProblemDetails value, 
        JsonSerializerOptions options)
    {
        writer.WriteStartObject();
        WriteProblemDetails(writer, value, options);
        writer.WriteEndObject();
    }

    internal static void ReadValue(
        ref Utf8JsonReader reader, 
        ProblemDetails value, 
        JsonSerializerOptions options)
    {
        // for type
        if (TryReadStringProperty(ref reader, Type, out var propertyValue))
        {
            value.Type = propertyValue;
        }
        // for title
        else if (TryReadStringProperty(ref reader, Title, out propertyValue))
        {
            value.Title = propertyValue;
        }
        // for details
        else if (TryReadStringProperty(ref reader, Detail, out propertyValue))
        {
            value.Detail = propertyValue;
        }
        // for instance
        else if (TryReadStringProperty(ref reader, Instance, out propertyValue))
        {
            value.Instance = propertyValue;
        }
        // status
        else if (reader.ValueTextEquals(Status.EncodedUtf8Bytes))
        {
            reader.Read();
            if (reader.TokenType == JsonTokenType.Null)
            {
                // Nothing to do here.
            }
            else
            {
                value.Status = reader.GetInt32();
            }
        }
        // extensions
        else
        {
            var key = reader.GetString();
            reader.Read();
            value.Extensions[key] = JsonSerializer.Deserialize(
                									  ref reader, 
                									  typeof(object), 
                									  options);
        }
    }
    
    internal static bool TryReadStringProperty(
        ref Utf8JsonReader reader, 
        JsonEncodedText propertyName, 
        [NotNullWhen(true)] out string? value)
    {
        if (!reader.ValueTextEquals(propertyName.EncodedUtf8Bytes))
        {
            value = default;
            return false;
        }
        
        reader.Read();
        value = reader.GetString()!;
        return true;
    }
    
    /* write 方法 */
    
    internal static void WriteProblemDetails(
        Utf8JsonWriter writer, 
        ProblemDetails value, 
        JsonSerializerOptions options)
    {
        // for type
        if (value.Type != null)
        {
            writer.WriteString(Type, value.Type);
        }
        // for title
        if (value.Title != null)
        {
            writer.WriteString(Title, value.Title);
        }
        // for status
        if (value.Status != null)
        {
            writer.WriteNumber(Status, value.Status.Value);
        }
        // for details
        if (value.Detail != null)
        {
            writer.WriteString(Detail, value.Detail);
        }
        // for instance
        if (value.Instance != null)
        {
            writer.WriteString(Instance, value.Instance);
        }
        // for extensions
        foreach (var kvp in value.Extensions)
        {
            writer.WritePropertyName(kvp.Key);
            JsonSerializer.Serialize(
                			   writer, 
                			   kvp.Value, 
                			   kvp.Value?.GetType() ?? typeof(object), 
                			   options);
        }
    }
}

```

##### 2.6.2 validation problem details

```c#
[JsonConverter(typeof(ValidationProblemDetailsJsonConverter))]
public class ValidationProblemDetails : ProblemDetails
{    
    [JsonPropertyName("errors")]
    public IDictionary<string, string[]> Errors { get; } = 
        new Dictionary<string, string[]>(StringComparer.Ordinal);
    
    public ValidationProblemDetails()
    {
        Title = Resources.ValidationProblemDescription_Title;
    }
        
    /* 由 model state dictionary 创建 validation problem details  */
    public ValidationProblemDetails(ModelStateDictionary modelState)      
        : this()
    {
        if (modelState == null)
        {
            throw new ArgumentNullException(nameof(modelState));
        }
        
        foreach (var keyModelStatePair in modelState)
        {
            var key = keyModelStatePair.Key;
            var errors = keyModelStatePair.Value.Errors;
            if (errors != null && errors.Count > 0)
            {
                if (errors.Count == 1)
                {
                    var errorMessage = GetErrorMessage(errors[0]);
                    Errors.Add(key, new[] { errorMessage });
                }
                else
                {
                    var errorMessages = new string[errors.Count];
                    for (var i = 0; i < errors.Count; i++)
                    {
                        errorMessages[i] = GetErrorMessage(errors[i]);
                    }
                    
                    Errors.Add(key, errorMessages);
                }
            }
        }
        
        string GetErrorMessage(ModelError error)
        {
            return string.IsNullOrEmpty(error.ErrorMessage) 
                ? Resources.SerializableError_DefaultError 
                : error.ErrorMessage;            
        }
    }
            
    /* 由 error dictionary 创建 validation problemdetails */
    public ValidationProblemDetails(IDictionary<string, string[]> errors)        
        : this()
    {
        if (errors == null)
        {
            throw new ArgumentNullException(nameof(errors));
        }
        
        Errors = new Dictionary<string, string[]>(errors, StringComparer.Ordinal);
    }          
}

```

###### 2.6.2.1 validation problem details json convert

```c#
internal class ValidationProblemDetailsJsonConverter : JsonConverter<ValidationProblemDetails>
{
    private static readonly JsonEncodedText Errors = JsonEncodedText.Encode("errors");
    
    /* read 方法 */
    public override ValidationProblemDetails Read(
        ref Utf8JsonReader reader, 
        Type typeToConvert, 
        JsonSerializerOptions options)
    {
        var problemDetails = new ValidationProblemDetails();
        
        // 如果不是 start object，抛出异常
        if (reader.TokenType != JsonTokenType.StartObject)
        {
            throw new JsonException(Resources.UnexpectedJsonEnd);
        }
        // reader 一直读取
        while (reader.Read() && 
               reader.TokenType != JsonTokenType.EndObject)
        {
            // 如果读到 "error"，
            if (reader.ValueTextEquals(Errors.EncodedUtf8Bytes))
            {
                // 逆序列化 errors
                var errors = 
                    JsonSerializer.Deserialize<Dictionary<string, string[]>>(
                    				   ref reader, 
                    				   options);
                // 将 errors 注入 problem details
                if (errors is not null)
                {
                    foreach (var item in errors)
                    {
                        problemDetails.Errors[item.Key] = item.Value;
                    }
                }
            }
            // 否则，调用基类方法读取数据（即 title、type等）
            else
            {
                ReadValue(ref reader, problemDetails, options);
            }
        }
        // 如果不是 end object，抛出异常
        if (reader.TokenType != JsonTokenType.EndObject)
        {
            throw new JsonException(Resources.UnexpectedJsonEnd);
        }
        
        return problemDetails;
    }
    
    /* write 方法  */
    public override void Write(
        Utf8JsonWriter writer, 
        ValidationProblemDetails value, 
        JsonSerializerOptions options)
    {
        writer.WriteStartObject();
        WriteProblemDetails(writer, value, options);
        
        writer.WriteStartObject(Errors);
        foreach (var kvp in value.Errors)
        {
            writer.WritePropertyName(kvp.Key);
            JsonSerializer.Serialize(
                			   writer, 
                			   kvp.Value, 
                			   kvp.Value?.GetType() ?? typeof(object), 
                			   options);
        }
        writer.WriteEndObject();
        
        writer.WriteEndObject();
    }
}

```

##### 2.6.3 problem details factory

```c#
public abstract class ProblemDetailsFactory
{    
    public abstract ProblemDetails CreateProblemDetails(
        HttpContext httpContext,
        int? statusCode = null,
        string? title = null,
        string? type = null,
        string? detail = null,
        string? instance = null);
        
    public abstract ValidationProblemDetails CreateValidationProblemDetails(
        HttpContext httpContext,
        ModelStateDictionary modelStateDictionary,
        int? statusCode = null,
        string? title = null,
        string? type = null,
        string? detail = null,
        string? instance = null);
}

```

###### 2.6.3.1 default problem details factory

```c#
internal sealed class DefaultProblemDetailsFactory : ProblemDetailsFactory
{
    private readonly ApiBehaviorOptions _options;
    
    public DefaultProblemDetailsFactory(IOptions<ApiBehaviorOptions> options)
    {
        _options = options?.Value 
            			   ?? throw new ArgumentNullException(nameof(options));
    }
    
    /* 创建 problem details */
    public override ProblemDetails CreateProblemDetails(
        HttpContext httpContext,
        int? statusCode = null,
        string? title = null,
        string? type = null,
        string? detail = null,
        string? instance = null)
    {
        statusCode ??= 500;
        
        var problemDetails = new ProblemDetails
        {
            Status = statusCode,
            Title = title,
            Type = type,
            Detail = detail,
            Instance = instance,
        };
                
        ApplyProblemDetailsDefaults(
            httpContext, 
            problemDetails, 
            statusCode.Value);
        
        return problemDetails;
    }
    
    /* 创建 validation problem details */
    public override ValidationProblemDetails CreateValidationProblemDetails(
        HttpContext httpContext,
        ModelStateDictionary modelStateDictionary,
        int? statusCode = null,
        string? title = null,
        string? type = null,
        string? detail = null,
        string? instance = null)
    {
        if (modelStateDictionary == null)
        {
            throw new ArgumentNullException(nameof(modelStateDictionary));
        }
        
        statusCode ??= 400;
        
        var problemDetails = new ValidationProblemDetails(modelStateDictionary)
        {
            Status = statusCode,
            Type = type,
            Detail = detail,
            Instance = instance,
        };
        
        if (title != null)
        {
            // For validation problem details, don't overwrite the default title with null.
            problemDetails.Title = title;
        }
        
        ApplyProblemDetailsDefaults(
            httpContext, 
            problemDetails, 
            statusCode.Value);
        
        return problemDetails;
    }
    
    // 应用 defaults
    private void ApplyProblemDetailsDefaults(
        HttpContext httpContext, 
        ProblemDetails problemDetails, 
        int statusCode)
    {
        problemDetails.Status ??= statusCode;
        
        if (_options.ClientErrorMapping
            		.TryGetValue(
                        statusCode, 
                        out var clientErrorData))
        {
            problemDetails.Title ??= clientErrorData.Title;
            problemDetails.Type ??= clientErrorData.Link;
        }
        
        var traceId = Activity.Current
            				  ?.Id 
            				  ?? httpContext
            				  ?.TraceIdentifier;
        if (traceId != null)
        {
            problemDetails.Extensions["traceId"] = traceId;
        }
    }
}

```

###### 2.6.3.2 problem details client error factory

```c#
public interface IClientErrorFactory
{    
    IActionResult? GetClientError(
        ActionContext actionContext, 
        IClientErrorActionResult clientError);
}

internal class ProblemDetailsClientErrorFactory : IClientErrorFactory
{
    private readonly ProblemDetailsFactory _problemDetailsFactory;
    
    public ProblemDetailsClientErrorFactory(ProblemDetailsFactory problemDetailsFactory)
    {
        _problemDetailsFactory = 
            problemDetailsFactory 
            	?? throw new ArgumentNullException(nameof(problemDetailsFactory));
    }
    
    public IActionResult GetClientError(
        ActionContext actionContext, 
        IClientErrorActionResult clientError)
    {
        var problemDetails = _problemDetailsFactory.CreateProblemDetails(
            											actionContext.HttpContext, 
            											clientError.StatusCode);
        
        return new ObjectResult(problemDetails)
        {
            StatusCode = problemDetails.Status,
            ContentTypes =
            {
                "application/problem+json",
                "application/problem+xml",
            },
        };
    }
}

```

#### 2.7 client error action result

##### 2.7.1 status code result (base)

```c#
public interface IClientErrorActionResult : IStatusCodeActionResult
{
}

public class StatusCodeResult : 
	ActionResult, 
	IClientErrorActionResult
{
    public int StatusCode { get; }    
    int? IStatusCodeActionResult.StatusCode => StatusCode;
    
    public StatusCodeResult([ActionResultStatusCode] int statusCode)
    {
        StatusCode = statusCode;
    }
                
    /// <inheritdoc />
    public override void ExecuteResult(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        /* 解析 logger 并创建日志 */
        var factory = context
            .HttpContext
            .RequestServices
            .GetRequiredService<ILoggerFactory>();
        
        var logger = factory.CreateLogger<StatusCodeResult>();        
        logger.HttpStatusCodeResultExecuting(StatusCode);
        
        /* 设置 status code */
        context.HttpContext.Response.StatusCode = StatusCode;
    }
}

```

###### 2.7.1.1 action result status code attribute

```c#
// Attribute annotated on ActionResult constructor and 
// helper method parameters to indicate that the parameter 
// is used to set the "statusCode" for the ActionResult.    
[AttributeUsage(
    AttributeTargets.Parameter, 
    AllowMultiple = false, 
    Inherited = false)]
public sealed class ActionResultStatusCodeAttribute : Attribute
{
}

```

##### 2.7.1.2 default status code attribute

```c#
[AttributeUsage(
    AttributeTargets.Class, 
    AllowMultiple = false, 
    Inherited = true)]
public sealed class DefaultStatusCodeAttribute : Attribute
{    
    public int StatusCode { get; }
    
    public DefaultStatusCodeAttribute(int statusCode)
    {
        StatusCode = statusCode;
    }        
}

```

##### 2.7.2 status code result 派生类

###### 2.7.2.1 -200 ok result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class OkResult : StatusCodeResult
{
    private const int DefaultStatusCode = StatusCodes.Status200OK;
        
    public OkResult() : base(DefaultStatusCode)
    {
    }
}

```

###### 2.7.2.2 -204 no content result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class NoContentResult : StatusCodeResult
{
    private const int DefaultStatusCode = StatusCodes.Status204NoContent;
        
    public NoContentResult() : base(DefaultStatusCode)
    {
    }
}

```

###### 2.7.2.3 -400 bad request result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class BadRequestResult : StatusCodeResult
{
    private const int DefaultStatusCode = StatusCodes.Status400BadRequest;
        
    public BadRequestResult() : base(DefaultStatusCode)
    {
    }
}

public interface IAntiforgeryValidationFailedResult : IActionResult
{
}

public class AntiforgeryValidationFailedResult : 
	BadRequestResult, 
	IAntiforgeryValidationFailedResult
{
}

```

###### 2.7.2.4 -401 unauthorization result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class UnauthorizedResult : StatusCodeResult
{
    private const int DefaultStatusCode = StatusCodes.Status401Unauthorized;
        
    public UnauthorizedResult() : base(DefaultStatusCode)
    {
    }
}

```

###### 2.7.2.5 -404 not found result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class NotFoundResult : StatusCodeResult
{
    private const int DefaultStatusCode = StatusCodes.Status404NotFound;
        
    public NotFoundResult() : base(DefaultStatusCode)
    {
    }
}

```

###### 2.7.2.6 -409 conflict result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class ConflictResult : StatusCodeResult
{
    private const int DefaultStatusCode = StatusCodes.Status409Conflict;
        
    public ConflictResult() : base(DefaultStatusCode)
    {
    }
}

```

###### 2.7.2.7 -415 upsupported media type result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class UnsupportedMediaTypeResult : StatusCodeResult
{
    private const int DefaultStatusCode = StatusCodes.Status415UnsupportedMediaType;
        
    public UnsupportedMediaTypeResult() : base(DefaultStatusCode)
    {
    }
}

```

###### 2.7.2.8 -422 unprocessable entity result

```c#
[DefaultStatusCode(DefaultStatusCode)]
public class UnprocessableEntityResult : StatusCodeResult
{
    private const int DefaultStatusCode = StatusCodes.Status422UnprocessableEntity;
        
    public UnprocessableEntityResult() : base(DefaultStatusCode)
    {
    }
}

```

#### 2.8 authenticate result

##### 2.8.1 challenge result

```c#
public class ChallengeResult : ActionResult
{
    public IList<string> AuthenticationSchemes { get; set; }        
    public AuthenticationProperties Properties { get; set; }
    
    public ChallengeResult() : this(Array.Empty<string>())        
    {
    }
        
    public ChallengeResult(string authenticationScheme)            
        : this(new[] { authenticationScheme })
    {        
    }
        
    public ChallengeResult(IList<string> authenticationSchemes)            
        : this(authenticationSchemes, properties: null)
    {
    }
        
    public ChallengeResult(AuthenticationProperties properties)            
        : this(Array.Empty<string>(), properties)
    {
    }
        
    public ChallengeResult(
        string authenticationScheme, 
        AuthenticationProperties properties)            
        	: this(new[] { authenticationScheme }, properties)
    {
    }
        
    public ChallengeResult(
        IList<string> authenticationSchemes, 
        AuthenticationProperties properties)
    {
        AuthenticationSchemes = authenticationSchemes;
        Properties = properties;
    }
                
    /// <inheritdoc />
    public override async Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        /* 解析 logger 并创建日志 */
        var loggerFactory = context.HttpContext
            					 .RequestServices
            					 .GetRequiredService<ILoggerFactory>();
        
        var logger = loggerFactory.CreateLogger<ChallengeResult>();        
        logger.ChallengeResultExecuting(AuthenticationSchemes);
        
        if (AuthenticationSchemes != null && 
            AuthenticationSchemes.Count > 0)
        {
            foreach (var scheme in AuthenticationSchemes)
            {
                await context.HttpContext
                    		.ChallengeAsync(scheme, Properties);
            }
        }
        else
        {
            await context.HttpContext.ChallengeAsync(Properties);
        }
    }
}

```

##### 2.8.2 forbid result

```c#
public class ForbidResult : ActionResult
{
    public IList<string> AuthenticationSchemes { get; set; }        
    public AuthenticationProperties Properties { get; set; }
       
    public ForbidResult() : this(Array.Empty<string>())
    {
    }
       
    public ForbidResult(string authenticationScheme)      
        : this(new[] { authenticationScheme })
    {
    }
            
    public ForbidResult(IList<string> authenticationSchemes)            
        : this(authenticationSchemes, properties: null)
    {
    }
            
    public ForbidResult(AuthenticationProperties properties)            
        : this(Array.Empty<string>(), properties)
    {
    }
            
    public ForbidResult(
        string authenticationScheme, 
        AuthenticationProperties properties)            
        	: this(new[] { authenticationScheme }, properties)
    {
    }
            
    public ForbidResult(
        IList<string> authenticationSchemes, 
        AuthenticationProperties properties)
    {
        AuthenticationSchemes = authenticationSchemes;
        Properties = properties;
    }
                   
    /// <inheritdoc />
    public override async Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        /* 解析 logger 并创建日志 */
        var loggerFactory = context.HttpContext
            					 .RequestServices
            					 .GetRequiredService<ILoggerFactory>();
        
        var logger = loggerFactory.CreateLogger<ForbidResult>();        
        logger.ForbidResultExecuting(AuthenticationSchemes);
        
        if (AuthenticationSchemes != null && 
            AuthenticationSchemes.Count > 0)
        {
            for (var i = 0; i < AuthenticationSchemes.Count; i++)
            {
                await context.HttpContext
                    		.ForbidAsync(AuthenticationSchemes[i], Properties);
            }
        }
        else
        {
            await context.HttpContext.ForbidAsync(Properties);
        }
    }
}

```

##### 2.8.3 sign in result

```c#
public class SignInResult : ActionResult
{
    public string AuthenticationScheme { get; set; }        
    public ClaimsPrincipal Principal { get; set; }        
    public AuthenticationProperties Properties { get; set; }
    
    public SignInResult(ClaimsPrincipal principal)        
        : this(authenticationScheme: null, principal, properties: null)
    {
    }
        
    public SignInResult(
        string authenticationScheme, 
        ClaimsPrincipal principal)            
        	: this(authenticationScheme, principal, properties: null)
    {
    }
        
    public SignInResult(
        ClaimsPrincipal principal, 
        AuthenticationProperties properties)            
        	: this(authenticationScheme: null, principal, properties)
    {
    }
        
    public SignInResult(
        string authenticationScheme, 
        ClaimsPrincipal principal, 
        AuthenticationProperties properties)
    {
        Principal = principal ?? throw new ArgumentNullException(nameof(principal));
        AuthenticationScheme = authenticationScheme;        
        Properties = properties;
    }
                    
    /// <inheritdoc />
    public override async Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        /* 解析 logger 并创建日志 */
        var loggerFactory = context.HttpContext
            					 .RequestServices
            					 .GetRequiredService<ILoggerFactory>();
        
        var logger = loggerFactory.CreateLogger<SignInResult>();        
        logger.SignInResultExecuting(AuthenticationScheme, Principal);
        
        await context.HttpContext.SignInAsync(
            AuthenticationScheme, 
            Principal, 
            Properties);
    }
}

```

##### 2.8.4 sign out result

```c#
public class SignOutResult : ActionResult
{
    public IList<string> AuthenticationSchemes { get; set; }        
    public AuthenticationProperties Properties { get; set; }
    
    public SignOutResult() : this(Array.Empty<string>())
    {
    }
        
    public SignOutResult(AuthenticationProperties properties)            
        : this(Array.Empty<string>(), properties)
    {
    }
        
    public SignOutResult(string authenticationScheme)        
        : this(new[] { authenticationScheme })
    {
    }
        
    public SignOutResult(IList<string> authenticationSchemes)            
        : this(authenticationSchemes, properties: null)
    {
    }
        
    public SignOutResult(
        string authenticationScheme, 
        AuthenticationProperties properties)            
        	: this(new[] { authenticationScheme }, properties)
    {
    }
        
    public SignOutResult(
        IList<string> authenticationSchemes, 
        AuthenticationProperties properties)
    {
        AuthenticationSchemes = authenticationSchemes 
            ?? throw new ArgumentNullException(nameof(authenticationSchemes));
        Properties = properties;
    }
               
    /// <inheritdoc />
    public override async Task ExecuteResultAsync(ActionContext context)
    {
        if (context == null)
        {
            throw new ArgumentNullException(nameof(context));
        }
        
        if (AuthenticationSchemes == null)
        {
            throw new InvalidOperationException(
                Resources.FormatPropertyOfTypeCannotBeNull(                   
                    nameof(AuthenticationSchemes),                   
                    nameof(SignOutResult)));
        }
        
        var loggerFactory = context.HttpContext
            					 .RequestServices
            					 .GetRequiredService<ILoggerFactory>();
        
        var logger = loggerFactory.CreateLogger<SignOutResult>();        
        logger.SignOutResultExecuting(AuthenticationSchemes);
        
        if (AuthenticationSchemes.Count == 0)            
        {
            await context.HttpContext.SignOutAsync(Properties);
        }
        else
        {
            for (var i = 0; i < AuthenticationSchemes.Count; i++)
            {
                await context.HttpContext.SignOutAsync(
                    AuthenticationSchemes[i], 
                    Properties);
            }
        }
    }
}

```

#### 2.9 action result type mapper

##### 2.9.1 接口

```c#
public interface IActionResultTypeMapper
{    
    Type GetResultDataType(Type returnType);        
    IActionResult Convert(object? value, Type returnType);
}

```

##### 2.9.2 action result type mapper

```c#
internal class ActionResultTypeMapper : IActionResultTypeMapper
{
    // 获取 data type，即 T 的类型，不适用于 void
    public Type GetResultDataType(Type returnType)
    {
        if (returnType == null)
        {
            throw new ArgumentNullException(nameof(returnType));
        }
        
        if (returnType.IsGenericType &&
            returnType.GetGenericTypeDefinition() == typeof(ActionResult<>))
        {
            return returnType.GetGenericArguments()[0];
        }
        
        return returnType;
    }
    
    // 转换，不适用于 void
    public IActionResult Convert(object? value, Type returnType)
    {
        if (returnType == null)
        {
            throw new ArgumentNullException(nameof(returnType));
        }
        
        // 如果实现了 convert to action result（action result T 类型），
        if (value is IConvertToActionResult converter)
        {
            // 使用 convert to action result 的 convert 方法
            return converter.Convert();
        }
        // 否则封装 value 到 object result
        return new ObjectResult(value)
        {
            DeclaredType = returnType,
        };
    }
}

```

##### 2.9.3 convert to action result

###### 2.9.3.1 接口

```c#
public interface IConvertToActionResult
{    
    IActionResult Convert();
}

```

###### 2.9.3.2 action result of T

```c#
public sealed class ActionResult<TValue> : IConvertToActionResult
{
    private const int DefaultStatusCode = StatusCodes.Status200OK;
    
    public ActionResult Result { get; }        
    public TValue Value { get; }
    
    /* 由 tValue 创建 action result*/
    public ActionResult(TValue value)
    {
        if (typeof(IActionResult).IsAssignableFrom(typeof(TValue)))
        {
            var error = Resources.FormatInvalidTypeTForActionResultOfT(
                			  		  typeof(TValue), 
		                			  "ActionResult<T>");
            throw new ArgumentException(error);
        }
        
        Value = value;
    }
    
     public static implicit operator ActionResult<TValue>(TValue value)
    {
        return new ActionResult<TValue>(value);
    }
        
    /* 由 action result 创建 action result */
    public ActionResult(ActionResult result)
    {
        if (typeof(IActionResult).IsAssignableFrom(typeof(TValue)))
        {
            var error = Resources.FormatInvalidTypeTForActionResultOfT(
                					  typeof(TValue), 
                					  "ActionResult<T>");
            throw new ArgumentException(error);
        }
        
        Result = result ?? throw new ArgumentNullException(nameof(result));
    }                               
            
    public static implicit operator ActionResult<TValue>(ActionResult result)
    {
        return new ActionResult<TValue>(result);
    }
    
    /* 实现 convert to action result 接口 */
    IActionResult IConvertToActionResult.Convert()
    {
        if (Result != null)
        {
            return Result;
        }
        
        int statusCode;
        if (Value is ProblemDetails problemDetails && problemDetails.Status != null)
        {
            statusCode = problemDetails.Status.Value;
        }
        else
        {
            statusCode = DefaultStatusCode;
        }
        
        return new ObjectResult(Value)
        {
            DeclaredType = typeof(TValue),
            StatusCode = statusCode
        };
    }
}

```



