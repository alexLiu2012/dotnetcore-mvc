## about middlewares in diagnostics



### 1. about



### 2. welcome page

#### 2.1 use welcome page

```c#
public static class WelcomePageExtensions
{
    public static IApplicationBuilder UseWelcomePage(this IApplicationBuilder app)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        return app.UseMiddleware<WelcomePageMiddleware>();
    }
    
    public static IApplicationBuilder UseWelcomePage(this IApplicationBuilder app, WelcomePageOptions options)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }
        
        return app.UseMiddleware<WelcomePageMiddleware>(Options.Create(options));
    }
       
    public static IApplicationBuilder UseWelcomePage(this IApplicationBuilder app, PathString path)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        return app.UseWelcomePage(new WelcomePageOptions { Path = path });
    }
           
    public static IApplicationBuilder UseWelcomePage(this IApplicationBuilder app, string path)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        return app.UseWelcomePage(new WelcomePageOptions { Path = new PathString(path) });
    }    
}

```

##### 2.1.1 welcome page options

```c#
public class WelcomePageOptions
{    
    public PathString Path { get; set; }
}

```

##### 2.1.2 welcome page middleware

```c#
public class WelcomePageMiddleware
{
    private readonly RequestDelegate _next;
    private readonly WelcomePageOptions _options;
       
    public WelcomePageMiddleware(RequestDelegate next, IOptions<WelcomePageOptions> options)
    {
        if (next == null)
        {
            throw new ArgumentNullException(nameof(next));
        }        
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }
        
        _next = next;
        _options = options.Value;
    }

       
    public Task Invoke(HttpContext context)
    {
        HttpRequest request = context.Request;
        if (!_options.Path.HasValue || _options.Path == request.Path)
        {
            // Dynamically generated for LOC.
            var welcomePage = new WelcomePage();
            return welcomePage.ExecuteAsync(context);
        }
        
        return _next(context);
    }
}

```

##### 2.1.3 welcome page

* razor page, from "welcome page.cshtml" => "welcome page.designer.cs"

```c#
internal class WelcomePage : Microsoft.Extensions.RazorViews.BaseView
{    
    public async override global::System.Threading.Tasks.Task ExecuteAsync()
    {                
        Response.ContentType = "text/html; charset=utf-8";
        
        WriteLiteral("<!DOCTYPE html>\r\n<html");
        BeginWriteAttribute("lang", " lang=\"", 141, "\"", 223, 1);

        WriteAttributeValue("", 148, System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName, 148, 75, false);   
        EndWriteAttribute();
        
        // ...
    }
}

```

### 3. status code page

#### 3.1 use status code page

```c#
public static class StatusCodePagesExtensions
{        
    public static IApplicationBuilder UseStatusCodePages(this IApplicationBuilder app)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        return app.UseMiddleware<StatusCodePagesMiddleware>();
    }
    
    // with options
    public static IApplicationBuilder UseStatusCodePages(
        this IApplicationBuilder app, 
        StatusCodePagesOptions options)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }
        
        return app.UseMiddleware<StatusCodePagesMiddleware>(Options.Create(options));
    }
          
    // with "status code context handler"
    public static IApplicationBuilder UseStatusCodePages(
        this IApplicationBuilder app, 
        Func<StatusCodeContext, Task> handler)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        if (handler == null)
        {
            throw new ArgumentNullException(nameof(handler));
        }
        
        return app.UseStatusCodePages(new StatusCodePagesOptions
            {
                HandleAsync = handler
            });
    }

    // with "content type" & "body format"
    public static IApplicationBuilder UseStatusCodePages(
        this IApplicationBuilder app, 
        string contentType, 
        string bodyFormat)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        return app.UseStatusCodePages(context =>
            {
                var body = string.Format(
                    CultureInfo.InvariantCulture, 
                    bodyFormat, 
                    context.HttpContext.Response.StatusCode);
                
                context.HttpContext.Response.ContentType = contentType;
                return context.HttpContext.Response.WriteAsync(body);
            });
    }
    
    // with plugin middlewares            
    public static IApplicationBuilder UseStatusCodePages(
        this IApplicationBuilder app, 
        Action<IApplicationBuilder> configuration)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        var builder = app.New();
        configuration(builder);
        var tangent = builder.Build();
        return app.UseStatusCodePages(context => tangent(context.HttpContext));
    }    
}

```

#### - with redirect

```c#
public static class StatusCodePagesExtensions
{
    public static IApplicationBuilder UseStatusCodePagesWithRedirects(
        this IApplicationBuilder app, 
        string locationFormat)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        if (locationFormat.StartsWith('~'))
        {
            locationFormat = locationFormat.Substring(1);
            return app.UseStatusCodePages(context =>
                {
                    var location = string.Format(
                        CultureInfo.InvariantCulture, 
                        locationFormat, 
                        context.HttpContext.Response.StatusCode);
                    
                    context.HttpContext.Response.Redirect(context.HttpContext.Request.PathBase + location);
                    return Task.CompletedTask;
                });
        }
        else
        {
            return app.UseStatusCodePages(context =>
                {
                    var location = string.Format(
                        CultureInfo.InvariantCulture, 
                        locationFormat, 
                        context.HttpContext.Response.StatusCode);
                    
                    context.HttpContext.Response.Redirect(location);
                    return Task.CompletedTask;
                });
        }
    }
}

```

#### - with execution

```c#
public static class StatusCodePagesExtensions
{
    public static IApplicationBuilder UseStatusCodePagesWithReExecute(
        this IApplicationBuilder app,
        string pathFormat,
        string? queryFormat = null)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        return app.UseStatusCodePages(async context =>
            {
                // 格式化 path & query string
                var newPath = new PathString(
                    string.Format(
                        CultureInfo.InvariantCulture, 
                        pathFormat, 
                        context.HttpContext.Response.StatusCode));
                
                var formatedQueryString = queryFormat == null 
                    ? null 
                    : string.Format(
                        CultureInfo.InvariantCulture, 
                        queryFormat, 
                        context.HttpContext.Response.StatusCode);
                
                var newQueryString = queryFormat == null 
                    ? QueryString.Empty 
                    : new QueryString(formatedQueryString);
                
                // origin path & query string
                var originalPath = context.HttpContext.Request.Path;                
                var originalQueryString = context.HttpContext.Request.QueryString;
                
                // 封装 origin path & query string => status code reexecute feature，
                // 注入 http context
                context.HttpContext.Features.Set<IStatusCodeReExecuteFeature>(new StatusCodeReExecuteFeature()
                    {
                        OriginalPathBase = context.HttpContext.Request.PathBase.Value!,
                        OriginalPath = originalPath.Value!,
                        OriginalQueryString = originalQueryString.HasValue ? originalQueryString.Value : null,
                    });
                
                // 清空 endpoint
                context.HttpContext.SetEndpoint(endpoint: null);
                // 清除 route value feature
                var routeValuesFeature = context.HttpContext.Features.Get<IRouteValuesFeature>();
                routeValuesFeature?.RouteValues?.Clear();

                // re-set http request path & query string
                context.HttpContext.Request.Path = newPath;
                context.HttpContext.Request.QueryString = newQueryString;
                try
                {
                    // 执行 next (request delegate)
                    await context.Next(context.HttpContext);
                }
                finally
                {
                    // 恢复 
                    context.HttpContext.Request.QueryString = originalQueryString;
                    context.HttpContext.Request.Path = originalPath;
                    context.HttpContext.Features.Set<IStatusCodeReExecuteFeature?>(null);
                }
            });
    }
}

```

##### 3.1.1 status code options

```c#
public class StatusCodePagesOptions
{    
    public Func<StatusCodeContext, Task> HandleAsync { get; set; }
    
    public StatusCodePagesOptions()
    {
        HandleAsync = context =>
        {
            // TODO: Render with a pre-compiled html razor view.
            var statusCode = context.HttpContext.Response.StatusCode;            
            var body = BuildResponseBody(statusCode);
            
            context.HttpContext.Response.ContentType = "text/plain";
            return context.HttpContext.Response.WriteAsync(body);
        };
    }
    
    private string BuildResponseBody(int httpStatusCode)
    {
        // Note the 500 spaces are to work around an IE 'feature'
        var internetExplorerWorkaround = new string(' ', 500);
        
        var reasonPhrase = ReasonPhrases.GetReasonPhrase(httpStatusCode);
        
        return string.Format(
            CultureInfo.InvariantCulture, 
            "Status Code: {0}{1}{2}{3}",
            httpStatusCode,
            string.IsNullOrWhiteSpace(reasonPhrase) ? "" : "; ",
            reasonPhrase,
            internetExplorerWorkaround);
    }    
}

```

###### 3.1.1.1 status code context

```c#
public class StatusCodeContext
{
    public HttpContext HttpContext { get; private set; }        
    public StatusCodePagesOptions Options { get; private set; }        
    public RequestDelegate Next { get; private set; }
    
    public StatusCodeContext(
        HttpContext context, 
        StatusCodePagesOptions options, 
        RequestDelegate next)
    {
        HttpContext = context;
        Options = options;
        Next = next;
    }    
}

```

##### 3.1.2 features

###### 3.1.2.1 status code page feature

```c#
public interface IStatusCodePagesFeature
{        
    bool Enabled { get; set; }
}

public class StatusCodePagesFeature : IStatusCodePagesFeature
{    
    public bool Enabled { get; set; } = true;
}

```

###### 3.1.2.2 status code page execution feature

```c#
public interface IStatusCodeReExecuteFeature
{    
    string OriginalPathBase { get; set; }        
    string OriginalPath { get; set; }        
    string? OriginalQueryString { get; set; }
}

public class StatusCodeReExecuteFeature : IStatusCodeReExecuteFeature
{    
    public string OriginalPath { get; set; } = default!;        
    public string OriginalPathBase { get; set; } = default!;        
    public string? OriginalQueryString { get; set; }
}

```

##### 3.1.3 status code page middleware

```c#
public class StatusCodePagesMiddleware
{
    private readonly RequestDelegate _next;
    private readonly StatusCodePagesOptions _options;
    
    
    public StatusCodePagesMiddleware(RequestDelegate next, IOptions<StatusCodePagesOptions> options)
    {
        _next = next;
        _options = options.Value;
        if (_options.HandleAsync == null)
        {
            throw new ArgumentException("Missing options.HandleAsync implementation.");
        }
    }

       
    public async Task Invoke(HttpContext context)
    {
        var statusCodeFeature = new StatusCodePagesFeature();
        context.Features.Set<IStatusCodePagesFeature>(statusCodeFeature);
        
        await _next(context);
        
        if (!statusCodeFeature.Enabled)
        {
            // Check if the feature is still available because other middleware (such as a web API written in MVC) could
            // have disabled the feature to prevent HTML status code responses from showing up to an API client.
            return;
        }
        
        // Do nothing if a response body has already been provided.
        if (context.Response.HasStarted || 
            context.Response.StatusCode < 400 || 
            context.Response.StatusCode >= 600 || 
            context.Response.ContentLength.HasValue || 
            !string.IsNullOrEmpty(context.Response.ContentType))
        {
            return;
        }
        
        var statusCodeContext = new StatusCodeContext(context, _options, _next);
        await _options.HandleAsync(statusCodeContext);
    }
}

```

### 4. developer exception page

#### 4.1 for view

##### 4.1.1 (runtime) error

###### 4.1.1.1 (runtime) error page model

```c#
internal class ErrorPageModel
{    
    public DeveloperExceptionPageOptions Options { get; set; }        
    public IEnumerable<ExceptionDetails> ErrorDetails { get; set; }        
    public IQueryCollection Query { get; set; }        
    public IRequestCookieCollection Cookies { get; set; }        
    public IDictionary<string, StringValues> Headers { get; set; }        
    public RouteValueDictionary RouteValues { get; set; }        
    public EndpointModel Endpoint { get; set; }
}

```

###### 4.1.1.2 (runtime) error page

```c#
internal class ErrorPage : Microsoft.Extensions.RazorViews.BaseView
{    
    public async override global::System.Threading.Tasks.Task ExecuteAsync()
    {        
        Response.ContentType = "text/html; charset=utf-8";
        string location = string.Empty;
        
        WriteLiteral("<!DOCTYPE html>\r\n<html");
        BeginWriteAttribute("lang", " lang=\"", 536, "\"", 597, 1);        
        WriteAttributeValue("", 543, CultureInfo.CurrentUICulture.TwoLetterISOLanguageName, 543, 54, false);                
        EndWriteAttribute();
        
        // ...
    }
}

```

##### 4.1.2 compilation error

###### 4.1.2.1 compilation error page model

```c#
internal class CompilationErrorPageModel
{
    public DeveloperExceptionPageOptions Options { get; }        
    public IList<ExceptionDetails> ErrorDetails { get; } = new List<ExceptionDetails>();        
    public IList<string?> CompiledContent { get; } = new List<string?>();
    
    public CompilationErrorPageModel(DeveloperExceptionPageOptions options)
    {
        Options = options;
    }            
}

```

###### 4.1.2.2 compilation error page

```c#
internal class CompilationErrorPage : Microsoft.Extensions.RazorViews.BaseView
{
    public async override global::System.Threading.Tasks.Task ExecuteAsync()
    {                
        Response.StatusCode = 500;
        Response.ContentType = "text/html; charset=utf-8";
        Response.ContentLength = null; // Clear any prior Content-Length     
        
        WriteLiteral("<!DOCTYPE html>\r\n<html>\r\n    <head>\r\n        <meta charset=\"utf-8\" />\r\n        <title>");        
        Write(Resources.ErrorPageHtml_Title);
        
        // ...
    }
}

```





#### 4.1 use developer exception page

```c#
public static class DeveloperExceptionPageExtensions
{    
    public static IApplicationBuilder UseDeveloperExceptionPage(this IApplicationBuilder app)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        return app.UseMiddleware<DeveloperExceptionPageMiddleware>();
    }
        
    public static IApplicationBuilder UseDeveloperExceptionPage(
        this IApplicationBuilder app,
        DeveloperExceptionPageOptions options)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }
        
        return app.UseMiddleware<DeveloperExceptionPageMiddleware>(Options.Create(options));
    }
}

```

##### 4.1.1 developer exception page options

```c#
public class DeveloperExceptionPageOptions
{
    public int SourceCodeLineCount { get; set; }            
    public IFileProvider? FileProvider { get; set; }
    
    public DeveloperExceptionPageOptions()
    {
        SourceCodeLineCount = 6;
    }            
}

```

##### 4.1.2 developer exception page middleware

```c#
public class DeveloperExceptionPageMiddleware
{
    private readonly RequestDelegate _next;
    private readonly DeveloperExceptionPageOptions _options;
    private readonly ILogger _logger;    
    private readonly IFileProvider _fileProvider;
    private readonly DiagnosticSource _diagnosticSource;
    private readonly ExceptionDetailsProvider _exceptionDetailsProvider;
    private readonly Func<ErrorContext, Task> _exceptionHandler;
    private static readonly MediaTypeHeaderValue _textHtmlMediaType = new MediaTypeHeaderValue("text/html");
        
    public DeveloperExceptionPageMiddleware(
        RequestDelegate next,
        IOptions<DeveloperExceptionPageOptions> options,
        ILoggerFactory loggerFactory,
        IWebHostEnvironment hostingEnvironment,
        DiagnosticSource diagnosticSource,
        IEnumerable<IDeveloperPageExceptionFilter> filters)
    {
        if (next == null)
        {
            throw new ArgumentNullException(nameof(next));
        }        
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }        
        if (filters == null)
        {
            throw new ArgumentNullException(nameof(filters));
        }
        
        _next = next;
        _options = options.Value;
        _logger = loggerFactory.CreateLogger<DeveloperExceptionPageMiddleware>();
        _fileProvider = _options.FileProvider ?? hostingEnvironment.ContentRootFileProvider;
        _diagnosticSource = diagnosticSource;
        
        // 创建 exception details provider
        _exceptionDetailsProvider = new ExceptionDetailsProvider(_fileProvider, _logger, _options.SourceCodeLineCount);
        
        // 注入并处理 exception filter
        _exceptionHandler = DisplayException;            
        foreach (var filter in filters.Reverse())
        {
            var nextFilter = _exceptionHandler;
            _exceptionHandler = errorContext => filter.HandleExceptionAsync(errorContext, nextFilter);
        }
    }
    
    // Assumes the response headers have not been sent.  If they have, still attempt to write to the body.
    private Task DisplayException(ErrorContext errorContext)
    {
        // 解析 http context
        var httpContext = errorContext.HttpContext;
        // 解析 http request headers
        var headers = httpContext.Request.GetTypedHeaders();
        // 解析 http request accept
        var acceptHeader = headers.Accept;
        
        // 如果客户端不支持 html，-> 返回 plain text
        if (acceptHeader == null || !acceptHeader.Any(h => h.IsSubsetOf(_textHtmlMediaType)))
        {
            httpContext.Response.ContentType = "text/plain";
            
            var sb = new StringBuilder();
            sb.AppendLine(errorContext.Exception.ToString());
            sb.AppendLine();
            sb.AppendLine("HEADERS");
            sb.AppendLine("=======");
            foreach (var pair in httpContext.Request.Headers)
            {
                sb.AppendLine($"{pair.Key}: {pair.Value}");
            }
            
            return httpContext.Response.WriteAsync(sb.ToString());
        }
        
        // 1- 如果 error 是 compilation exception，
        if (errorContext.Exception is ICompilationException compilationException)
        {           
            return DisplayCompilationException(httpContext, compilationException);
        }
        
        // （否则，即 error 不是 compilation exception），-> 是 runtime exception
        return DisplayRuntimeException(httpContext, errorContext.Exception);
    }
   
    public async Task Invoke(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (Exception ex)
        {
            _logger.UnhandledException(ex);
            
            if (context.Response.HasStarted)
            {
                _logger.ResponseStartedErrorPageMiddleware();
                throw;
            }
            
            try
            {
                context.Response.Clear();
                context.Response.StatusCode = 500;
                
                await _exceptionHandler(new ErrorContext(context, ex));
                
                if (_diagnosticSource.IsEnabled("Microsoft.AspNetCore.Diagnostics.UnhandledException"))
                {      
                    _diagnosticSource.Write(
                        "Microsoft.AspNetCore.Diagnostics.UnhandledException", 
                        new { httpContext = context, exception = ex });
                }
                
                return;
            }
            catch (Exception ex2)
            {
                // If there's a Exception while generating the error page, re-throw the original exception.
                _logger.DisplayErrorPageException(ex2);
            }
            throw;
        }
    }                
}

```

##### - compilation exception

```c#
public class DeveloperExceptionPageMiddleware
{
    private Task DisplayCompilationException(
        HttpContext context,
        ICompilationException compilationException)
    {
        // 创建 compilation error model
        var model = new CompilationErrorPageModel(_options);
        
        // 创建 compilation error page
        var errorPage = new CompilationErrorPage
        {
            Model = model
        };
        
        // 如果 compilation exception 的 failures 为 null，-> 渲染 error page 并返回
        if (compilationException.CompilationFailures == null)
        {
            return errorPage.ExecuteAsync(context);
        }
        
        // （由上，compilation exception 的 failure 不为 null）        
        // 遍历 failures，封装、追加到 error page
        foreach (var compilationFailure in compilationException.CompilationFailures)
        {
            if (compilationFailure == null)
            {
                continue;
            }
            
            var stackFrames = new List<StackFrameSourceCodeInfo>();
            var exceptionDetails = new ExceptionDetails(compilationFailure.FailureSummary!, stackFrames);
            model.ErrorDetails.Add(exceptionDetails);
            model.CompiledContent.Add(compilationFailure.CompiledContent);
            
            if (compilationFailure.Messages == null)
            {
                continue;
            }
            
            var sourceLines = compilationFailure
                .SourceFileContent?
                .Split(new[] { Environment.NewLine }, StringSplitOptions.None);
            
            foreach (var item in compilationFailure.Messages)
            {
                if (item == null)
                {
                    continue;
                }
                
                var frame = new StackFrameSourceCodeInfo
                {
                    
                    File = compilationFailure.SourceFilePath,
                    Line = item.StartLine,
                    Function = string.Empty
                };
                
                if (sourceLines != null)
                {
                    _exceptionDetailsProvider.ReadFrameContent(frame, sourceLines, item.StartLine, item.EndLine);
                }
                
                frame.ErrorDetails = item.Message;
                
                stackFrames.Add(frame);
            }
        }
        
        // 渲染 error page 并返回
        return errorPage.ExecuteAsync(context);
    }
}
```

##### - runtime exception

```c#
public class DeveloperExceptionPageMiddleware
{
    private Task DisplayRuntimeException(HttpContext context, Exception ex)
    {
        // 解析 endpoint
        var endpoint = context.Features.Get<IEndpointFeature>()?.Endpoint;
        
        // 创建 endpoint model
        EndpointModel? endpointModel = null;
        if (endpoint != null)
        {
            endpointModel = new EndpointModel();
            endpointModel.DisplayName = endpoint.DisplayName;
            
            if (endpoint is RouteEndpoint routeEndpoint)
            {
                endpointModel.RoutePattern = routeEndpoint.RoutePattern.RawText;
                endpointModel.Order = routeEndpoint.Order;
                
                var httpMethods = endpoint.Metadata.GetMetadata<IHttpMethodMetadata>()?.HttpMethods;
                if (httpMethods != null)
                {
                    endpointModel.HttpMethods = string.Join(", ", httpMethods);
                }
            }
        }
        
        // 解析 http request
        var request = context.Request;
        
        // 创建 error page model，封装 endpoint model
        var model = new ErrorPageModel
        {
            Options = _options,
            ErrorDetails = _exceptionDetailsProvider.GetDetails(ex),
            Query = request.Query,
            Cookies = request.Cookies,
            Headers = request.Headers,
            RouteValues = request.RouteValues,
            Endpoint = endpointModel
        };
        
        // 创建 error page
        var errorPage = new ErrorPage(model);
        // 渲染并返回
        return errorPage.ExecuteAsync(context);
    }
}

```

### 5. exception handler

#### 5.1 add exception handler

```c#
public static class ExceptionHandlerServiceCollectionExtensions
{    
    public static IServiceCollection AddExceptionHandler(
        this IServiceCollection services, 
        Action<ExceptionHandlerOptions> configureOptions)
    {
        if (services == null)
        {
            throw new ArgumentNullException(nameof(services));
        }
        if (configureOptions == null)
        {
            throw new ArgumentNullException(nameof(configureOptions));
        }
        
        return services.Configure(configureOptions);
    }
    
    
    public static IServiceCollection AddExceptionHandler<TService>(
        this IServiceCollection services, 
        Action<ExceptionHandlerOptions, TService> configureOptions) where TService : class
    {
        if (services == null)
        {
            throw new ArgumentNullException(nameof(services));
        }
        if (configureOptions == null)
        {
            throw new ArgumentNullException(nameof(configureOptions));
        }
        
        services.AddOptions<ExceptionHandlerOptions>().Configure(configureOptions);
        return services;
    }
}

```

##### 5.1.1 exception handler options

```c#
public class ExceptionHandlerOptions
{    
    public PathString ExceptionHandlingPath { get; set; }
    public RequestDelegate? ExceptionHandler { get; set; }    
    public bool AllowStatusCode404Response { get; set; }
}

```

#### 5.2 use exception handler

```c#
public static class ExceptionHandlerExtensions
{    
    public static IApplicationBuilder UseExceptionHandler(this IApplicationBuilder app)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        return app.UseMiddleware<ExceptionHandlerMiddleware>();
    }
        
    public static IApplicationBuilder UseExceptionHandler(
        this IApplicationBuilder app, 
        string errorHandlingPath)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        return app.UseExceptionHandler(
            new ExceptionHandlerOptions
            {
                ExceptionHandlingPath = new PathString(errorHandlingPath)
            });
    }
    
    
    public static IApplicationBuilder UseExceptionHandler(
        this IApplicationBuilder app, 
        Action<IApplicationBuilder> configure)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        if (configure == null)
        {
            throw new ArgumentNullException(nameof(configure));
        }
        
        // 插入 application builder configuration，构建新的 request pipeline
        var subAppBuilder = app.New();
        configure(subAppBuilder);
        var exceptionHandlerPipeline = subAppBuilder.Build();
        
        return app.UseExceptionHandler(
            new ExceptionHandlerOptions
            {
                ExceptionHandler = exceptionHandlerPipeline
            });
    }
        
    public static IApplicationBuilder UseExceptionHandler(
        this IApplicationBuilder app, 
        ExceptionHandlerOptions options)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }
        
        return app.UseMiddleware<ExceptionHandlerMiddleware>(Options.Create(options));
    }
}

```

##### 5.2.1 exception handler middleware

```c#
public class ExceptionHandlerMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ExceptionHandlerOptions _options;
    private readonly ILogger _logger;
    private readonly Func<object, Task> _clearCacheHeadersDelegate;
    private readonly DiagnosticListener _diagnosticListener;
       
    public ExceptionHandlerMiddleware(
        RequestDelegate next,
        ILoggerFactory loggerFactory,
        IOptions<ExceptionHandlerOptions> options,
        DiagnosticListener diagnosticListener)
    {
        _next = next;
        _options = options.Value;
        _logger = loggerFactory.CreateLogger<ExceptionHandlerMiddleware>();
        
        _clearCacheHeadersDelegate = ClearCacheHeaders;
        _diagnosticListener = diagnosticListener;
        if (_options.ExceptionHandler == null)
        {
            if (_options.ExceptionHandlingPath == null)
            {
                throw new InvalidOperationException(Resources.ExceptionHandlerOptions_NotConfiguredCorrectly);
            }
            else
            {
                _options.ExceptionHandler = _next;
            }
        }
    }
    
    // 
    private static Task ClearCacheHeaders(object state)
    {
        // convert state to http response headers
        var headers = ((HttpResponse)state).Headers;
        
        headers.CacheControl = "no-cache,no-store";
        headers.Pragma = "no-cache";
        headers.Expires = "-1";
        headers.ETag = default;
        return Task.CompletedTask;
    }
    
    public Task Invoke(HttpContext context)
    {
        ExceptionDispatchInfo edi;
        
        try
        {
            var task = _next(context);
            if (!task.IsCompletedSuccessfully)
            {
                return Awaited(this, context, task);
            }
            
            return Task.CompletedTask;
        }
        catch (Exception exception)
        {
            // Get the Exception, but don't continue processing in the catch block as its bad for stack usage.
            edi = ExceptionDispatchInfo.Capture(exception);
        }
        
        return HandleException(context, edi);
        
        static async Task Awaited(
            ExceptionHandlerMiddleware middleware, 
            HttpContext context, 
            Task task)
        {
            ExceptionDispatchInfo? edi = null;
            try
            {
                await task;
            }
            catch (Exception exception)
            {
                // Get the Exception, but don't continue processing in the catch block as its bad for stack usage.
                edi = ExceptionDispatchInfo.Capture(exception);
            }
            
            if (edi != null)
            {
                await middleware.HandleException(context, edi);
            }
        }
    }
    
    private async Task HandleException(HttpContext context, ExceptionDispatchInfo edi)
    {
        _logger.UnhandledException(edi.SourceException);
        
        // We can't do anything if the response has already started, just abort.
        if (context.Response.HasStarted)
        {
            _logger.ResponseStartedErrorHandler();
            edi.Throw();
        }
        
        // 重写 http request path
        PathString originalPath = context.Request.Path;
        if (_options.ExceptionHandlingPath.HasValue)
        {
            context.Request.Path = _options.ExceptionHandlingPath;
        }
        
        try
        {
            // clear http context
            ClearHttpContext(context);
            
            // 创建 exception handler feature， 封装 error、request path
            var exceptionHandlerFeature = new ExceptionHandlerFeature()
            {
                Error = edi.SourceException,
                Path = originalPath.Value!,
            };
            
            // 注入 exception handler feature、exception handler path feature
            context.Features.Set<IExceptionHandlerFeature>(exceptionHandlerFeature);
            context.Features.Set<IExceptionHandlerPathFeature>(exceptionHandlerFeature);
            // 设置 response status code 500，start response
            context.Response.StatusCode = StatusCodes.Status500InternalServerError;
            context.Response.OnStarting(_clearCacheHeadersDelegate, context.Response);
            
            // 执行 options 中的 exception handler
            await _options.ExceptionHandler!(context);
            
            // If the response has already started, assume exception handler was successful.
            if (context.Response.HasStarted || 
                context.Response.StatusCode != StatusCodes.Status404NotFound || 
                _options.AllowStatusCode404Response)
            {
                if (_diagnosticListener.IsEnabled() && 
                    _diagnosticListener.IsEnabled("Microsoft.AspNetCore.Diagnostics.HandledException"))
                    {
                        _diagnosticListener.Write(
                            "Microsoft.AspNetCore.Diagnostics.HandledException", 
                            new { httpContext = context, exception = edi.SourceException });
                    }

                return;
            }
            
            edi = ExceptionDispatchInfo.Capture(
                new InvalidOperationException(
                    $"The exception handler configured on {nameof(ExceptionHandlerOptions)} produced a 404 status response. " +
                    $"This {nameof(InvalidOperationException)} containing the original exception was thrown since this is often 
                    "due to a misconfigured {nameof(ExceptionHandlerOptions.ExceptionHandlingPath)}. " +
                    $"If the exception handler is expected to return 404 status responses then set 
                    "{nameof(ExceptionHandlerOptions.AllowStatusCode404Response)} to true.", 
                    edi.SourceException));
        }
        catch (Exception ex2)
        {           
            _logger.ErrorHandlerException(ex2);
        }
        finally
        {
            context.Request.Path = originalPath;
        }
        
        edi.Throw(); 
    }
    
    private static void ClearHttpContext(HttpContext context)
    {
        context.Response.Clear();
        
        // An endpoint may have already been set. Since we're going to re-invoke the middleware pipeline we need to reset
        // the endpoint and route values to ensure things are re-calculated.
        context.SetEndpoint(endpoint: null);
        var routeValuesFeature = context.Features.Get<IRouteValuesFeature>();
        routeValuesFeature?.RouteValues?.Clear();
    }        
}

```

##### 5.2.2 exception handler feature

```c#
public interface IExceptionHandlerFeature
{    
    Exception Error { get; }
}

public interface IExceptionHandlerPathFeature : IExceptionHandlerFeature
{    
    string? Path { get; }
}

public class ExceptionHandlerFeature : IExceptionHandlerPathFeature
{    
    public Exception Error { get; set; } = default!;    
    public string Path { get; set; } = default!;    
}

```

### 6. health check

#### 6.1 health check

```c#
public interface IHealthCheck
{    
    Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context, 
        CancellationToken cancellationToken = default);
}

```

##### 6.1.1 health check result

```c#
public struct HealthCheckResult
{
    private static readonly IReadOnlyDictionary<string, object> _emptyReadOnlyDictionary = 
        new Dictionary<string, object>();
            
    public IReadOnlyDictionary<string, object> Data { get; }       
    public string? Description { get; }        
    public Exception? Exception { get; }    
    public HealthStatus Status { get; }
    
    public HealthCheckResult(
        HealthStatus status, 
        string? description = null, 
        Exception? exception = null, 
        IReadOnlyDictionary<string, object>? data = null)
    {
        Status = status;
        Description = description;
        Exception = exception;
        Data = data ?? _emptyReadOnlyDictionary;
    }
              
    // 静态实例 - healthy
    public static HealthCheckResult Healthy(
        string? description = null, 
        IReadOnlyDictionary<string, object>? data = null)
    {
        return new HealthCheckResult(status: HealthStatus.Healthy, description, exception: null, data);
    }
    // 静态实例 - degraded
    public static HealthCheckResult Degraded(
        string? description = null, 
        Exception? exception = null, 
        IReadOnlyDictionary<string, object>? data = null)
    {
        return new HealthCheckResult(status: HealthStatus.Degraded, description, exception: exception, data);
    }
    // 静态实例 - unhealthy    
    public static HealthCheckResult Unhealthy(
        string? description = null, 
        Exception? exception = null, 
        IReadOnlyDictionary<string, object>? data = null)
    {
        return new HealthCheckResult(status: HealthStatus.Unhealthy, description, exception, data);
    }
}

public enum HealthStatus
{    
    Unhealthy = 0,        
    Degraded = 1,        
    Healthy = 2,
}

```

##### 6.1.2 delegate health check

```c#
internal sealed class DelegateHealthCheck : IHealthCheck
{
    private readonly Func<CancellationToken, Task<HealthCheckResult>> _check;
        
    public DelegateHealthCheck(Func<CancellationToken, Task<HealthCheckResult>> check)
    {
        _check = check ?? throw new ArgumentNullException(nameof(check));
    }
        
    public Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context, 
        CancellationToken cancellationToken = default) => 
        	_check(cancellationToken);
}

```

##### 6.1.3 health check registration

```c#
 public sealed class HealthCheckRegistration
 {
     // health check factory
     private Func<IServiceProvider, IHealthCheck> _factory;
     public Func<IServiceProvider, IHealthCheck> Factory
     {
         get => _factory;
         set
         {
             if (value == null)
             {
                 throw new ArgumentNullException(nameof(value));
             }
             
             _factory = value;
         }
     }     
     
     // name
     private string _name;
     public string Name
     {
         get => _name;
         set
         {
             if (value == null)
             {
                 throw new ArgumentNullException(nameof(value));
             }
             
             _name = value;
         }
     }     
     
     // tags
     public ISet<string> Tags { get; }     
     
     // timeout
     private TimeSpan _timeout;
     public TimeSpan Timeout
     {
         get => _timeout;
         set
         {             
             if (value <= TimeSpan.Zero && value != System.Threading.Timeout.InfiniteTimeSpan)
             {
                 throw new ArgumentOutOfRangeException(nameof(value));
             }
             
             _timeout = value;
         }
     }     
     
     // failure health status     
     public HealthStatus FailureStatus { get; set; }
     
     
     // ctor, by "health check instance"
     public HealthCheckRegistration(
         string name, 
         IHealthCheck instance, 
         HealthStatus? failureStatus, 
         IEnumerable<string>? tags) : 
     		this(name, instance, failureStatus, tags, default)
     {
     }
          
     public HealthCheckRegistration(
         string name, 
         IHealthCheck instance, 
         HealthStatus? failureStatus, 
         IEnumerable<string>? tags, 
         TimeSpan? timeout)
     {
         if (name == null)
         {
             throw new ArgumentNullException(nameof(name));
         }                  
         if (instance == null)
         {
             throw new ArgumentNullException(nameof(instance));
         }         
         if (timeout <= TimeSpan.Zero && timeout != System.Threading.Timeout.InfiniteTimeSpan)
         {
             throw new ArgumentOutOfRangeException(nameof(timeout));
         }
         
         _name = name;
         FailureStatus = failureStatus ?? HealthStatus.Unhealthy;
         Tags = new HashSet<string>(tags ?? Array.Empty<string>(), StringComparer.OrdinalIgnoreCase);
         _factory = (_) => instance;
         Timeout = timeout ?? System.Threading.Timeout.InfiniteTimeSpan;
     }
     
     // ctor, by "health check factory"
     public HealthCheckRegistration(
         string name,
         Func<IServiceProvider, IHealthCheck> factory,
         HealthStatus? failureStatus,
         IEnumerable<string>? tags) : 
     		this(name, factory, failureStatus, tags, default)
     {
     }
          
     public HealthCheckRegistration(
         string name,
         Func<IServiceProvider, IHealthCheck> factory,
         HealthStatus? failureStatus,
         IEnumerable<string>? tags,
         TimeSpan? timeout)
     {
         if (name == null)
         {
             throw new ArgumentNullException(nameof(name));
         }         
         if (factory == null)
         {
             throw new ArgumentNullException(nameof(factory));
         }         
         if (timeout <= TimeSpan.Zero && timeout != System.Threading.Timeout.InfiniteTimeSpan)
         {
             throw new ArgumentOutOfRangeException(nameof(timeout));
         }
         
         _name = name;
         FailureStatus = failureStatus ?? HealthStatus.Unhealthy;
         Tags = new HashSet<string>(tags ?? Array.Empty<string>(), StringComparer.OrdinalIgnoreCase);
         _factory = factory;
         Timeout = timeout ?? System.Threading.Timeout.InfiniteTimeSpan;
     }     
 }

```

#### 6.2 health check service

```c#
public abstract class HealthCheckService
{        
    [SuppressMessage(
        "ApiDesign", 
        "RS0026:Do not add multiple public overloads with optional parameters", 
        Justification = "Required to maintain compatibility")]
    public Task<HealthReport> CheckHealthAsync(CancellationToken cancellationToken = default)
    {
        return CheckHealthAsync(predicate: null, cancellationToken);
    }
        
    [SuppressMessage(
        "ApiDesign", 
        "RS0026:Do not add multiple public overloads with optional parameters", 
        Justification = "Required to maintain compatibility")]
    public abstract Task<HealthReport> CheckHealthAsync(
        Func<HealthCheckRegistration, bool>? predicate,
        CancellationToken cancellationToken = default);
}

```

##### 6.2.1 默认实现

```c#
internal class DefaultHealthCheckService : HealthCheckService
{
    private readonly IServiceScopeFactory _scopeFactory;
    private readonly IOptions<HealthCheckServiceOptions> _options;
    private readonly ILogger<DefaultHealthCheckService> _logger;
    
    public DefaultHealthCheckService(
        IServiceScopeFactory scopeFactory,
        IOptions<HealthCheckServiceOptions> options,
        ILogger<DefaultHealthCheckService> logger)
    {
        _scopeFactory = scopeFactory ?? throw new ArgumentNullException(nameof(scopeFactory));
        _options = options ?? throw new ArgumentNullException(nameof(options));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        
        // We're specifically going out of our way to do this at startup time. We want to make sure you
        // get any kind of health-check related error as early as possible. Waiting until someone
        // actually tries to **run** health checks would be real baaaaad.
        ValidateRegistrations(_options.Value.Registrations);
    }
        
    // 如果传入的 health check registration 集合有重复的 registration，-> 抛出异常
    private static void ValidateRegistrations(IEnumerable<HealthCheckRegistration> registrations)
    {                
        StringBuilder? builder = null;
        var distinctRegistrations = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
                
        foreach (var registration in registrations)
        {
            if (!distinctRegistrations.Add(registration.Name))
            {
                builder ??= new StringBuilder("Duplicate health checks were registered with the name(s): ");                
                builder.Append(registration.Name).Append(", ");
            }
        }
        
        if (builder is not null)
        {
            throw new ArgumentException(
                builder.ToString(0, builder.Length - 2), 
                nameof(registrations));
        }
    }
    
                
    internal static class EventIds
    {
        public static readonly EventId HealthCheckProcessingBegin = new EventId(100, "HealthCheckProcessingBegin");
        public static readonly EventId HealthCheckProcessingEnd = new EventId(101, "HealthCheckProcessingEnd");        
        public static readonly EventId HealthCheckBegin = new EventId(102, "HealthCheckBegin");
        public static readonly EventId HealthCheckEnd = new EventId(103, "HealthCheckEnd");
        public static readonly EventId HealthCheckError = new EventId(104, "HealthCheckError");
        public static readonly EventId HealthCheckData = new EventId(105, "HealthCheckData");
    }
    
    private static class Log
    {
        private static readonly Action<ILogger, Exception?> _healthCheckProcessingBegin = 
            LoggerMessage.Define(
            LogLevel.Debug,
            EventIds.HealthCheckProcessingBegin,
            "Running health checks");
        
        private static readonly Action<ILogger, double, HealthStatus, Exception?> _healthCheckProcessingEnd = 
            LoggerMessage.Define<double, HealthStatus>(
            LogLevel.Debug,
            EventIds.HealthCheckProcessingEnd,
            "Health check processing with combined status {HealthStatus} completed after {ElapsedMilliseconds}ms");
        
        private static readonly Action<ILogger, string, Exception?> _healthCheckBegin = 
            LoggerMessage.Define<string>(
            LogLevel.Debug,
            EventIds.HealthCheckBegin,
            "Running health check {HealthCheckName}");
        
        // These are separate so they can have different log levels
        private const string HealthCheckEndText = 
            "Health check {HealthCheckName} with status {HealthStatus} completed after {ElapsedMilliseconds}ms 
            "with message '{HealthCheckDescription}'";
        
        private static readonly Action<ILogger, string, double, HealthStatus, string?, Exception?> _healthCheckEndHealthy = 
            LoggerMessage.Define<string, double, HealthStatus, string?>(
            LogLevel.Debug,
            EventIds.HealthCheckEnd,
            HealthCheckEndText);
        
        private static readonly Action<ILogger, string, double, HealthStatus, string?, Exception?> _healthCheckEndDegraded = 
            LoggerMessage.Define<string, double, HealthStatus, string?>(
            LogLevel.Warning,
            EventIds.HealthCheckEnd,
            HealthCheckEndText);
        
        private static readonly Action<ILogger, string, double, HealthStatus, string?, Exception?> _healthCheckEndUnhealthy = 
            LoggerMessage.Define<string, double, HealthStatus, string?>(
            LogLevel.Error,
            EventIds.HealthCheckEnd,
            HealthCheckEndText);
        
        private static readonly Action<ILogger, string, double, Exception?> _healthCheckError = 
            LoggerMessage.Define<string, double>(
            LogLevel.Error,
            EventIds.HealthCheckError,
            "Health check {HealthCheckName} threw an unhandled exception after {ElapsedMilliseconds}ms");
        
        public static void HealthCheckProcessingBegin(ILogger logger)
        {
            _healthCheckProcessingBegin(logger, null);
        }
        
        public static void HealthCheckProcessingEnd(
            ILogger logger, 
            HealthStatus status, 
            TimeSpan duration)
        {
            _healthCheckProcessingEnd(logger, duration.TotalMilliseconds, status, null);
        }
        
        public static void HealthCheckBegin(
            ILogger logger, 
            HealthCheckRegistration registration)
        {
            _healthCheckBegin(logger, registration.Name, null);
        }
        
        public static void HealthCheckEnd(
            ILogger logger, 
            HealthCheckRegistration registration, 
            HealthReportEntry entry, 
            TimeSpan duration)
        {
            switch (entry.Status)
            {
                case HealthStatus.Healthy:
                    _healthCheckEndHealthy(
                        logger, 
                        registration.Name, 
                        duration.TotalMilliseconds, 
                        entry.Status, 
                        entry.Description, 
                        null);
                    break;
                    
                case HealthStatus.Degraded:
                    _healthCheckEndDegraded(
                        logger, 
                        registration.Name, 
                        duration.TotalMilliseconds,
                        entry.Status, 
                        entry.Description, 
                        null);
                    break;
                    
                case HealthStatus.Unhealthy:
                    _healthCheckEndUnhealthy(
                        logger, 
                        registration.Name, 
                        duration.TotalMilliseconds, 
                        entry.Status, 
                        entry.Description, 
                        entry.Exception);
                    break;
            }
        }
        
        public static void HealthCheckError(
            ILogger logger, 
            HealthCheckRegistration registration, 
            Exception exception, 
            TimeSpan duration)
        {
            _healthCheckError(logger, registration.Name, duration.TotalMilliseconds, exception);
        }
        
        public static void HealthCheckData(
            ILogger logger, 
            HealthCheckRegistration registration, 
            HealthReportEntry entry)
        {
            if (entry.Data.Count > 0 && logger.IsEnabled(LogLevel.Debug))
            {
                logger.Log(
                    LogLevel.Debug,
                    EventIds.HealthCheckData,
                    new HealthCheckDataLogValue(registration.Name, entry.Data),
                    null,
                    (state, ex) => state.ToString());
            }
        }
    }
    
    internal class HealthCheckDataLogValue : IReadOnlyList<KeyValuePair<string, object>>
    {
        private readonly string _name;
        private readonly List<KeyValuePair<string, object>> _values;        
        private string? _formatted;
        
        public HealthCheckDataLogValue(string name, IReadOnlyDictionary<string, object> values)
        {
            _name = name;
            _values = values.ToList();
            
            // We add the name as a kvp so that you can filter by health check name in the logs.
            // This is the same parameter name used in the other logs.
            _values.Add(new KeyValuePair<string, object>("HealthCheckName", name));
        }
        
        public KeyValuePair<string, object> this[int index]
            
        {
            get
            {
                if (index < 0 || index >= Count)
                {
                    throw new IndexOutOfRangeException(nameof(index));
                }
                
                return _values[index];
            }
        }
        
        public int Count => _values.Count;
        
        public IEnumerator<KeyValuePair<string, object>> GetEnumerator()
        {
            return _values.GetEnumerator();
        }
        
        IEnumerator IEnumerable.GetEnumerator()
        {
            return _values.GetEnumerator();
        }
        
        public override string ToString()
        {
            if (_formatted == null)
            {
                var builder = new StringBuilder();
                builder.AppendLine($"Health check data for {_name}:");
                
                var values = _values;
                for (var i = 0; i < values.Count; i++)
                {
                    var kvp = values[i];
                    builder.Append("    ");
                    builder.Append(kvp.Key);
                    builder.Append(": ");
                    
                    builder.AppendLine(kvp.Value?.ToString());
                }
                
                _formatted = builder.ToString();
            }
            
            return _formatted;
        }
    }
}

```

##### - 方法 check

```c#
internal class DefaultHealthCheckService : HealthCheckService
{   
    public override async Task<HealthReport> CheckHealthAsync(
        Func<HealthCheckRegistration, bool>? predicate,
        CancellationToken cancellationToken = default)
    {
        // 从 health check options 解析 health check registrations 集合
        var registrations = _options.Value.Registrations;
        // 按照 predicate 过滤 health check registration
        if (predicate != null)
        {
            registrations = registrations.Where(predicate).ToArray();
        }
        
        var totalTime = ValueStopwatch.StartNew();        
        Log.HealthCheckProcessingBegin(_logger);
        
        // （预结果）
        var tasks = new Task<HealthReportEntry>[registrations.Count];
        var index = 0;
        
        // 遍历（过滤后的）health check registration，
        foreach (var registration in registrations)
        {
            tasks[index++] = Task.Run(() => RunCheckAsync(registration, cancellationToken), cancellationToken);
        }
        // 等待执行
        await Task.WhenAll(tasks).ConfigureAwait(false);
        // 注入执行结果到 health check entries        
        index = 0;
        var entries = new Dictionary<string, HealthReportEntry>(StringComparer.OrdinalIgnoreCase);
        foreach (var registration in registrations)
        {
            entries[registration.Name] = tasks[index++].Result;
        }
                
        var totalElapsedTime = totalTime.GetElapsedTime();
        // 创建 health check report，封装 health check entries
        var report = new HealthReport(entries, totalElapsedTime);
        Log.HealthCheckProcessingEnd(_logger, report.Status, totalElapsedTime);
        return report;
    }
    
    // run check
    private async Task<HealthReportEntry> RunCheckAsync(
        HealthCheckRegistration registration, 
        CancellationToken cancellationToken)
    {
        cancellationToken.ThrowIfCancellationRequested();
        
        // 创建 service scope
        using (var scope = _scopeFactory.CreateScope())
        {
            // 由 health check registration 创建 health check
            var healthCheck = registration.Factory(scope.ServiceProvider);
            
            // If the health check does things like make Database queries using EF or backend HTTP calls,
            // it may be valuable to know that logs it generates are part of a health check. So we start a scope.
            using (_logger.BeginScope(new HealthCheckLogScope(registration.Name)))
            {
                var stopwatch = ValueStopwatch.StartNew();
                var context = new HealthCheckContext { Registration = registration };                
                Log.HealthCheckBegin(_logger, registration);                
                HealthReportEntry entry;
                CancellationTokenSource? timeoutCancellationTokenSource = null;
                
                try
                {
                    HealthCheckResult result;
                    
                    var checkCancellationToken = cancellationToken;
                    if (registration.Timeout > TimeSpan.Zero)
                    {
                        timeoutCancellationTokenSource = CancellationTokenSource.CreateLinkedTokenSource(cancellationToken);
                        timeoutCancellationTokenSource.CancelAfter(registration.Timeout);
                        checkCancellationToken = timeoutCancellationTokenSource.Token;
                    }
                    
                    // 执行 health check
                    result = await healthCheck.CheckHealthAsync(context, checkCancellationToken).ConfigureAwait(false);
                    
                    var duration = stopwatch.GetElapsedTime();
                    
                    // 创建 health report entry，封装 health check result
                    entry = new HealthReportEntry(
                        status: result.Status,
                        description: result.Description,
                        duration: duration,
                        exception: result.Exception,
                        data: result.Data,
                        tags: registration.Tags);
                    
                    Log.HealthCheckEnd(_logger, registration, entry, duration);
                    Log.HealthCheckData(_logger, registration, entry);
                }
                catch (OperationCanceledException ex) when (!cancellationToken.IsCancellationRequested)
                {
                    var duration = stopwatch.GetElapsedTime();
                    entry = new HealthReportEntry(
                        status: registration.FailureStatus,
                        description: "A timeout occurred while running check.",
                        duration: duration,
                        exception: ex,
                        data: null,
                        tags: registration.Tags);
                    
                    Log.HealthCheckError(_logger, registration, ex, duration);
                }                
                // Allow cancellation to propagate if it's not a timeout.
                catch (Exception ex) when (ex as OperationCanceledException == null)
                {
                    var duration = stopwatch.GetElapsedTime();
                    entry = new HealthReportEntry(
                        status: registration.FailureStatus,
                        description: ex.Message,
                        duration: duration,
                        exception: ex,
                        data: null,
                        tags: registration.Tags);
                    
                    Log.HealthCheckError(_logger, registration, ex, duration);
                }
                
                finally
                {
                    timeoutCancellationTokenSource?.Dispose();
                }
                
                return entry;
            }
        }
    }
}

```

##### 6.2.2 health check service options

```c#
public sealed class HealthCheckServiceOptions
{    
    public ICollection<HealthCheckRegistration> Registrations { get; } = 
       new List<HealthCheckRegistration>();
}

```

##### 6.2.3 health check report

```c#
public sealed class HealthReport
{
    public IReadOnlyDictionary<string, HealthReportEntry> Entries { get; }        
    public HealthStatus Status { get; }        
    public TimeSpan TotalDuration { get; }
    
    public HealthReport(
        IReadOnlyDictionary<string, HealthReportEntry> entries, 
        TimeSpan totalDuration) : 
    		this(
                entries,
                CalculateAggregateStatus(entries?.Values ?? throw new ArgumentNullException(nameof(entries))),
                totalDuration)
    {
    }
        
    public HealthReport(
        IReadOnlyDictionary<string, HealthReportEntry> entries, 
        HealthStatus status, 
        TimeSpan totalDuration)
    {
        Entries = entries;
        Status = status;
        TotalDuration = totalDuration;
    }
                
    private static HealthStatus CalculateAggregateStatus(IEnumerable<HealthReportEntry> entries)
    {
        // This is basically a Min() check, but we know the possible range, so we don't need to walk the whole list
        var currentValue = HealthStatus.Healthy;
        foreach (var entry in entries)
        {
            if (currentValue > entry.Status)
            {
                currentValue = entry.Status;
            }
            
            if (currentValue == HealthStatus.Unhealthy)
            {
                // Game over, man! Game over!
                // (We hit the worst possible status, so there's no need to keep iterating)
                return currentValue;
            }
        }
        
        return currentValue;
    }
}

```

###### 6.2.3.1 health report entry

```c#
public struct HealthReportEntry
{
    private static readonly IReadOnlyDictionary<string, object> _emptyReadOnlyDictionary = new Dictionary<string, object>();
    
    public IReadOnlyDictionary<string, object> Data { get; }        
    public string? Description { get; }       
    public TimeSpan Duration { get; }       
    public Exception? Exception { get; }           
    public HealthStatus Status { get; }        
    public IEnumerable<string> Tags { get; }
                
    public HealthReportEntry(
        HealthStatus status, 
        string? description, 
        TimeSpan duration, 
        Exception? exception, 
        IReadOnlyDictionary<string, object>? data) : 
    		this(status, description, duration, exception, data, null)
    {
    }
        
    public HealthReportEntry(
        HealthStatus status, 
        string? description, 
        TimeSpan duration, 
        Exception? exception, 
        IReadOnlyDictionary<string, object>? data, 
        IEnumerable<string>? tags = null)
    {
        Status = status;
        Description = description;
        Duration = duration;
        Exception = exception;
        Data = data ?? _emptyReadOnlyDictionary;
        Tags = tags ?? Enumerable.Empty<string>();
    }    
}

```

#### 6.3 health check publisher

```c#
public interface IHealthCheckPublisher
{    
    Task PublishAsync(HealthReport report, CancellationToken cancellationToken);
}

```

##### 6.3.1 health check publisher options

```c#
public sealed class HealthCheckPublisherOptions
{
    // delay
    private TimeSpan _delay;
    public TimeSpan Delay
    {
        get => _delay;
        set
        {
            if (value == System.Threading.Timeout.InfiniteTimeSpan)
            {
                throw new ArgumentException(
                    $"The {nameof(Delay)} must not be infinite.", 
                    nameof(value));
            }
            
            _delay = value;
        }
    }
    
    // period
    private TimeSpan _period;
    public TimeSpan Period
    {
        get => _period;
        set
        {
            if (value < TimeSpan.FromSeconds(1))
            {
                throw new ArgumentException(
                    $"The {nameof(Period)} must be greater than or equal to one second.", 
                    nameof(value));
            }
            
            if (value == System.Threading.Timeout.InfiniteTimeSpan)
            {
                throw new ArgumentException(
                    $"The {nameof(Period)} must not be infinite.", 
                    nameof(value));
            }
            
            _period = value;
        }
    }
    
    // predicate
    public Func<HealthCheckRegistration, bool>? Predicate { get; set; }        
    
    // timeout
    public TimeSpan Timeout { get; set; } = TimeSpan.FromSeconds(30);
        
    public HealthCheckPublisherOptions()
    {
        _delay = TimeSpan.FromSeconds(5);
        _period = TimeSpan.FromSeconds(30);
    }    
}

```

##### 6.3.2 health check publisher hosted service

```c#
internal sealed class HealthCheckPublisherHostedService : IHostedService
{            
    private readonly HealthCheckService _healthCheckService;
    private readonly IOptions<HealthCheckPublisherOptions> _options;    
    private readonly IHealthCheckPublisher[] _publishers;
    
    private readonly ILogger _logger;
    private CancellationTokenSource? _runTokenSource;
    private CancellationTokenSource _stopping;
    internal bool IsStopping => _stopping.IsCancellationRequested;   
    private Timer? _timer;
    internal bool IsTimerRunning => _timer != null;
                 
    public HealthCheckPublisherHostedService(
        HealthCheckService healthCheckService,
        IOptions<HealthCheckPublisherOptions> options,
        ILogger<HealthCheckPublisherHostedService> logger,
        IEnumerable<IHealthCheckPublisher> publishers)
    {
        if (healthCheckService == null)
        {
            throw new ArgumentNullException(nameof(healthCheckService));
        }        
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }        
        if (logger == null)
        {
            throw new ArgumentNullException(nameof(logger));
        }        
        if (publishers == null)
        {
            throw new ArgumentNullException(nameof(publishers));
        }
        
        _healthCheckService = healthCheckService;
        _options = options;
        _logger = logger;
        _publishers = publishers.ToArray();
        
        _stopping = new CancellationTokenSource();
    }
    
    internal void CancelToken()
    {
        _runTokenSource!.Cancel();
    }
    
    internal static class EventIds
    {
        public static readonly EventId HealthCheckPublisherProcessingBegin = 
            new EventId(100, "HealthCheckPublisherProcessingBegin");
        public static readonly EventId HealthCheckPublisherProcessingEnd = 
            new EventId(101, "HealthCheckPublisherProcessingEnd");
        public static readonly EventId HealthCheckPublisherProcessingError = 
            new EventId(101, "HealthCheckPublisherProcessingError");
        
        public static readonly EventId HealthCheckPublisherBegin = 
            new EventId(102, "HealthCheckPublisherBegin");
        public static readonly EventId HealthCheckPublisherEnd = 
            new EventId(103, "HealthCheckPublisherEnd");
        public static readonly EventId HealthCheckPublisherError = 
            new EventId(104, "HealthCheckPublisherError");
        public static readonly EventId HealthCheckPublisherTimeout = 
            new EventId(104, "HealthCheckPublisherTimeout");
    }
    
    private static class Logger
    {                                                                                                
        // processing begin
        public static void HealthCheckPublisherProcessingBegin(ILogger logger)
        {
            _healthCheckPublisherProcessingBegin(logger, null);
        }
        
        private static readonly Action<ILogger, Exception?> _healthCheckPublisherProcessingBegin = 
            LoggerMessage.Define(
	            LogLevel.Debug,
    	        ventIds.HealthCheckPublisherProcessingBegin,            
        	    "Running health check publishers");
        
        // processing end
        public static void HealthCheckPublisherProcessingEnd(
            ILogger logger, 
            TimeSpan duration, 
            Exception? exception = null)
        {
            _healthCheckPublisherProcessingEnd(logger, duration.TotalMilliseconds, exception);
        }
        
        private static readonly Action<ILogger, double, Exception?> _healthCheckPublisherProcessingEnd = 
            LoggerMessage.Define<double>(
            	LogLevel.Debug,
            	EventIds.HealthCheckPublisherProcessingEnd,
            	"Health check publisher processing completed after {ElapsedMilliseconds}ms");
        
        // begin
        public static void HealthCheckPublisherBegin(
            ILogger logger, 
            IHealthCheckPublisher publisher)
        {
            _healthCheckPublisherBegin(logger, publisher, null);
        }
        
        private static readonly Action<ILogger, IHealthCheckPublisher, Exception?> _healthCheckPublisherBegin = 
            LoggerMessage.Define<IHealthCheckPublisher>(
	            LogLevel.Debug,
    	        EventIds.HealthCheckPublisherBegin,
        	    "Running health check publisher '{HealthCheckPublisher}'");
        
        // end
        public static void HealthCheckPublisherEnd(
            ILogger logger, 
            IHealthCheckPublisher publisher, 
            TimeSpan duration)
        {
            _healthCheckPublisherEnd(logger, publisher, duration.TotalMilliseconds, null);
        }
        
        private static readonly Action<ILogger, IHealthCheckPublisher, double, Exception?> _healthCheckPublisherEnd = 
            LoggerMessage.Define<IHealthCheckPublisher, double>(
	            LogLevel.Debug,
    	        EventIds.HealthCheckPublisherEnd,
        	    "Health check '{HealthCheckPublisher}' completed after {ElapsedMilliseconds}ms");
        
        // error
        public static void HealthCheckPublisherError(
            ILogger logger, 
            IHealthCheckPublisher publisher, 
            TimeSpan duration, 
            Exception exception)
        {
            _healthCheckPublisherError(logger, publisher, duration.TotalMilliseconds, exception);
        }
        
        private static readonly Action<ILogger, IHealthCheckPublisher, double, Exception?> _healthCheckPublisherError = 
            LoggerMessage.Define<IHealthCheckPublisher, double>(
	            LogLevel.Error,
    	        EventIds.HealthCheckPublisherError,
        	    "Health check {HealthCheckPublisher} threw an unhandled exception after {ElapsedMilliseconds}ms");
        
        // timeout
        public static void HealthCheckPublisherTimeout(
            ILogger logger, 
            IHealthCheckPublisher publisher, 
            TimeSpan duration)
        {
            _healthCheckPublisherTimeout(logger, publisher, duration.TotalMilliseconds, null);
        }
        
        private static readonly Action<ILogger, IHealthCheckPublisher, double, Exception?> _healthCheckPublisherTimeout = 
            LoggerMessage.Define<IHealthCheckPublisher, double>(
	            LogLevel.Error,
    	        EventIds.HealthCheckPublisherTimeout,
        	    "Health check {HealthCheckPublisher} was canceled after {ElapsedMilliseconds}ms");
    }
}

```

###### 6.3.2.1 start

```c#
internal sealed class HealthCheckPublisherHostedService : IHostedService
{
    public Task StartAsync(CancellationToken cancellationToken = default)
    {
        if (_publishers.Length == 0)
        {
            return Task.CompletedTask;
        }
        
        // IMPORTANT - make sure this is the last thing that happens in this method. 
        // The timer can fire before other code runs.
        _timer = NonCapturingTimer.Create(
            Timer_Tick, 
            null, 
            dueTime: _options.Value.Delay, 
            period: _options.Value.Period);
        
        return Task.CompletedTask;
    }
    
    private async void Timer_Tick(object? state)
    {
        await RunAsync();
    }
    
    internal async Task RunAsync()
    {
        var duration = ValueStopwatch.StartNew();
        Logger.HealthCheckPublisherProcessingBegin(_logger);
        
        CancellationTokenSource? cancellation = null;
        
        try
        {
            // 从 health check publisher options 解析 timeout
            var timeout = _options.Value.Timeout;
            // 创建 run token source
            cancellation = CancellationTokenSource.CreateLinkedTokenSource(_stopping.Token);
            _runTokenSource = cancellation;
            // timeout 之后 cancel run token
            cancellation.CancelAfter(timeout);
            
            // 执行 run async core
            await RunAsyncCore(cancellation.Token);
            
            Logger.HealthCheckPublisherProcessingEnd(_logger, duration.GetElapsedTime());
        }
        catch (OperationCanceledException) when (IsStopping)
        {
            // This is a cancellation - if the app is shutting down we want to ignore it. 
            // Otherwise, it's a timeout and we want to log it.
        }
        catch (Exception ex)
        {
            // This is an error, publishing failed.
            Logger.HealthCheckPublisherProcessingEnd(_logger, duration.GetElapsedTime(), ex);
        }
        finally
        {
            cancellation?.Dispose();
        }
    }
    
    private async Task RunAsyncCore(CancellationToken cancellationToken)
    {
        // Forcibly yield - we want to unblock the timer thread.
        await Task.Yield();
        
        // The health checks service does it's own logging, and doesn't throw exceptions.
        // 使用 health check service 的 check health 方法，得到 health check report
        var report = await _healthCheckService.CheckHealthAsync(_options.Value.Predicate, cancellationToken);
        
        // 遍历 health check publisher，注入 run publish 方法
        var publishers = _publishers;
        var tasks = new Task[publishers.Length];
        for (var i = 0; i < publishers.Length; i++)
        {
            tasks[i] = RunPublisherAsync(publishers[i], report, cancellationToken);
        }
        // 等待执行 health check publisher
        await Task.WhenAll(tasks);
    }
    
    private async Task RunPublisherAsync(
        IHealthCheckPublisher publisher, 
        HealthReport report, 
        CancellationToken cancellationToken)
    {
        var duration = ValueStopwatch.StartNew();
        
        try
        {
            Logger.HealthCheckPublisherBegin(_logger, publisher);
            
            // 执行 publisher 的 publish 方法 
            await publisher.PublishAsync(report, cancellationToken);
            Logger.HealthCheckPublisherEnd(_logger, publisher, duration.GetElapsedTime());
        }
        catch (OperationCanceledException) when (IsStopping)
        {
            // This is a cancellation - if the app is shutting down we want to ignore it. 
            // Otherwise, it's a timeout and we want to log it.
        }
        catch (OperationCanceledException)
        {
            Logger.HealthCheckPublisherTimeout(_logger, publisher, duration.GetElapsedTime());
            throw;
        }
        catch (Exception ex)
        {
            Logger.HealthCheckPublisherError(_logger, publisher, duration.GetElapsedTime(), ex);
            throw;
        }
    }
}

```

###### 6.3.2.2 stop

```c#
internal sealed class HealthCheckPublisherHostedService : IHostedService
{
    public Task StopAsync(CancellationToken cancellationToken = default)
    {
        try
        {
            _stopping.Cancel();
        }
        catch
        {
            // Ignore exceptions thrown as a result of a cancellation.
        }
        
        if (_publishers.Length == 0)
        {
            return Task.CompletedTask;
        }
        
        _timer?.Dispose();
        _timer = null;
                
        return Task.CompletedTask;
    }
}
```



#### 6.3 add health check

```c#
public static class HealthCheckServiceCollectionExtensions
{    
    public static IHealthChecksBuilder AddHealthChecks(this IServiceCollection services)
    {
        // 注入 health check service
        services.TryAddSingleton<HealthCheckService, DefaultHealthCheckService>();
        // 注入 health check publisher hosted service
        services.TryAddEnumerable(
            ServiceDescriptor.Singleton<IHostedService, 
            HealthCheckPublisherHostedService>());
        
        // 创建 health check builder
        return new HealthChecksBuilder(services);
    }
}

```

##### 6.3.1 health checks builder

```c#
// 接口
public interface IHealthChecksBuilder
{
    IServiceCollection Services { get; }
    IHealthChecksBuilder Add(HealthCheckRegistration registration);            
}

// 实现
internal class HealthChecksBuilder : IHealthChecksBuilder
{
    public IServiceCollection Services { get; }
    public HealthChecksBuilder(IServiceCollection services)
    {
        Services = services;
    }
            
    public IHealthChecksBuilder Add(HealthCheckRegistration registration)
    {
        if (registration == null)
        {
            throw new ArgumentNullException(nameof(registration));
        }
        
        Services.Configure<HealthCheckServiceOptions>(options =>
            {
                options.Registrations.Add(registration);
            });
        
        return this;
    }
}

```

###### 6.3.1.1 add check extensions

```c#
public static class HealthChecksBuilderAddCheckExtensions
{
    // by "health check" instance
    public static IHealthChecksBuilder AddCheck(
        this IHealthChecksBuilder builder,
        string name,
        IHealthCheck instance,
        HealthStatus? failureStatus,
        IEnumerable<string> tags)
    {
        return AddCheck(builder, name, instance, failureStatus, tags, default);
    }
            
    [SuppressMessage(
        "ApiDesign", 
        "RS0026:Do not add multiple public overloads with optional parameters", 
        Justification = "Required to maintain compatibility")]
    public static IHealthChecksBuilder AddCheck(
        this IHealthChecksBuilder builder,
        string name,
        IHealthCheck instance,
        HealthStatus? failureStatus = null,
        IEnumerable<string>? tags = null,
        TimeSpan? timeout = null)
    {
        if (builder == null)
        {
            throw new ArgumentNullException(nameof(builder));
        }        
        if (name == null)
        {
            throw new ArgumentNullException(nameof(name));
        }        
        if (instance == null)
        {
            throw new ArgumentNullException(nameof(instance));
        }
        
        return builder.Add(new HealthCheckRegistration(name, instance, failureStatus, tags, timeout));
    }
    
    // by "t of health check"，使用 activator 解析    
    public static IHealthChecksBuilder AddCheck<T>(
        this IHealthChecksBuilder builder,
        string name,
        HealthStatus? failureStatus,
        IEnumerable<string> tags) where T : class, IHealthCheck
    {
        return AddCheck<T>(builder, name, failureStatus, tags, default);
    }
            
    [SuppressMessage(
        "ApiDesign", 
        "RS0027:Public API with optional parameter(s) should have the most parameters amongst its public overloads.", 
        Justification = "Required to maintain compatibility")]
    public static IHealthChecksBuilder AddCheck<T>(
        this IHealthChecksBuilder builder,
        string name,
        HealthStatus? failureStatus = null,
        IEnumerable<string>? tags = null,
        TimeSpan? timeout = null) where T : class, IHealthCheck
    {
        if (builder == null)
        {
            throw new ArgumentNullException(nameof(builder));
        }        
        if (name == null)
        {
            throw new ArgumentNullException(nameof(name));
        }
        
        return builder.Add(
            new HealthCheckRegistration(
                name, 
                s => ActivatorUtilities.GetServiceOrCreateInstance<T>(s), 
                failureStatus, 
                tags, 
                timeout));
    }
    
    // by "health check" type，使用 activator 创建
    public static IHealthChecksBuilder AddTypeActivatedCheck<T>(
        this IHealthChecksBuilder builder, 
        string name, 
        params object[] args) 
        	where T : class, IHealthCheck
    {
        if (builder == null)
        {
            throw new ArgumentNullException(nameof(builder));
        }        
        if (name == null)
        {
            throw new ArgumentNullException(nameof(name));
        }
        
        return AddTypeActivatedCheck<T>(builder, name, failureStatus: null, tags: null, args);
    }
        
    public static IHealthChecksBuilder AddTypeActivatedCheck<T>(
        this IHealthChecksBuilder builder,
        string name,
        HealthStatus? failureStatus,
        params object[] args) where T : class, IHealthCheck
    {
        if (builder == null)
        {
            throw new ArgumentNullException(nameof(builder));
        }        
        if (name == null)
        {
            throw new ArgumentNullException(nameof(name));
        }
        
        return AddTypeActivatedCheck<T>(builder, name, failureStatus, tags: null, args);
    }
      
    // 1-
    public static IHealthChecksBuilder AddTypeActivatedCheck<T>(
        this IHealthChecksBuilder builder,
        string name,
        HealthStatus? failureStatus,
        IEnumerable<string>? tags,
        params object[] args) where T : class, IHealthCheck
    {
        if (builder == null)
        {
            throw new ArgumentNullException(nameof(builder));
        }        
        if (name == null)
        {
            throw new ArgumentNullException(nameof(name));
        }
        
        return builder.Add(
            new HealthCheckRegistration(
                name, 
                s => ActivatorUtilities.CreateInstance<T>(s, args), 
                failureStatus, 
                tags));
    }
     
    // 2-
    public static IHealthChecksBuilder AddTypeActivatedCheck<T>(
        this IHealthChecksBuilder builder,
        string name,
        HealthStatus? failureStatus,
        IEnumerable<string> tags,
        TimeSpan timeout,
        params object[] args) where T : class, IHealthCheck
    {
        if (builder == null)
        {
            throw new ArgumentNullException(nameof(builder));
        }        
        if (name == null)
        {
            throw new ArgumentNullException(nameof(name));
        }
        
        return builder.Add(
            new HealthCheckRegistration(
                name, 
                s => ActivatorUtilities.CreateInstance<T>(s, args), 
                failureStatus,
                tags,
                timeout));
    }
}

```

###### 6.3.1.2 add delegate check extensions

```c#
public static class HealthChecksBuilderDelegateExtensions
{    
    // by func<health check result>
    public static IHealthChecksBuilder AddCheck(
        this IHealthChecksBuilder builder,
        string name,
        Func<HealthCheckResult> check,
        IEnumerable<string> tags)
    {
        return AddCheck(builder, name, check, tags, default);
    }
           
    [SuppressMessage(
        "ApiDesign", 
        "RS0026:Do not add multiple public overloads with optional parameters", 
        Justification = "Required to maintain compatibility")]
    public static IHealthChecksBuilder AddCheck(
        this IHealthChecksBuilder builder,
        string name,
        Func<HealthCheckResult> check,
        IEnumerable<string>? tags = null,
        TimeSpan? timeout = default)
    {
        if (builder == null)
        {
            throw new ArgumentNullException(nameof(builder));
        }        
        if (name == null)
        {
            throw new ArgumentNullException(nameof(name));
        }        
        if (check == null)
        {
            throw new ArgumentNullException(nameof(check));
        }
        
        var instance = new DelegateHealthCheck((ct) => Task.FromResult(check()));
        return builder.Add(new HealthCheckRegistration(name, instance, failureStatus: null, tags, timeout));
    }
          
    // by func<cancellation token, health check result>
    public static IHealthChecksBuilder AddCheck(
        this IHealthChecksBuilder builder,
        string name,
        Func<CancellationToken, HealthCheckResult> check,
        IEnumerable<string>? tags)
    {
        return AddCheck(builder, name, check, tags, default);
    }
        
    [SuppressMessage(
        "ApiDesign", 
        "RS0026:Do not add multiple public overloads with optional parameters", 
        Justification = "Required to maintain compatibility")]
    public static IHealthChecksBuilder AddCheck(
        this IHealthChecksBuilder builder,
        string name,
        Func<CancellationToken, HealthCheckResult> check,
        IEnumerable<string>? tags = null,
        TimeSpan? timeout = default)
    {
        if (builder == null)
        {
            throw new ArgumentNullException(nameof(builder));
        }        
        if (name == null)
        {
            throw new ArgumentNullException(nameof(name));
        }        
        if (check == null)
        {
            throw new ArgumentNullException(nameof(check));
        }
        
        var instance = new DelegateHealthCheck((ct) => Task.FromResult(check(ct)));
        return builder.Add(new HealthCheckRegistration(name, instance, failureStatus: null, tags, timeout));
    }
        
    // by func<task<health check result>>
    public static IHealthChecksBuilder AddAsyncCheck(
        this IHealthChecksBuilder builder,
        string name,
        Func<Task<HealthCheckResult>> check,
        IEnumerable<string> tags)
    {
        return AddAsyncCheck(builder, name, check, tags, default);
    }
        
    [SuppressMessage(
        "ApiDesign", 
        "RS0026:Do not add multiple public overloads with optional parameters", 
        Justification = "Required to maintain compatibility")]
    public static IHealthChecksBuilder AddAsyncCheck(
        this IHealthChecksBuilder builder,
        string name,
        Func<Task<HealthCheckResult>> check,
        IEnumerable<string>? tags = null,
        TimeSpan? timeout = default)
    {
        if (builder == null)
        {
            throw new ArgumentNullException(nameof(builder));
        }        
        if (name == null)
        {
            throw new ArgumentNullException(nameof(name));
        }        
        if (check == null)
        {
            throw new ArgumentNullException(nameof(check));
        }
        
        var instance = new DelegateHealthCheck((ct) => check());
        return builder.Add(new HealthCheckRegistration(name, instance, failureStatus: null, tags, timeout));
    }

    // by func<cancel token, task<health check result>>    
    public static IHealthChecksBuilder AddAsyncCheck(
        this IHealthChecksBuilder builder,
        string name,
        Func<CancellationToken, Task<HealthCheckResult>> check,
        IEnumerable<string> tags)
    {
        return AddAsyncCheck(builder, name, check, tags, default);
    }
            
    [SuppressMessage(
        "ApiDesign", 
        "RS0026:Do not add multiple public overloads with optional parameters", 
        Justification = "Required to maintain compatibility")]
    public static IHealthChecksBuilder AddAsyncCheck(
        this IHealthChecksBuilder builder,
        string name,
        Func<CancellationToken, Task<HealthCheckResult>> check,
        IEnumerable<string>? tags = null,
        TimeSpan? timeout = default)
    {
        if (builder == null)
        {
            throw new ArgumentNullException(nameof(builder));
        }                
        if (name == null)
        {
            throw new ArgumentNullException(nameof(name));
        }        
        if (check == null)
        {
            throw new ArgumentNullException(nameof(check));
        }
        
        var instance = new DelegateHealthCheck((ct) => check(ct));
        return builder.Add(new HealthCheckRegistration(name, instance, failureStatus: null, tags, timeout));
    }
}

```

#### 6.4 use health check

```c#
public static class HealthCheckApplicationBuilderExtensions
{    
    // If "path" is set to null or the empty string then the health check middleware will ignore the URL path 
    // and process all requests. 
    // If "path" is set to a non-empty value, the health check middleware will process requests with a URL that 
    // matches the provided value of "path" case-insensitively, allowing for an extra trailing slash ('/') character.    
    // The health check middleware will use default settings from "IOptions{HealthCheckOptions}".   
    
    public static IApplicationBuilder UseHealthChecks(
        this IApplicationBuilder app, 
        PathString path)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        UseHealthChecksCore(app, path, port: null, Array.Empty<object>());
        return app;
    }
                
    public static IApplicationBuilder UseHealthChecks(
        this IApplicationBuilder app, 
        PathString path, 
        HealthCheckOptions options)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }        
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }
        
        UseHealthChecksCore(app, path, port: null, new[] { Options.Create(options), });
        return app;
    }
                
    public static IApplicationBuilder UseHealthChecks(
        this IApplicationBuilder app, 
        PathString path, 
        int port)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }
        
        UseHealthChecksCore(app, path, port, Array.Empty<object>());
        return app;
    }
        
    public static IApplicationBuilder UseHealthChecks(
        this IApplicationBuilder app, 
        PathString path, 
        string port)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }        
        if (port == null)
        {
            throw new ArgumentNullException(nameof(port));
        }        
        if (!int.TryParse(port, out var portAsInt))
        {
            throw new ArgumentException("The port must be a valid integer.", nameof(port));
        }
        
        UseHealthChecksCore(app, path, portAsInt, Array.Empty<object>());
        return app;
    }
            
    public static IApplicationBuilder UseHealthChecks(
        this IApplicationBuilder app, 
        PathString path, 
        int port, 
        HealthCheckOptions options)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }        
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }
        
        UseHealthChecksCore(app, path, port, new[] { Options.Create(options), });
        return app;
    }
                   
    public static IApplicationBuilder UseHealthChecks(
        this IApplicationBuilder app, 
        PathString path, 
        string port, 
        HealthCheckOptions options)
    {
        if (app == null)
        {
            throw new ArgumentNullException(nameof(app));
        }        
        if (path == null)
        {
            throw new ArgumentNullException(nameof(path));
        }        
        if (port == null)
        {
            throw new ArgumentNullException(nameof(port));
        }        
        if (!int.TryParse(port, out var portAsInt))
        {
            throw new ArgumentException("The port must be a valid integer.", nameof(port));
        }
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }
        
        UseHealthChecksCore(app, path, portAsInt, new[] { Options.Create(options), });
        return app;
    }
    
    // 真正的 middleware
    private static void UseHealthChecksCore(
        IApplicationBuilder app, 
        PathString path, 
        int? port, 
        object[] args)
    {
        // 如果没有注册 health check service，-> 抛出异常
        if (app.ApplicationServices.GetService(typeof(HealthCheckService)) == null)
        {
            throw new InvalidOperationException(Resources.FormatUnableToFindServices(
                nameof(IServiceCollection),
                nameof(HealthCheckServiceCollectionExtensions.AddHealthChecks),
                "ConfigureServices(...)"));
        }

        // NOTE: we explicitly don't use Map here because it's really common for multiple health check middleware 
        // to overlap in paths. 
        // Ex: `/health`, `/health/detailed` - this is order sensitive with Map, and it's really surprising to people.       
        Func<HttpContext, bool> predicate = c =>
        {
            return                
                // Process the port if we have one
                (port == null || c.Connection.LocalPort == port) &&                
                // We allow you to listen on all URLs by providing the empty PathString.
                (!path.HasValue ||
                 
                 // If you do provide a PathString, want to handle all of the special cases that StartsWithSegments handles, 
                 // but we also want it to have exact match semantics.                 
                 //   Ex: /Foo/ == /Foo (true)
                 //   Ex: /Foo/Bar == /Foo (false)
                 (c.Request.Path.StartsWithSegments(path, out var remaining) &&
                  string.IsNullOrEmpty(remaining)));
        };
        
        app.MapWhen(predicate, b => b.UseMiddleware<HealthCheckMiddleware>(args));
    }
}

```

##### 6.4.1 health check options

```c#
public class HealthCheckOptions
{              
    // predicate
    public Func<HealthCheckRegistration, bool>? Predicate { get; set; }          
    
    // response writer
    public Func<HttpContext, HealthReport, Task> ResponseWriter { get; set; } = 
        HealthCheckResponseWriters.WriteMinimalPlaintext;
    
    // allow cache    
    public bool AllowCachingResponses { get; set; }
    
    // result status code
    private IDictionary<HealthStatus, int> _resultStatusCodes = 
        new Dictionary<HealthStatus, int>(DefaultStatusCodesMapping);
    public IDictionary<HealthStatus, int> ResultStatusCodes
    {
        get => _resultStatusCodes;
        set => _resultStatusCodes = value != null 
            // 1- validate 
            ? ValidateStatusCodesMapping(value) 
            // 2- default
            : new Dictionary<HealthStatus, int>(DefaultStatusCodesMapping);
    }
                          
    // 1- validate status code mapping
    private static IDictionary<HealthStatus, int> ValidateStatusCodesMapping(IDictionary<HealthStatus,int> mapping)
    {
        var missingHealthStatus = ((HealthStatus[])Enum.GetValues(typeof(HealthStatus))).Except(mapping.Keys).ToList();
        
        if (missingHealthStatus.Count > 0)
        {
            var missing = string.Join(
                ", ", 
                missingHealthStatus.Select(status => $"{nameof(HealthStatus)}.{status}"));
            
            var message =
                $"The {nameof(ResultStatusCodes)} dictionary must include an entry for all possible " +
                $"{nameof(HealthStatus)} values. Missing: {missing}";
            
            throw new InvalidOperationException(message);
        }
        
        return mapping;
    }
    
    // 2- default status code mapping
    private static readonly IReadOnlyDictionary<HealthStatus, int> DefaultStatusCodesMapping = 
        new Dictionary<HealthStatus, int>
    	{
        	{HealthStatus.Healthy, StatusCodes.Status200OK},
        	{HealthStatus.Degraded, StatusCodes.Status200OK},
        	{HealthStatus.Unhealthy, StatusCodes.Status503ServiceUnavailable},
    	};        
}

```

##### 6.4.2 health check middleware

```c#
public class HealthCheckMiddleware
{
    private readonly RequestDelegate _next;
    private readonly HealthCheckOptions _healthCheckOptions;
    private readonly HealthCheckService _healthCheckService;
        
    public HealthCheckMiddleware(
        RequestDelegate next,
        IOptions<HealthCheckOptions> healthCheckOptions,
        HealthCheckService healthCheckService)
    {
        if (next == null)
        {
            throw new ArgumentNullException(nameof(next));
        }        
        if (healthCheckOptions == null)
        {
            throw new ArgumentNullException(nameof(healthCheckOptions));
        }        
        if (healthCheckService == null)
        {
            throw new ArgumentNullException(nameof(healthCheckService));
        }
        
        _next = next;
        _healthCheckOptions = healthCheckOptions.Value;
        // 从 di 注入 health check service
        _healthCheckService = healthCheckService;
    }
        
    public async Task InvokeAsync(HttpContext httpContext)
    {
        if (httpContext == null)
        {
            throw new ArgumentNullException(nameof(httpContext));
        }
        
        // 调用 health check service 的 check health 方法（传入 predicate 过滤 registration）
        var result = await _healthCheckService.CheckHealthAsync(_healthCheckOptions.Predicate, httpContext.RequestAborted);
        
        // 如果 health check result 的 status 在 result status code 字典中没有记录，-> 抛出异常
        if (!_healthCheckOptions.ResultStatusCodes.TryGetValue(result.Status, out var statusCode))
        {
            var message =
                $"No status code mapping found for {nameof(HealthStatus)} value: {result.Status}." +
                $"{nameof(HealthCheckOptions)}.{nameof(HealthCheckOptions.ResultStatusCodes)} must contain" +
                $"an entry for {result.Status}.";
            
            throw new InvalidOperationException(message);
        }        
        // 根据 result status code 字典记录，设置 http response 的 status code
        httpContext.Response.StatusCode = statusCode;
        
        // 如果没有标记 allow caching，
        if (!_healthCheckOptions.AllowCachingResponses)
        {            
            var headers = httpContext.Response.Headers;
            headers[HeaderNames.CacheControl] = "no-store, no-cache";
            headers[HeaderNames.Pragma] = "no-cache";
            headers[HeaderNames.Expires] = "Thu, 01 Jan 1970 00:00:00 GMT";
        }
        
        // 如果 options 中 response writer 不为 null，-> write response
        if (_healthCheckOptions.ResponseWriter != null)
        {
            await _healthCheckOptions.ResponseWriter(httpContext, result);
        }
    }
}

```

##### 6.4.3 map health check

```c#
public static class HealthCheckEndpointRouteBuilderExtensions
{
    private const string DefaultDisplayName = "Health checks";
    
    // 
    public static IEndpointConventionBuilder MapHealthChecks(
        this IEndpointRouteBuilder endpoints,
        string pattern)
    {
        if (endpoints == null)
        {
            throw new ArgumentNullException(nameof(endpoints));
        }
        
        return MapHealthChecksCore(endpoints, pattern, null);
    }
    
    //
    public static IEndpointConventionBuilder MapHealthChecks(
        this IEndpointRouteBuilder endpoints,
        string pattern,
        HealthCheckOptions options)
    {
        if (endpoints == null)
        {
            throw new ArgumentNullException(nameof(endpoints));
        }        
        if (options == null)
        {
            throw new ArgumentNullException(nameof(options));
        }
        
        return MapHealthChecksCore(endpoints, pattern, options);
    }
    
    // 真正的 map 方法
    private static IEndpointConventionBuilder MapHealthChecksCore(
        IEndpointRouteBuilder endpoints, 
        string pattern, 
        HealthCheckOptions? options)
    {
        if (endpoints.ServiceProvider.GetService(typeof(HealthCheckService)) == null)
        {
            throw new InvalidOperationException(Resources.FormatUnableToFindServices(
                nameof(IServiceCollection),
                nameof(HealthCheckServiceCollectionExtensions.AddHealthChecks),
                "ConfigureServices(...)"));
        }
        
        var args = options != null ? new[] { Options.Create(options) } : Array.Empty<object>();
        
        // 克隆 application builder，注入 health check middleware
        var pipeline = endpoints.CreateApplicationBuilder()
            .UseMiddleware<HealthCheckMiddleware>(args)
            .Build();
        // map app builder       
        return endpoints.Map(pattern, pipeline).WithDisplayName(DefaultDisplayName);
    }
}

```

